<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en-GB"><generator uri="https://jekyllrb.com/" version="3.9.0">Jekyll</generator><link href="/assets/Portada1.png/feed.xml" rel="self" type="application/atom+xml" /><link href="/assets/Portada1.png/" rel="alternate" type="text/html" hreflang="en-GB" /><updated>2020-11-19T11:30:07+00:00</updated><id>/assets/Portada1.png/feed.xml</id><title type="html">Alejandro MG</title><subtitle>Administrador de Sistemas Informáticos en Red.</subtitle><author><name>DavidDarnes</name></author><entry><title type="html">Métricas, logs y monitorización con Netdata</title><link href="/assets/Portada1.png/sistemas/2020/02/11/Metricas_logs_y_monitorizacion_Netdata/" rel="alternate" type="text/html" title="Métricas, logs y monitorización con Netdata" /><published>2020-02-11T00:00:00+00:00</published><updated>2020-02-11T00:00:00+00:00</updated><id>/assets/Portada1.png/sistemas/2020/02/11/Metricas_logs_y_monitorizacion_Netdata</id><content type="html" xml:base="/assets/Portada1.png/sistemas/2020/02/11/Metricas_logs_y_monitorizacion_Netdata/">&lt;p&gt;&lt;strong&gt;Instalamos el servicio de Netdata y lo configuramos para recopilar información de nuestros servidores de métricas, logs y monitorización.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Metricas_logs_y_monitorizacion_Netdata/raw/master/image/Netdataicono.png&quot; alt=&quot;iSCSI&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Netdata es una herramienta para visualizar y monitorear métricas en tiempo real. Escrita en C, con un rendimiento muy óptimo y necesita muy pocos recurso durante su ejecucción.&lt;/p&gt;

&lt;p&gt;Consiste en un demonio que cuando se ejecuta se encarga de obtener información en tiempo real y presentarla en la web. La recoleción de información utiliza plugins internos y/o externos.&lt;/p&gt;

&lt;h2 id=&quot;instalación-netdata&quot;&gt;Instalación Netdata&lt;/h2&gt;

&lt;p&gt;Instalamos las dependencias de &lt;strong&gt;netdata&lt;/strong&gt;.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt-get install zlib1g-dev uuid-dev libuv1-dev liblz4-dev libjudy-dev libssl-dev libmnl-dev gcc make git autoconf autoconf-archive autogen automake pkg-config curl python
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Vamos a clonar de GitHub el repositorio donde se aloja la herramienta &lt;strong&gt;netdata&lt;/strong&gt;, para despues instalarla.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://github.com/netdata/netdata.git
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Nos dirigimos a la ruta del directorio que se ha clonado e instalamos &lt;strong&gt;netdata&lt;/strong&gt;.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd netdata/
sudo ./netdata-installer.sh

  ^
  |.-.   .-.   .-.   .-.   .  netdata                                        
  |   '-'   '-'   '-'   '-'   real-time performance monitoring, done right!  
  +----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+---&amp;gt;


  You are about to build and install netdata to your system.

  It will be installed at these locations:

   - the daemon     at /usr/sbin/netdata
   - config files   in /etc/netdata
   - web files      in /usr/share/netdata
   - plugins        in /usr/libexec/netdata
   - cache files    in /var/cache/netdata
   - db files       in /var/lib/netdata
   - log files      in /var/log/netdata
   - pid file       at /var/run/netdata.pid
   - logrotate file at /etc/logrotate.d/netdata

  This installer allows you to change the installation path.
  Press Control-C and run the same command with --help for help.


  NOTE:
  Anonymous usage stats will be collected and sent to Google Analytics.
  To opt-out, pass --disable-telemetry option to the installer.

Press ENTER to build and install netdata to your system &amp;gt; 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Pulsamos ENTER y comenzara la compilación y posteriormente la instalación de netdata en las rutas que se muestran arriba.&lt;/p&gt;

&lt;p&gt;Completada la instalación nos aparecerá el siguente mensaje:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; --- We are done! --- 

  ^
  |.-.   .-.   .-.   .-.   .-.   .  netdata                          .-.   .-
  |   '-'   '-'   '-'   '-'   '-'   is installed and running now!  -'   '-'  
  +----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+---&amp;gt;

  enjoy real-time performance and health monitoring...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ya tenemos &lt;strong&gt;netdata&lt;/strong&gt; instalado y el demonio esta activado y funcionando.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl list-unit-files | grep netdata
  netdata.service                        enabled
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Podemos ver el estado, y el último log nos índica que ha empezado la monitorización en tiempo real.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl status netdata.service 
  ● netdata.service - Real time performance monitoring
     Loaded: loaded (/lib/systemd/system/netdata.service; enabled; vendor preset: enabled)
     Active: active (running) since Fri 2020-01-24 10:40:10 UTC; 1 weeks 6 days ago
    Process: 8846 ExecStartPre=/bin/mkdir -p /var/cache/netdata (code=exited, status=0/SUCCESS)
    Process: 8847 ExecStartPre=/bin/chown -R netdata:netdata /var/cache/netdata (code=exited, status=0/ SUCC
    Process: 8848 ExecStartPre=/bin/mkdir -p /var/run/netdata (code=exited, status=0/SUCCESS)
    Process: 8849 ExecStartPre=/bin/chown -R netdata:netdata /var/run/netdata (code=exited, status=0/ SUCCES
   Main PID: 8850 (netdata)
      Tasks: 36 (limit: 1168)
     Memory: 186.1M
     CGroup: /system.slice/netdata.service
             ├─  312 bash /usr/libexec/netdata/plugins.d/tc-qos-helper.sh 1
             ├─ 8850 /usr/sbin/netdata -P /var/run/netdata/netdata.pid -D -W set global process   scheduling 
             ├─ 8901 /usr/bin/python /usr/libexec/netdata/plugins.d/python.d.plugin 1
             ├─ 8907 /usr/libexec/netdata/plugins.d/go.d.plugin 1
             └─32540 /usr/libexec/netdata/plugins.d/apps.plugin 1

  Jan 24 10:40:10 serranito systemd[1]: Starting Real time performance monitoring...
  Jan 24 10:40:10 serranito systemd[1]: Started Real time performance monitoring.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;configuración-del-servidor-serranito&quot;&gt;Configuración del Servidor (Serranito)&lt;/h2&gt;
&lt;p&gt;Ya tenemos funcionando &lt;strong&gt;netdata&lt;/strong&gt; en el Servidor Serranito, pero no podemos visualizar la monitorización ni las métricas, ya que no tenemos un servidor web para mostrar la herramienta.&lt;/p&gt;

&lt;p&gt;Vamos a instalar apache:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt-get install apache2-bin
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Activamos los módulos &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;proxy&lt;/code&gt; y &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;proxy_http&lt;/code&gt;, necesarios ya que el puerto de &lt;strong&gt;netdata&lt;/strong&gt; es el 19999.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo a2enmod proxy
sudo a2enmod proxy_http
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Activamos también el módulo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rewrite&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo a2enmod rewrite
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Creamos el virtualhost de apache, para la aplicación web de &lt;strong&gt;netdata&lt;/strong&gt;.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;nano /etc/apache2/sites-available/netdata.conf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;netdata.conf&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;VirtualHost *:80&amp;gt;
    RewriteEngine On
    ProxyRequests Off
    ProxyPreserveHost On

    ServerName netdata.amorales.gonzalonazareno.org

    &amp;lt;Proxy *&amp;gt;
        Require all granted
    &amp;lt;/Proxy&amp;gt;

    ProxyPass &quot;/&quot; &quot;http://localhost:19999/&quot; connectiontimeout=5 timeout=30 keepalive=on
    ProxyPassReverse &quot;/&quot; &quot;http://localhost:19999/&quot;

    ErrorLog ${APACHE_LOG_DIR}/netdata-error.log
    CustomLog ${APACHE_LOG_DIR}/netdata-access.log combined
&amp;lt;/VirtualHost&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Activamos el virtualhost creando el enlace símbolico.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;a2ensite netdata
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reiniciamos los servicios de netdata y apache2.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl restart netdata.service
systemctl restart apache2.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Añadimos DNS el registro al DNS del Servidor Croqueta.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netdata   IN   CNAME   serranito
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Comprobamos que funciona la página.
&lt;img src=&quot;https://github.com/MoralG/Metricas_logs_y_monitorizacion_Netdata/blob/master/image/Netdata.png?raw=true&quot; alt=&quot;netdata&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;configuración-de-los-clientes-croqueta-tortilla-salmorejo&quot;&gt;Configuración de los Clientes (Croqueta, Tortilla, Salmorejo)&lt;/h2&gt;

&lt;p&gt;Ahora vamos a recoger los datos, para la monitorización y las métricas, de los clientes. Para realizar esto, tenemos que configurar a los clientes como esclavos, que se realiza con un fichero de configuración.&lt;/p&gt;

&lt;p&gt;Tenemos que generar una UUID para que reconozca el servidor al cliente a través de la &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apy key&lt;/code&gt;. Con el paquete &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;uuid-runtime&lt;/code&gt; podemos generar un uuid.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt install uuid-runtime
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Generamos la uuid con el comando &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;uuidgen&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;uuidgen
  4c97ef68-ca16-41e9-b5df-d7f017d9da8e
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Creamos el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/netdata/stream.conf&lt;/code&gt; y añadimos la configuración del maestro para que pueda escuchar a los clientes.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# -----------------------------------------------------------------------------
# 1. EN LA MÁQUINA SLAVE NETDATA - SOLO PARA ENVIAR MÉTRICAS

[stream]
    enabled = no
    destination =
    api key = 
    timeout seconds = 60
    default port = 19999
    buffer size bytes = 1048576
    reconnect delay seconds = 5
    initial clock resync iterations = 60

# -----------------------------------------------------------------------------
# 2-1. EN LA MÁQUINA MASTER NETDATA - SOLO PARA RECIBIR MÉTRICAS CROQUETA

[4c97ef68-ca16-41e9-b5df-d7f017d9da8e]
    enabled = yes
    allow from = *
    default history = 3600
    default memory mode = ram
    health enabled by default = auto
    default postpone alarms on connect seconds = 60

# -----------------------------------------------------------------------------
# 2-2. EN LA MÁQUINA MASTER NETDATA - SOLO PARA RECIBIR MÉTRICAS TORTILLA

[415e58a5-b1de-41e4-8eac-d749bc572df5]
    enabled = yes
    allow from = *
    default history = 3600
    default memory mode = ram
    health enabled by default = auto
    default postpone alarms on connect seconds = 60

# -----------------------------------------------------------------------------
# 2-3. EN LA MÁQUINA MASTER NETDATA - SOLO PARA RECIBIR MÉTRICAS SALMOREJO

[7a4c6dd7-d71a-46ba-b1d5-150333707ff7]
    enabled = yes
    allow from = *
    default history = 3600
    default memory mode = ram
    health enabled by default = auto
    default postpone alarms on connect seconds = 60

# -----------------------------------------------------------------------------
# 3. PER SENDING HOST SETTINGS, ON MASTER NETDATA THIS IS OPTIONAL - YOU DON'T NEED IT

[MACHINE_GUID]
    enabled = no
    allow from = *
    history = 3600
    memory mode = save
    health enabled = yes
    postpone alarms on connect seconds = 60
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Una vez creado el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;stream.conf&lt;/code&gt; podemos reiniciar el servicio &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;netdata.service&lt;/code&gt; del servidor para que empiece a escuchar.&lt;/p&gt;

&lt;p&gt;Como podemos ver al mirar el log del maestro, esta escuchando pero nadie responde y cierra la conexión.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;tail -f /var/log/netdata/error.log
  2020-02-07 21:47:42: netdata INFO  : WEB_SERVER[static1] : POLLFD: LISTENER: client slot 5 (fd 82) from localhost port 43156 is idle for more than 60 seconds - closing it. 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Para que el maestro escuche a los clientes, estos los vamos a configurar como esclavos. Para esto vamos a instalar netdata como hicimos en el servidor. &lt;a href=&quot;https://github.com/MoralG/Metricas_logs_y_monitorizacion_Netdata/blob/master/Metricas_logs_monitorizacion.md#instalaci%C3%B3n-netdata&quot;&gt;IR ARRIBA&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Creamos el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/netdata/stream.conf&lt;/code&gt; y añadimos la configuración del esclavo en las máquinas Croqueta, Salmorejo y Tortilla.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# -----------------------------------------------------------------------------
# 1. ON SLAVE NETDATA - THE ONE THAT WILL BE SENDING METRICS

[stream]
    enabled = yes
    destination = 10.0.0.17
    api key = 4c97ef68-ca16-41e9-b5df-d7f017d9da8e
    timeout seconds = 60
    default port = 19999
    buffer size bytes = 1048576
    reconnect delay seconds = 5
    initial clock resync iterations = 60

# -----------------------------------------------------------------------------
# 2. ON MASTER NETDATA - THE ONE THAT WILL BE RECEIVING METRICS

[API_KEY]
    enabled = no
    allow from = *
    default history = 3600
    default memory mode = ram
    health enabled by default = auto
    default postpone alarms on connect seconds = 60

# -----------------------------------------------------------------------------
# 3. PER SENDING HOST SETTINGS, ON MASTER NETDATA THIS IS OPTIONAL - YOU DON'T NEED IT

[MACHINE_GUID]
    enabled = no
    allow from = *
    history = 3600
    memory mode = save
    health enabled = yes
    postpone alarms on connect seconds = 60
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Después reiniciamos el servicio &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;netdata.service&lt;/code&gt; de los esclavos y al mirar el log nos saldrá los siguiente mensajes&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl restart netdata.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Servidor&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;tail -f /var/log/netdata/error.log | egrep STREAM
  2020-02-07 21:54:23: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : STREAM croqueta   [receive from [10.0.0.6]:54704]: initializing communication...
  2020-02-07 21:54:23: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : STREAM croqueta   [receive from [10.0.0.6]:54704]: Netdata is using the newest stream protocol.
  2020-02-07 21:54:23: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : Postponing health   checks for 60 seconds, on host 'croqueta', because it was just connected.
  2020-02-07 21:54:23: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : STREAM croqueta   [receive from [10.0.0.6]:54704]: receiving metrics...
  2020-02-07 21:54:30: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : RRDSET: chart name  'net.eth0' on host 'croqueta' already exists.
  2020-02-07 21:54:47: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : RRDSET: chart name  'groups.threads' on host 'croqueta' already exists.
  2020-02-07 21:54:47: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : RRDSET: chart name  'groups.processes' on host 'croqueta' already exists.
  2020-02-07 21:54:47: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : RRDSET: chart name  'groups.uptime' on host 'croqueta' already exists.
  2020-02-07 21:54:47: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : RRDSET: chart name  'groups.uptime_min' on host 'croqueta' already exists.
  2020-02-07 21:54:47: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : RRDSET: chart name  'groups.uptime_avg' on host 'croqueta' already exists.
  2020-02-07 21:54:47: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : RRDSET: chart name  'groups.uptime_max' on host 'croqueta' already exists.
  2020-02-07 21:54:47: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : RRDSET: chart name  'groups.mem' on host 'croqueta' already exists.
  2020-02-07 21:54:47: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : RRDSET: chart name  'groups.vmem' on host 'croqueta' already exists.
  2020-02-07 21:54:47: netdata INFO  : STREAM_RECEIVER[croqueta,[10.0.0.6]:54704] : RRDSET: chart name  'groups.swap' on host 'croqueta' already exists.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Cliente&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl restart netdata.service
  2020-02-07 21:55:13: netdata INFO  : PLUGINSD[apps] : RRDSET: chart name 'groups.swap' on host  'croqueta' already exists.
  2020-02-07 21:55:13: netdata INFO  : PLUGINSD[apps] : RRDSET: chart name 'groups.major_faults' on host  'croqueta' already exists.
  2020-02-07 21:55:13: netdata INFO  : PLUGINSD[apps] : RRDSET: chart name 'groups.minor_faults' on host  'croqueta' already exists.
  2020-02-07 21:55:13: netdata INFO  : PLUGINSD[apps] : RRDSET: chart name 'groups.preads' on host  'croqueta' already exists.
  2020-02-07 21:55:13: netdata INFO  : PLUGINSD[apps] : RRDSET: chart name 'groups.pwrites' on host   'croqueta' already exists.
  2020-02-07 21:55:13: netdata INFO  : PLUGINSD[apps] : RRDSET: chart name 'groups.lreads' on host  'croqueta' already exists.
  2020-02-07 21:55:13: netdata INFO  : PLUGINSD[apps] : RRDSET: chart name 'groups.lwrites' on host   'croqueta' already exists.
  2020-02-07 21:55:13: netdata INFO  : PLUGINSD[apps] : RRDSET: chart name 'groups.files' on host   'croqueta' already exists.
  2020-02-07 21:55:13: netdata INFO  : PLUGINSD[apps] : RRDSET: chart name 'groups.sockets' on host   'croqueta' already exists.
  2020-02-07 21:55:13: netdata INFO  : PLUGINSD[apps] : RRDSET: chart name 'groups.pipes' on host   'croqueta' already exists.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Comprobamos en la aplicación que nos aparece los clientes de Croqueta, Tortilla y Salmorejo.
&lt;img src=&quot;https://github.com/MoralG/Metricas_logs_y_monitorizacion_Netdata/blob/master/image/Netdata1.png?raw=true&quot; alt=&quot;Netdata&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Ya tenemos todos los datos de los clientes, agrupados en el servidor y nos lo muestra en nuestra servicio web, pero nos muestra una gran cantidad de métricas que son innecesarias para la funcionalidad que nosotros queremos.&lt;/p&gt;

&lt;p&gt;Ahora vamos quitar toda esas métricas sobrantes que nosotros no necesitamos y dejar las más importantes para nosotros, para realizar esto vamos a modificar el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/netdata/netdata.conf&lt;/code&gt;. En este fichero tenenmos todos los campos del Dashboard, los cuales podemos deshabilitar con la opción &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;enable = no&lt;/code&gt;, como se muestra en el ejemplo del apartado de las variables de entropia:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[system.entropy]
        history = 5
        enabled = no
        # cache directory = /var/cache/netdata/system.entropy
        # chart type = line
        # type = system
        # family = entropy
        # units = entropy
        # context = system.entropy
        # priority = 1000
        # name = system.entropy
        # title = Available Entropy
        # dim entropy name = entropy
        # dim entropy algorithm = absolute
        # dim entropy multiplier = 1
        # dim entropy divisor = 1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Deshabilitado, ya no se mostrará en la web.&lt;/p&gt;

&lt;p&gt;Además de dejar el Dashboard funcional para nosotros, podemos configurar las notificaciones. Estas notificaciones de las que estoy hablando, son las encargada de avisarte con una alerta si algun valor de los que esta midiendo sobrepasa el límite indicado.&lt;/p&gt;

&lt;p&gt;Para modificar las notificaciones tenemos que utilizar el script &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/netdata/edit-config&lt;/code&gt; e indicarle el fichero donde este la configuración de la notificación que queramos modificar. Por ejemplo en nuestro caso vamos a modificar la notificación de la CPU.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo ./edit-config health.d/cpu.conf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Vamos a modificar la alerta del WARNING para que salte cuando la CPU llegue al 65%.&lt;/p&gt;

&lt;p&gt;Además, si nos fijamos en el usuario asignado para esta notificación, en el apartado &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;to&lt;/code&gt; podemos 
asignar el usuario &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;silent&lt;/code&gt; y no nos avisará de las alertas.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;template: 10min_cpu_usage
      on: system.cpu
      os: linux
   hosts: *
  lookup: average -10m unaligned of user,system,softirq,irq,guest
   units: %
   every: 1m
    warn: $this &amp;gt; (($status &amp;gt;= $WARNING)  ? (65) : (85))
    crit: $this &amp;gt; (($status == $CRITICAL) ? (85) : (95))
   delay: down 15m multiplier 1.5 max 1h
    info: average cpu utilization for the last 10 minutes (excluding iowait, nice and steal)
      to: sysadmin
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;NOTA&lt;/strong&gt;: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sysadmin&lt;/code&gt; puede mandar la alerta a discord o slack, esto lo explicaremos más abajo&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Guardamos la configuración y ya nos saldrá configurado en nuestra web.
&lt;img src=&quot;https://github.com/MoralG/Metricas_logs_y_monitorizacion_Netdata/blob/master/image/Netdata4.png?raw=true&quot; alt=&quot;Netdata&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Para probar lo de las notificaciones vamos a estresar nuestra máquina. Vamos a instalar el paquete de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;stress&lt;/code&gt; y esperaremos a que la utilización de la CPU aumente hasta el 60%.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt install stress
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Estresamos la máquina&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;stress --cpu 8 --io 4 --vm 2 --vm-bytes 128M --timeout 200s
  stress: info: [685] dispatching hogs: 8 cpu, 4 io, 2 vm, 0 hdd
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Como podemos ver, la CPU esta al 100%:
&lt;img src=&quot;https://github.com/MoralG/Metricas_logs_y_monitorizacion_Netdata/blob/master/image/Netdata5.png?raw=true&quot; alt=&quot;Netdata&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Y tenemos las notificaciones que nos avisan:
&lt;img src=&quot;https://github.com/MoralG/Metricas_logs_y_monitorizacion_Netdata/blob/master/image/Netdata6.png?raw=true&quot; alt=&quot;Netdata&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Esto esta muy bien, pero en el caso de no estar atento a la web, tenemos que buscar un metodo para que nos notifiquen, por eso vamos a configurar netdata para que nos envien las alertas a discord y slack.&lt;/p&gt;

&lt;h3 id=&quot;discord&quot;&gt;Discord&lt;/h3&gt;

&lt;p&gt;Para configurar las notificaciones en discord tenemos que crear un servidor en discord y avtivar la opción de &lt;strong&gt;Webhook&lt;/strong&gt;
&lt;img src=&quot;https://github.com/MoralG/Metricas_logs_y_monitorizacion_Netdata/blob/master/image/Netdata2.png?raw=true&quot; alt=&quot;Netdata&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Nos dará un enlace, el cual añadiremos a la configuración de netdata en el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;health_alarm_notify.conf&lt;/code&gt; con el script &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;edit-config&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo ./edit-config health_alarm_notify.conf
  # discord (discordapp.com) global notification options

  # multiple recipients can be given like this:
  #                  &quot;CHANNEL1 CHANNEL2 ...&quot;

  # enable/disable sending discord notifications
  SEND_DISCORD=&quot;YES&quot;

  # Create a webhook by following the official documentation -
  # https://support.discordapp.com/hc/en-us/articles/228383668-Intro-to-Webhooks
  DISCORD_WEBHOOK_URL=&quot;https://discordapp.com/api/webhooks/676357546080206848/  ePWMIzAJd-YsjyacjHc01xun_SV6E

  # if a role's recipients are not configured, a notification will be send to
  # this discord channel (empty = do not send a notification for unconfigured
  # roles):
  DEFAULT_RECIPIENT_DISCORD=&quot;alarms&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Como podemos ver, en &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DISCORD_WEBHOOK_URL&lt;/code&gt; añadiremos la url proporcionada al activar &lt;strong&gt;Webhook&lt;/strong&gt; y en &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DEFAULT_RECIPIENT_DISCORD&lt;/code&gt; le indicamos &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;alarms&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Le realizamos el mismo comando de antes para estresarlo y nos avisará.
&lt;img src=&quot;https://github.com/MoralG/Metricas_logs_y_monitorizacion_Netdata/blob/master/image/Netdata8.png?raw=true&quot; alt=&quot;Netdata&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;slack&quot;&gt;Slack&lt;/h3&gt;

&lt;p&gt;Vamos a configurar como en el caso de discord, el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;health_alarm_notify.conf&lt;/code&gt; con el script &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;edit-config&lt;/code&gt;. Y añadimos a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SLACK_WEBHOOK_URL&lt;/code&gt; el enlace que nos da &lt;strong&gt;Webhook&lt;/strong&gt; al crearlo en nuestro servidor.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Metricas_logs_y_monitorizacion_Netdata/blob/master/image/Netdata7.png?raw=true&quot; alt=&quot;Netdata&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Además le indicamos en &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DEFAULT_RECIPIENT_SLACK&lt;/code&gt; que sea &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#&lt;/code&gt; para que reconozca el canal que le hemos indicado en el &lt;strong&gt;Webhook&lt;/strong&gt;.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo ./edit-config health_alarm_notify.conf
  # slack (slack.com) global notification options

  # multiple recipients can be given like this:
  #                  &quot;RECIPIENT1 RECIPIENT2 ...&quot;

  # enable/disable sending slack notifications
  SEND_SLACK=&quot;YES&quot;

  # Login to your slack.com workspace and create an incoming webhook, using the &quot;Incoming Webhooks&quot; App:  ht
  # Do not use the instructions in https://api.slack.com/incoming-webhooks#enable_webhooks, as those  webhoo
  # You need only one for all your netdata servers (or you can have one for each of your netdata).
  # Without the app and a webhook, netdata cannot send slack notifications.
  SLACK_WEBHOOK_URL=&quot;https://hooks.slack.com/services/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&quot;

  # if a role's recipients are not configured, a notification will be send
  # to:# - A slack channel (syntax: '#channel' or 'channel')
  # - A slack user (syntax: '@user')
  # - The channel or user defined in slack for the webhook (syntax: '#')
  # empty = do not send a notification for unconfigured roles
  DEFAULT_RECIPIENT_SLACK=&quot;#&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Nos conectamos al usuario netdata&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo su -s /bin/bash netdata
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Probamos que funciona con un test que se ejecuta con el siguiente script:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/usr/libexec/netdata/plugins.d/alarm-notify.sh test

  # SENDING TEST WARNING ALARM TO ROLE: sysadmin
  /etc/netdata/health_alarm_notify.conf: line 435: Colors: command not found
  2020-02-10 18:30:02: alarm-notify.sh: INFO: sent slack notification for: serranito test.chart.  test_alarm is WARNING without specifying a channel
  2020-02-10 18:30:02: alarm-notify.sh: INFO: sent discord notification for: serranito test.chart.  test_alarm is WARNING to 'alarms'
  2020-02-10 18:30:03: alarm-notify.sh: INFO: sent email notification for: serranito test.chart.  test_alarm is WARNING to 'root'
  # OK

  # SENDING TEST CRITICAL ALARM TO ROLE: sysadmin
  /etc/netdata/health_alarm_notify.conf: line 435: Colors: command not found
  2020-02-10 18:30:03: alarm-notify.sh: INFO: sent slack notification for: serranito test.chart.  test_alarm is CRITICAL without specifying a channel
  2020-02-10 18:30:03: alarm-notify.sh: INFO: sent discord notification for: serranito test.chart.  test_alarm is CRITICAL to 'alarms'
  2020-02-10 18:30:03: alarm-notify.sh: INFO: sent email notification for: serranito test.chart.  test_alarm is CRITICAL to 'root'
  # OK

  # SENDING TEST CLEAR ALARM TO ROLE: sysadmin
  /etc/netdata/health_alarm_notify.conf: line 435: Colors: command not found
  2020-02-10 18:30:04: alarm-notify.sh: INFO: sent slack notification for: serranito test.chart.  test_alarm is CLEAR without specifying a channel
  2020-02-10 18:30:04: alarm-notify.sh: INFO: sent discord notification for: serranito test.chart.  test_alarm is CLEAR to 'alarms'
  2020-02-10 18:30:04: alarm-notify.sh: INFO: sent email notification for: serranito test.chart.  test_alarm is CLEAR to 'root'
  # OK
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Como podemos ver, nos llega las alertas del test.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Metricas_logs_y_monitorizacion_Netdata/blob/master/image/Netdata9.png?raw=true&quot; alt=&quot;Netdata&quot; /&gt;&lt;/p&gt;</content><author><name>DavidDarnes</name></author><category term="Sistemas" /><summary type="html">Instalamos el servicio de Netdata y lo configuramos para recopilar información de nuestros servidores de métricas, logs y monitorización.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/Portada1.png/assets/default-social-image.png" /><media:content medium="image" url="/assets/Portada1.png/assets/default-social-image.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">VPN con OpenVPN y certificados x509</title><link href="/assets/Portada1.png/seguridad/2020/02/11/VPN_con_OpenVPN_y_Certificadosx509/" rel="alternate" type="text/html" title="VPN con OpenVPN y certificados x509" /><published>2020-02-11T00:00:00+00:00</published><updated>2020-02-11T00:00:00+00:00</updated><id>/assets/Portada1.png/seguridad/2020/02/11/VPN_con_OpenVPN_y_Certificadosx509</id><content type="html" xml:base="/assets/Portada1.png/seguridad/2020/02/11/VPN_con_OpenVPN_y_Certificadosx509/">&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/VPN_con_OpenVPN_y_Certificadosx509/blob/master/image/OpenVPN.jpg?raw=true&quot; alt=&quot;iSCSI&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Vamos a establecer una VPN de acceso remoto y a establecer una VPN de sitio a sitio, (Autenticación será con TLS utilizando certificados X.509 y la asignación de direcciones dinámica).&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;vpn-de-acceso-remoto-con-openvpn-y-certificados-x509&quot;&gt;VPN de acceso remoto con OpenVPN y certificados x509&lt;/h2&gt;

&lt;h4 id=&quot;configura-una-conexión-vpn-de-acceso-remoto-entre-dos-equipos&quot;&gt;Configura una conexión VPN de acceso remoto entre dos equipos:&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;Uno de los dos equipos (el que actuará como servidor) estará conectado a dos redes.&lt;/li&gt;
  &lt;li&gt;Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio /etc/openvpn, junto con los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.&lt;/li&gt;
  &lt;li&gt;Se utilizarán direcciones de la red 10.99.99.0/24 para las direcciones virtuales de la VPN. La dirección 10.99.99.1 se asignará al servidor VPN.&lt;/li&gt;
  &lt;li&gt;Los ficheros de configuración del servidor y del cliente se crearán en el directorio /etc/openvpn de cada máquina, y se llamarán servidor.conf y cliente.conf respectivamente. La configuración establecida debe cumplir los siguientes aspectos:
    &lt;ul&gt;
      &lt;li&gt;El demonio openvpn se manejará con systemctl.&lt;/li&gt;
      &lt;li&gt;Se debe configurar para que la comunicación esté comprimida.&lt;/li&gt;
      &lt;li&gt;La asignación de direcciones IP será dinámica.&lt;/li&gt;
      &lt;li&gt;Existirá un fichero de log en el equipo.&lt;/li&gt;
      &lt;li&gt;Se mandarán a los clientes las rutas necesarias.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;h2 id=&quot;tras-el-establecimiento-de-la-vpn-la-máquina-cliente-debe-ser-capaz-de-acceder-a-una-máquina-que-esté-en-la-otra-red-a-la-que-está-conectado-el-servidor&quot;&gt;Tras el establecimiento de la VPN, la máquina cliente debe ser capaz de acceder a una máquina que esté en la otra red a la que está conectado el servidor.&lt;/h2&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;configuración-vagrant-cliente&quot;&gt;Configuración Vagrant Cliente&lt;/h4&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Vagrant.configure(&quot;2&quot;) do |config|

  config.vm.define :cliente1 do |cliente1|
    cliente1.vm.box = &quot;debian/buster64&quot;
    cliente1.vm.hostname = &quot;Cliente1&quot;
    cliente1.vm.network :public_network,:bridge=&amp;gt;&quot;enp3s0&quot;
  end
end
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;configuración-vagrant-servidor&quot;&gt;Configuración Vagrant Servidor&lt;/h4&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Vagrant.configure(&quot;2&quot;) do |config|

  config.vm.define :servidor2 do |servidor2|
    servidor2.vm.box = &quot;debian/buster64&quot;
    servidor2.vm.hostname = &quot;Servidor2&quot;
    servidor2.vm.network :public_network,:bridge=&amp;gt;&quot;enp3s0&quot;
    servidor2.vm.network :private_network, ip: &quot;192.168.100.1&quot;, virtualbox__intnet:&quot;mired1&quot;
  end
  config.vm.define :cliente2 do |cliente2|
    cliente2.vm.box = &quot;debian/buster64&quot;
    cliente2.vm.hostname = &quot;Cliente2&quot;
    cliente2.vm.network :private_network, ip: &quot;192.168.100.2&quot;, virtualbox__intnet:&quot;mired1&quot;
  end
end
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;NOTA&lt;/strong&gt;: Para esta tarea vamos a necesitar crear una Autoridad Certificadora y certificados firmados, &lt;a href=&quot;https://github.com/MoralG/Certificados_Digitales_y_HTTPS/blob/master/HTTPS_SSL.md#tarea-1-certificado-autofirmado&quot;&gt;CLIC AQUÍ&lt;/a&gt; para saber más.&lt;/p&gt;

  &lt;h3 id=&quot;cliente1&quot;&gt;Cliente1&lt;/h3&gt;
&lt;/blockquote&gt;

&lt;p&gt;Instalamos el paquete &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;openvpn&lt;/code&gt; para realizar la conexión a la vpn del servidor.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt install openvpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;creamos-los-datos-iguales-que-la-autoridad-certificadora&quot;&gt;Creamos los datos iguales que la autoridad certificadora&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Country Name (2 letter code) [AU]:ES
State or Province Name (full name) [Some-State]:Sevilla
Locality Name (eg, city) []:Dos Hermanas
Organization Name (eg, company) [Internet Widgits Pty Ltd]:IES Gonzalo Nazareno
Organizational Unit Name (eg, section) []:Paloma 
Common Name (e.g. server FQDN or YOUR name) []:Alejandro Morales Gracia
Email Address []:ale95mogra@gmail.com	
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Pasamos el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;VPN_Alejandro.csr&lt;/code&gt; a la Autoridad Certificadora y esperamos a que nos devuelva el certificado firmado y el certificado de CA.&lt;/p&gt;

&lt;p&gt;Ademas vamos a mover los certificados y la clave privada a la ruta &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/openvpn/client&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;servidor2&quot;&gt;Servidor2&lt;/h3&gt;

&lt;p&gt;Instalamos el paquete &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;openvpn&lt;/code&gt; para poder realizar la tarea.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt install openvpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Creamos la clave Diffie-Hellman con el parámetro &lt;strong&gt;dhparam&lt;/strong&gt;:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd /etc/openvpn
sudo openssl dhparam -out dhparams.pem 4096
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Activamos el bit de forward para permitir el tráfico a través de el:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;echo 1 &amp;gt; /proc/sys/net/ipv4/ip_forward
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Se edita el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/openvpn/servidor.conf&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dev tun
server 10.99.99.0 255.255.255.0 
push &quot;route 192.168.100.0 255.255.255.0&quot;
tls-server
dh /etc/openvpn/dhparams.pem
ca /etc/openvpn/ca.cert.pem
cert /etc/openvpn/serverVPN.crt 
key /etc/openvpn/serverVPN.key
comp-lzo
keepalive 10 60
verb 3
askpass pass.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Vamos a firmar el certificado del cliente y se lo pasaremos para que pueda configurar su máquina.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;openssl x509 -req -in VPN_Alejandro.csr -CA /root/ca/certs/ca.cert.pem -CAkey /root/ca/private/ca.key.pem -CAcreateserial -out VPN_Alejandro.crt
   Signature ok
   subject=C = ES, ST = Sevilla, L = Dos Hermanas, O = IES Gonzalo Nazareno, CN = Alejandro Morales Gracia
   Getting CA Private Key
   Enter pass phrase for /root/ca/private/ca.key.pem:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Creamos un fichero llamado pass.txt y metemos una contraseña para que lo reconozca el parametro &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;askpass&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo touch pass.txt
echo &quot;prueba&quot; &amp;gt; pass.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Configuramos openvpn, reconozca systemd, los ficheros de configuración. Esto se hace descomentando, la siguiente linea, en el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/default/openvpn&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;AUTOSTART=&quot;all&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reiniciamos el servicio &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;openvpn.service&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl restart openvpn.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;cliente2&quot;&gt;Cliente2&lt;/h3&gt;

&lt;p&gt;Eliminamos la tabla de enrrutmiento por defecto y le asignamos la dirección del Servidor2.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo ip r del default
sudo ip r add default via 192.168.100.20
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;cliente1-1&quot;&gt;Cliente1&lt;/h3&gt;

&lt;p&gt;Una vez que tenemos los dos certificados, tenemos que hacer el fichero de configuración del cliente &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/openvpn/VPN.conf&lt;/code&gt;, donde vamos a indicar la interfaz &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tun&lt;/code&gt;, la dirección a la que se tiene que conectar y los certificados.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dev tun
remote 172.22.0.56
ifconfig 10.99.99.0 255.255.255.0
pull
tls-client
ca /etc/openvpn/client/ca.cert.pem
cert /etc/openvpn/client/VPN_Alejandro.crt
key /etc/openvpn/client/VPN_Alejandro.key
comp-lzo
keepalive 10 60
verb 3
askpass pass.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Creamos en un fichero llamado pass.txt y metemos una contraseña.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo touch pass.txt
echo &quot;prueba&quot; &amp;gt; pass.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Configuramos para que reconozca systemd los ficheros de configuración. Esto se hacer descomentando la siguiente linea en el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/default/openvpn&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;AUTOSTART=&quot;all&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reiniciamos el servicio &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;openvpn.service&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl restart openvpn.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;comprobamos-que-se-ha-añadido-el-tun&quot;&gt;Comprobamos que se ha añadido el &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tun&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ip a
    1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
        inet 127.0.0.1/8 scope host lo
           valid_lft forever preferred_lft forever
        inet6 ::1/128 scope host 
           valid_lft forever preferred_lft forever
    2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
        link/ether 08:00:27:8d:c0:4d brd ff:ff:ff:ff:ff:ff
        inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic eth0
           valid_lft 85611sec preferred_lft 85611sec
        inet6 fe80::a00:27ff:fe8d:c04d/64 scope link 
           valid_lft forever preferred_lft forever
    3: eth1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
        link/ether 08:00:27:b8:70:44 brd ff:ff:ff:ff:ff:ff
        inet 172.22.0.163/16 brd 172.22.255.255 scope global dynamic eth1
           valid_lft 1029sec preferred_lft 1029sec
        inet6 fe80::a00:27ff:feb8:7044/64 scope link 
           valid_lft forever preferred_lft forever
    4: tun0: &amp;lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UNKNOWN group    default qlen 100
        link/none 
        inet 10.99.99.6 peer 10.99.99.5/32 scope global tun0
           valid_lft forever preferred_lft forever
        inet6 fe80::9e0e:4d6c:ad95:ab79/64 scope link stable-privacy 
           valid_lft forever preferred_lft forever

ip r
    default via 10.0.2.2 dev eth0 
    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 
    10.99.99.1 via 10.99.99.5 dev tun0 
    10.99.99.5 dev tun0 proto kernel scope link src 10.99.99.6 
    172.22.0.0/16 dev eth1 proto kernel scope link src 172.22.2.117 
    192.168.100.0/24 via 10.99.99.5 dev tun0 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Realizamos un ping a la dirección &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;192.168.100.2&lt;/code&gt; que es el cliente que tiene el servidor.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ping 192.168.100.2
    PING 192.168.100.2 (192.168.100.2) 56(84) bytes of data.
    64 bytes from 192.168.100.2: icmp_seq=1 ttl=64 time=1.28 ms
    64 bytes from 192.168.100.2: icmp_seq=2 ttl=64 time=1.43 ms
    64 bytes from 192.168.100.2: icmp_seq=3 ttl=64 time=1.34 ms
    64 bytes from 192.168.100.2: icmp_seq=4 ttl=64 time=0.970 ms
    64 bytes from 192.168.100.2: icmp_seq=5 ttl=64 time=1.39 ms
    ^C
    --- 192.168.100.2 ping statistics ---
    5 packets transmitted, 5 received, 0% packet loss, time 12ms
    rtt min/avg/max/mdev = 0.970/1.280/1.425/0.166 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;vpn-sitio-a-sitio-con-openvpn-y-certificados-x509&quot;&gt;VPN sitio a sitio con OpenVPN y certificados x509&lt;/h2&gt;

&lt;h4 id=&quot;configura-una-conexión-vpn-sitio-a-sitio-entre-dos-equipos-del-cloud&quot;&gt;Configura una conexión VPN sitio a sitio entre dos equipos del cloud:&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;Cada equipo estará conectado a dos redes, una de ellas en común&lt;/li&gt;
  &lt;li&gt;Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio /etc/openvpn, junto con con los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.&lt;/li&gt;
  &lt;li&gt;Se utilizarán direcciones de la red 10.99.99.0/24 para las direcciones virtuales de la VPN.&lt;/li&gt;
  &lt;li&gt;Tras el establecimiento de la VPN, una máquina de cada red detrás de cada servidor VPN debe ser capaz de acceder a una máquina del otro extremo.&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;configuración-vagrant-servidorcliente&quot;&gt;Configuración Vagrant Servidor/Cliente&lt;/h4&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Vagrant.configure(&quot;2&quot;) do |config|

  config.vm.define :servidor1 do |servidor1|
    servidor1.vm.box = &quot;debian/buster64&quot;
    servidor1.vm.hostname = &quot;Servidor/Cliente1&quot;
    servidor1.vm.network :public_network,:bridge=&amp;gt;&quot;enp3s0&quot;
    servidor1.vm.network :private_network, ip: &quot;192.168.200.1&quot;, virtualbox__intnet:&quot;mired1&quot;
  end
  config.vm.define :cliente1 do |cliente1|
    cliente1.vm.box = &quot;debian/buster64&quot;
    cliente1.vm.hostname = &quot;Cliente1&quot;
    cliente1.vm.network :private_network, ip: &quot;192.168.200.2&quot;, virtualbox__intnet:&quot;mired1&quot;
  end
end
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;configuración-vagrant-servidor-1&quot;&gt;Configuración Vagrant Servidor&lt;/h4&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Vagrant.configure(&quot;2&quot;) do |config|

  config.vm.define :servidor2 do |servidor2|
    servidor2.vm.box = &quot;debian/buster64&quot;
    servidor2.vm.hostname = &quot;Servidor2&quot;
    servidor2.vm.network :public_network,:bridge=&amp;gt;&quot;enp3s0&quot;
    servidor2.vm.network :private_network, ip: &quot;192.168.100.20&quot;, virtualbox__intnet:&quot;mired1&quot;
  end
  config.vm.define :cliente2 do |cliente2|
    cliente2.vm.box = &quot;debian/buster64&quot;
    cliente2.vm.hostname = &quot;Cliente2&quot;
    cliente2.vm.network :private_network, ip: &quot;192.168.100.50&quot;, virtualbox__intnet:&quot;mired1&quot;
  end
end
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;NOTA&lt;/strong&gt;: Utilizaremos las mismas claves que en la anterior tarea.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;servidor2-1&quot;&gt;Servidor2&lt;/h3&gt;

&lt;p&gt;La configuración para hacer una &lt;strong&gt;VPN Site to Site&lt;/strong&gt; es igual que en la anterior tarea, pero el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;servidor.conf&lt;/code&gt; cambia un poco.&lt;/p&gt;

&lt;p&gt;Modificamos fichero de configuración del servidor &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;servidor.conf&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dev tun
ifconfig 10.99.99.1 10.99.99.2
route 192.168.200.0 255.255.255.0
tls-server
dh /etc/openvpn/dhparams.pem
ca /etc/openvpn/ca.cert.pem
cert /etc/openvpn/serverVPN.crt
key /etc/openvpn/serverVPN.key
comp-lzo
keepalive 10 60
log /var/log/server.log
verb 6
askpass pass.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Comprobamos que el tunel se ha creado correctamente.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ip a
    1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
        inet 127.0.0.1/8 scope host lo
           valid_lft forever preferred_lft forever
        inet6 ::1/128 scope host 
           valid_lft forever preferred_lft forever
    2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
        link/ether 08:00:27:8d:c0:4d brd ff:ff:ff:ff:ff:ff
        inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic eth0
           valid_lft 80741sec preferred_lft 80741sec
        inet6 fe80::a00:27ff:fe8d:c04d/64 scope link 
           valid_lft forever preferred_lft forever
    3: eth1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
        link/ether 08:00:27:90:f5:5a brd ff:ff:ff:ff:ff:ff
        inet 172.22.9.60/16 brd 172.22.255.255 scope global dynamic eth1
           valid_lft 9168sec preferred_lft 9168sec
        inet6 fe80::a00:27ff:fe90:f55a/64 scope link 
           valid_lft forever preferred_lft forever
    4: eth2: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
        link/ether 08:00:27:4c:eb:52 brd ff:ff:ff:ff:ff:ff
        inet 192.168.100.20/24 brd 192.168.100.255 scope global eth2
           valid_lft forever preferred_lft forever
        inet6 fe80::a00:27ff:fe4c:eb52/64 scope link 
           valid_lft forever preferred_lft forever
    31: tun0: &amp;lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UNKNOWN group   default qlen 100
        link/none 
        inet 10.99.99.1 peer 10.99.99.2/32 scope global tun0
           valid_lft forever preferred_lft forever
        inet6 fe80::dd5:e8c6:5fd1:f19c/64 scope link stable-privacy 
           valid_lft forever preferred_lft forever
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;servidorcliente1&quot;&gt;Servidor/Cliente1&lt;/h3&gt;

&lt;p&gt;Antes de configurar el cliente, el servidor tiene que haberle pasado al cliente los fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;VPN_Alejandro.key&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;VPN_Alejandro.crt&lt;/code&gt; y &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ca.cert.pem&lt;/code&gt; como en la anterior práctica.&lt;/p&gt;

&lt;p&gt;Ahora podemos crear el fichero de configuración del cliente &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cliente.conf&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dev tun
ifconfig 10.99.99.2 10.99.99.1
remote 172.22.0.56
route 192.168.100.0 255.255.255.0
tls-client
ca /etc/openvpn/client/ca.cert.pem
cert /etc/openvpn/client/VPN_Alejandro.crt
key /etc/openvpn/client/VPN_Alejandro.key
comp-lzo
keepalive 10 60
log /var/log/host.log
verb 6
askpass pass.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Se activa el bit de forward para dejar pasar el tráfico al Cliente1:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@servidor:/home/vagrant# echo 1 &amp;gt; /proc/sys/net/ipv4/ip_forward
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reiniciamos el servicio&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl restart openvpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Comprobamos que el tunel se ha creado correctamente y tenemos el nuevo registro de enrrutamiento.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ip a
    1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
        inet 127.0.0.1/8 scope host lo
           valid_lft forever preferred_lft forever
        inet6 ::1/128 scope host 
           valid_lft forever preferred_lft forever
    2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
        link/ether 08:00:27:8d:c0:4d brd ff:ff:ff:ff:ff:ff
        inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic eth0
           valid_lft 84637sec preferred_lft 84637sec
        inet6 fe80::a00:27ff:fe8d:c04d/64 scope link 
           valid_lft forever preferred_lft forever
    3: eth1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
        link/ether 08:00:27:b8:70:44 brd ff:ff:ff:ff:ff:ff
        inet 172.22.2.123/16 brd 172.22.255.255 scope global dynamic eth1
           valid_lft 8996sec preferred_lft 8996sec
        inet6 fe80::a00:27ff:feb8:7044/64 scope link 
           valid_lft forever preferred_lft forever
    4: eth2: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
        link/ether 08:00:27:7c:e2:d3 brd ff:ff:ff:ff:ff:ff
        inet 192.168.200.1/24 brd 192.168.200.255 scope global eth2
           valid_lft forever preferred_lft forever
        inet6 fe80::a00:27ff:fe7c:e2d3/64 scope link 
           valid_lft forever preferred_lft forever
    21: tun0: &amp;lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 100
        link/none 
        inet 10.99.99.2 peer 10.99.99.1/32 scope global tun0
           valid_lft forever preferred_lft forever
        inet6 fe80::83d:90fb:c65e:93d6/64 scope link stable-privacy 
           valid_lft forever preferred_lft forever

ip r
    default via 10.0.2.2 dev eth0 
    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 
    10.99.99.1 dev tun0 proto kernel scope link src 10.99.99.2 
    172.22.0.0/16 dev eth1 proto kernel scope link src 172.22.2.123 
    192.168.200.0/24 dev eth2 proto kernel scope link src 192.168.200.1 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Realizamos un PING al Servidor2 y al Cliente2.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vagrant@Servidor/Cliente1:/etc/openvpn$ ping 10.99.99.1
    PING 10.99.99.1 (10.99.99.1) 56(84) bytes of data.
    64 bytes from 10.99.99.1: icmp_seq=1 ttl=64 time=2.85 ms
    64 bytes from 10.99.99.1: icmp_seq=2 ttl=64 time=3.33 ms
    64 bytes from 10.99.99.1: icmp_seq=3 ttl=64 time=4.24 ms
    ^C
    --- 10.99.99.1 ping statistics ---
    3 packets transmitted, 3 received, 0% packet loss, time 5ms
    rtt min/avg/max/mdev = 2.851/3.473/4.240/0.576 ms

vagrant@Servidor/Cliente1:/etc/openvpn$ ping 192.168.100.50
    PING 192.168.100.50 (192.168.100.50) 56(84) bytes of data.
    64 bytes from 192.168.100.50: icmp_seq=1 ttl=63 time=3.37 ms
    64 bytes from 192.168.100.50: icmp_seq=2 ttl=63 time=8.10 ms
    64 bytes from 192.168.100.50: icmp_seq=3 ttl=63 time=20.4 ms
    ^C
    --- 192.168.100.50 ping statistics ---
    3 packets transmitted, 3 received, 0% packet loss, time 4ms
    rtt min/avg/max/mdev = 3.367/10.631/20.428/7.191 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;cliente-1&quot;&gt;Cliente 1&lt;/h3&gt;

&lt;p&gt;Eliminamos la tabla de enrrutmiento por defecto y le asignamos la dirección del Servidor/Cliente1.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo ip r del default
sudo ip r add default via 192.168.200.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Realizamos un PING al Cliente2 del Servidor2&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vagrant@Cliente1:~$ ping 192.168.100.50
    PING 192.168.100.50 (192.168.100.50) 56(84) bytes of data.
    64 bytes from 192.168.100.50: icmp_seq=1 ttl=62 time=6.53 ms
    64 bytes from 192.168.100.50: icmp_seq=2 ttl=62 time=3.73 ms
    64 bytes from 192.168.100.50: icmp_seq=3 ttl=62 time=7.20 ms
    ^C
    --- 192.168.100.50 ping statistics ---
    3 packets transmitted, 3 received, 0% packet loss, time 5ms
    rtt min/avg/max/mdev = 3.726/5.819/7.199/1.506 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;cliente-2&quot;&gt;Cliente 2&lt;/h3&gt;

&lt;p&gt;Eliminamos la tabla de enrrutmiento por defecto y le asignamos la dirección del Servidor2.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo ip r del default
sudo ip r add default via 192.168.100.20
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Realizamos un PING al Cliente1 del Servidor/Cliente1&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vagrant@Cliente2:~$ ping 192.168.100.2
    PING 192.168.100.2 (192.168.100.2) 56(84) bytes of data.
    64 bytes from 192.168.100.2: icmp_seq=1 ttl=62 time=6.53 ms
    64 bytes from 192.168.100.2: icmp_seq=2 ttl=62 time=3.73 ms
    64 bytes from 192.168.100.2: icmp_seq=3 ttl=62 time=7.20 ms
    ^C
    --- 192.168.100.2 ping statistics ---
    3 packets transmitted, 3 received, 0% packet loss, time 5ms
    rtt min/avg/max/mdev = 3.726/5.819/7.199/1.506 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>DavidDarnes</name></author><category term="Seguridad" /><summary type="html">Vamos a establecer una VPN de acceso remoto y a establecer una VPN de sitio a sitio, (Autenticación será con TLS utilizando certificados X.509 y la asignación de direcciones dinámica).</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/Portada1.png/assets/default-social-image.png" /><media:content medium="image" url="/assets/Portada1.png/assets/default-social-image.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Introducción a la integración continua</title><link href="/assets/Portada1.png/implantaci%C3%B3n%20app%20web/2020/02/04/Introduccion_de_Integracion_Continua/" rel="alternate" type="text/html" title="Introducción a la integración continua" /><published>2020-02-04T00:00:00+00:00</published><updated>2020-02-04T00:00:00+00:00</updated><id>/assets/Portada1.png/implantaci%C3%B3n%20app%20web/2020/02/04/Introduccion_de_Integracion_Continua</id><content type="html" xml:base="/assets/Portada1.png/implantaci%C3%B3n%20app%20web/2020/02/04/Introduccion_de_Integracion_Continua/">&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis.png?raw=true&quot; alt=&quot;iSCSI&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Vamos a realizar una integración continua con Travis con la ayuda de django.&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;tarea-1-despliegue-de-una-página-web-estática-build-deploy&quot;&gt;Tarea 1: Despliegue de una página web estática (build, deploy)&lt;/h2&gt;

&lt;p&gt;Generar una página web estática con un generador de paginas estáticas y desplegarla.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;En el repositorio GitHub sólo tienen que estar los ficheros markdown.&lt;/li&gt;
  &lt;li&gt;La página se debe generar en el sistema de integración continúa, por lo tanto debemos instalar las herramientas necesarias.&lt;/li&gt;
  &lt;li&gt;Investiga si podemos desplegar de forma automática en el servicio elegido (si es necesario cambia el servicio de hosting para el despliegue).&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Tenemos en el directorio &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Alejandro-MG&lt;/code&gt; de nuestro equipo, la configuración de nuestra página generada con Jekyll (Si quieres saber como instalar y configurar Jekyll pulse &lt;a href=&quot;https://github.com/MoralG/Instalacion_y_Configuracion_de_Jekyll/blob/master/Instalacion_Jekyll.md#intalaci%C3%B3n-de-jekyll&quot;&gt;AQUÍ&lt;/a&gt;), esta la vamos a subir a un repositorio de Github para que Travis la detecte y pueda realizar la integración continua.&lt;/p&gt;

&lt;p&gt;Pero antes vamos a crea el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.gitignore&lt;/code&gt; en el directorio para indicar que fichero o directorios no queremos subir. Tenemos que indicarle que no suba a GitHub el directorio donde se generan los &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;html&lt;/code&gt;, en nuestro caso &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_site&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cat .gitignore 
    _site/
    .sass-cache/
    .jekyll-metadata
    alembic-jekyll-theme-*.gem
    Gemfile.lock
    **/Gemfile.lock
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;NOTA: Los demás fichero y directorios a parte del &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_site&lt;/code&gt; los he metido porque no son necesario para la generación de la página estática.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Ahora vamos a subir el directorio al repositorio creado y en la rama master. El branch master va ser el que contenga todos los fichero de configuración, static, etc..&lt;/p&gt;

&lt;h6 id=&quot;subiendo-nuestro-directorio-alejandro-mg-a-github&quot;&gt;Subiendo nuestro directorio &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Alejandro-MG&lt;/code&gt; a GitHub&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd Alejandro-MG
git init
git add .
git commit -m 'Creación del repo'
git remote add origin git@github.com:MoralG/Alejandro-MG.git
git push -u origin master
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Cuando tengamos subido el directorio, vamos a crear un nuevo branch llamado &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gh-pages&lt;/code&gt; donde subiremos el directorio &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_site&lt;/code&gt;,  que es el que contiene los ficheros &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;html&lt;/code&gt;.&lt;/p&gt;

&lt;h6 id=&quot;creamos-la-rama-gh-pages&quot;&gt;Creamos la rama &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gh-pages&lt;/code&gt;&lt;/h6&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis1.0.png?raw=true&quot; alt=&quot;Travis&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Además tenemos que activar GitHub Pages y si tenemos un Dominio propio se lo indicamos también (Si quieres saer como activar GitHub Pages con dominio propio pulse &lt;a href=&quot;https://github.com/MoralG/Trabajando_con_GitHub-Pages/blob/master/Trabajando_con_Github_Pages.md#trabajando-con-github-pages&quot;&gt;AQUÍ&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Iniciamos en Travis con nuestro Github e indicamos la opción &lt;strong&gt;Only select repositories&lt;/strong&gt; y seleccionamos nuestro repositorio &lt;strong&gt;Alejandro-MG&lt;/strong&gt;.&lt;/p&gt;

&lt;h6 id=&quot;añadimos-el-repositorio-alejandro-mg&quot;&gt;Añadimos el repositorio Alejandro-MG&lt;/h6&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis1.1.png?raw=true&quot; alt=&quot;Travis&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Como podemos ver, ya nos sale agregado a Travis:&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis1.2.png?raw=true&quot; alt=&quot;Travis&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Ahora tenemos que creamos el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.travis.yml&lt;/code&gt; en el repositorio, este fichero es la configuración que va a seguir Travis para realizar la integración continua.&lt;/p&gt;

&lt;h6 id=&quot;añadimos-estos-pasos-al-fichero-travisyml&quot;&gt;Añadimos estos pasos al fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.travis.yml&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-yml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;language&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ruby&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;rvm&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;2.4.0&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;before_install&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;#  - gem update --system&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;gem install bundler&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle install&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle exec jekyll build&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;notifications&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;branches&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;only&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;master&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;global&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;NOKOGIRI_USE_SYSTEM_LIBRARIES=true&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;sudo&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;deploy&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;provider&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;pages&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;skip_cleanup&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;local_dir&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;_site&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;github_token&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;$GITHUB_TOKEN&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;repo&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;MoralG/Alejandro-MG&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;branch&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;gh-pages&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;fqdn&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;www.alejandro-mg.com&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;También tenemos que crear el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CNAME&lt;/code&gt; y añadir nuestro dominio, si tenemos uno comprado.&lt;/p&gt;

&lt;h6 id=&quot;añadimos-el-fichero-cname&quot;&gt;Añadimos el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CNAME&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;www.alejandro-mg.com
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora vamos a generar el Tokens necesario para que Travis pueda realizar la integración continua. Para generar esto tenemos que ir a &lt;strong&gt;Settings &amp;gt; Developer settings &amp;gt; Personal access tokens&lt;/strong&gt; y hacer clic en &lt;strong&gt;Generate new token&lt;/strong&gt;.&lt;/p&gt;

&lt;h6 id=&quot;creamos-el-tokens&quot;&gt;Creamos el Tokens&lt;/h6&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis1.3.png?raw=true&quot; alt=&quot;Travis&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Nos saldrá una serie de opciones. Las cuales tenemos que seleccionar &lt;strong&gt;repo&lt;/strong&gt; y &lt;strong&gt;admin:repo_hook&lt;/strong&gt; para concederle permisos de escritura y lesctura a Travis.&lt;/p&gt;

&lt;h6 id=&quot;le-concedemos-los-permisos-a-travis&quot;&gt;Le concedemos los permisos a Travis&lt;/h6&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis1.4.png?raw=true&quot; alt=&quot;Travis&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Cuando le demos a &lt;strong&gt;Generate token&lt;/strong&gt; nos saldrá el código del Tokens, el cual tendremos que copiar.&lt;/p&gt;
&lt;h6 id=&quot;copiamos-el-token&quot;&gt;Copiamos el token&lt;/h6&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis1.5.png?raw=true&quot; alt=&quot;Travis&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Con el token copiado nos dirigimos a Travis, al &lt;strong&gt;settings&lt;/strong&gt; del repositorio, y nos vamos al apartado de &lt;strong&gt;Enviroment Variables&lt;/strong&gt; y añadimos un token nuevo.&lt;/p&gt;

&lt;p&gt;En el apartado &lt;strong&gt;Nombre&lt;/strong&gt; le indicamos &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GITHUB_TOKEN&lt;/code&gt; y en el apartado &lt;strong&gt;Value&lt;/strong&gt; pegamos el token, lo demás lo dejamos por defecto y le damos a &lt;strong&gt;add&lt;/strong&gt;.&lt;/p&gt;

&lt;h6 id=&quot;añadimos-a-travis-el-token&quot;&gt;Añadimos a Travis el Token&lt;/h6&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis1.6.png?raw=true&quot; alt=&quot;Travis&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Ahora ya tendremos todo listo para que se realice la integración continua, para comprobar funciona tenemos que realizar cambios en nuestra configuración de nuestra página estática y realizar un &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;git push -u origin master&lt;/code&gt;. Travis empezará a trabajar y a realizar las pautas que le hemos indicado en el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.travis.yml&lt;/code&gt;.&lt;/p&gt;

&lt;h6 id=&quot;mostrando-el-job-log-de-travis&quot;&gt;Mostrando el Job log de Travis&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Worker information

Build system information

$ git clone --depth=50 --branch=master https://github.com/MoralG/Alejandro-MG.git MoralG/Alejandro-MG
MoralG/Alejandro-MG
Cloning into 'MoralG/Alejandro-MG'...
$ cd MoralG/Alejandro-MG
$ git checkout -qf 4c58780e533a84ca1ad807ae5fea731ac286fc3f


Setting environment variables from repository settings
$ export GITHUB_TOKEN=[secure]

Setting environment variables from .travis.yml
$ export NOKOGIRI_USE_SYSTEM_LIBRARIES=true

rvm use 2.4.0 --install --binary --fuzzy

$ export BUNDLE_GEMFILE=$PWD/Gemfile
$ ruby --version

gem install bundler
bundle install --jobs=3 --retry=3

bundle install
Using concurrent-ruby 1.1.5
Using i18n 0.9.5
Using minitest 5.14.0
Using thread_safe 0.3.6
Using tzinfo 1.2.6
Using activesupport 5.2.4.1
Using public_suffix 4.0.3
Using addressable 2.7.0
Using colorator 1.1.0
Using eventmachine 1.2.7
Using http_parser.rb 0.6.0
Using em-websocket 0.5.1
Using rb-fsevent 0.10.3
Using ffi 1.12.2
Using rb-inotify 0.10.1
Using sass-listen 4.0.0
Using sass 3.7.4
Using jekyll-sass-converter 1.5.2
Using listen 3.2.1
Using jekyll-watch 2.2.1
Using kramdown 1.17.0
Using liquid 4.0.3
Using mercenary 0.3.6
Using forwardable-extended 2.6.0
Using pathutil 0.16.2
Using rouge 3.15.0
Using safe_yaml 1.0.5
Using jekyll 3.8.6
Using ruby-enum 0.7.2
Using commonmarker 0.21.0
Using jekyll-commonmark 1.3.1
Using jekyll-default-layout 0.1.4
Using jekyll-feed 0.13.0
Using jekyll-include-cache 0.2.0
Using mini_portile2 2.4.0
Using nokogiri 1.10.7
Using html-pipeline 2.12.3
Using jekyll-mentions 1.5.1
Using jekyll-paginate 1.1.0
Using jekyll-redirect-from 0.16.0
Using jekyll-seo-tag 2.6.1
Using jekyll-sitemap 0.13.0
Using gemoji 3.0.1
Using jemoji 0.11.1
Using alembic-jekyll-theme 3.1.0 from source at `.`
Using bundler 2.1.4
Bundle complete! 1 Gemfile dependency, 46 gems now installed.
Use `bundle info [gemname]` to see where a bundled gem is installed.
The command &quot;bundle install&quot; exited with 0.
$ bundle exec jekyll build
Configuration file: /home/travis/build/MoralG/Alejandro-MG/_config.yml
            Source: /home/travis/build/MoralG/Alejandro-MG
       Destination: /home/travis/build/MoralG/Alejandro-MG/_site
 Incremental build: disabled. Enable with --incremental
      Generating... 
       Jekyll Feed: Generating feed for posts
                    done in 3.135 seconds.
 Auto-regeneration: disabled. Use --watch to enable.
The command &quot;bundle exec jekyll build&quot; exited with 0.

$ rvm $(travis_internal_ruby) --fuzzy do ruby -S gem install dpl

Installing deploy dependencies
Logged in as @MoralG (Alejandro Morales Gracia)
cd /tmp/d20200203-7718-1g0d5gj/work
Preparing deploy
Deploying application
Done. Your build exited with 0.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Terminada la integración correctamente, Travis nos mostrará el mensaje &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Done. Your build exited with 0&lt;/code&gt; y se mostrará así:&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis1.7.png?raw=true&quot; alt=&quot;Travis&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;tarea-2-integración-continúa-de-aplicación-django-test--deploy&quot;&gt;Tarea 2: Integración continúa de aplicación django (Test + Deploy)&lt;/h2&gt;

&lt;p&gt;Vamos a trabajar con el repositorio de la aplicación &lt;a href=&quot;https://github.com/josedom24/django_tutorial&quot;&gt;django_tutorial&lt;/a&gt;. Esta aplicación tiene definidas una serie de test, que podemos estudiar en el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tests.py&lt;/code&gt; del directorio &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;polls&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Para ejecutar las pruebas unitarias, ejecutamos la instrucción &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;python3 manage.py test&lt;/code&gt;.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Estudia las distintas pruebas que se han realizado, y modifica el código de la aplicación para que al menos una de ella no se ejecute de manera exitosa.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;A continuación vamos a configurar la integración continúa para que cada vez que hagamos un commit se haga la ejecución de test en travis.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Vamos a empezar clonando el repositorio indicado &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;django_tutorial&lt;/code&gt; en nuestra máquina para poder realizar los test necesarios.&lt;/p&gt;

&lt;h6 id=&quot;clonamos-el-repositorio&quot;&gt;Clonamos el repositorio&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://github.com/josedom24/django_tutorial.git
  Clonando en 'django_tutorial'...
  remote: Enumerating objects: 3, done.
  remote: Counting objects: 100% (3/3), done.
  remote: Compressing objects: 100% (2/2), done.
  remote: Total 96 (delta 0), reused 0 (delta 0), pack-reused 93
  Desempaquetando objetos: 100% (96/96), listo.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Creamos un entorno virtual llamado &lt;strong&gt;django_tutorial&lt;/strong&gt; para poder instalar los requirement.&lt;/p&gt;

&lt;h6 id=&quot;creamos-el-entorno-virtual&quot;&gt;Creamos el entorno virtual&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;python3 -m venv django_tutorial
source django_tutorial/bin/activate
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;instalamos-el-requirementtxt&quot;&gt;Instalamos el &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;requirement.txt&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pip install -r requirements.txt 
  Collecting Django==2.2.7 (from -r requirements.txt (line 1))
    Using cached https://files.pythonhosted.org/packages/a0/36/ 463632a2e9161a7e713488d719a280e8cb0c7e3a66ed32a32e801891caae/  Django-2.2.7-py3-none-any.whl
  Collecting gunicorn (from -r requirements.txt (line 2))
    Downloading https://files.pythonhosted.org/packages/69/ca/  926f7cd3a2014b16870086b2d0fdc84a9e49473c68a8dff8b57f7c156f43/ gunicorn-20.0.4-py2.py3-none-any.whl (77kB)
      100% |████████████████████████████████| 81kB 587kB/s 
  Collecting pytz (from Django==2.2.7-&amp;gt;-r requirements.txt (line 1))
    Using cached https://files.pythonhosted.org/packages/e7/f9/ f0b53f88060247251bf481fa6ea62cd0d25bf1b11a87888e53ce5b7c8ad2/  pytz-2019.3-py2.py3-none-any.whl
  Collecting sqlparse (from Django==2.2.7-&amp;gt;-r requirements.txt (line 1))
    Using cached https://files.pythonhosted.org/packages/ef/53/ 900f7d2a54557c6a37886585a91336520e5539e3ae2423ff1102daf4f3a7/  sqlparse-0.3.0-py2.py3-none-any.whl
  Requirement already satisfied: setuptools&amp;gt;=3.0 in /home/moralg/EntornosVirtuales/ django_tutorial/lib/python3.7/site-packages (from gunicorn-&amp;gt;-r requirements.txt (line  2)) (40.8.0)
  Installing collected packages: pytz, sqlparse, Django, gunicorn
  Successfully installed Django-2.2.7 gunicorn-20.0.4 pytz-2019.3 sqlparse-0.3.0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora vamos a realizar el test para comprobar la integridad del programa django.&lt;/p&gt;

&lt;h6 id=&quot;realizamos-el-test&quot;&gt;Realizamos el test&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;python3 manage.py test
  Creating test database for alias 'default'...
  System check identified no issues (0 silenced).
  ..........
  ----------------------------------------------------------------------
  Ran 10 tests in 0.031s

  OK
  Destroying test database for alias 'default'...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;La prueba se ha realizado correctamente, pero si añadimos una linea que no sigue las normas de los test del ficherpo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;polls/test.py&lt;/code&gt;, el test fallará.&lt;/p&gt;

&lt;p&gt;Por ejemplo, en el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;test.py&lt;/code&gt; nos indica en diferentes reglas, que debe de responder &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;No polls are available.&lt;/code&gt;.&lt;/p&gt;

&lt;h6 id=&quot;linea-del-fichero-testpy&quot;&gt;Linea del fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;test.py&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;self.assertContains(response, &quot;No polls are available.&quot;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Si cambiamos ese respuesta en el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;polls/templates/polls/index.html&lt;/code&gt; deberá de fallar el test&lt;/p&gt;

&lt;h6 id=&quot;modificamos-el-fichero-indexhtml&quot;&gt;Modificamos el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;index.html&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;.
.
.
    &amp;lt;p&amp;gt;ESTO_ES_UNA_PRUEBA_PARA_REALIZAR_EL_TEST&amp;lt;/p&amp;gt;
.
.
.

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;ejecutamos-el-test&quot;&gt;Ejecutamos el test&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;python3 manage.py test
  Creating test database for alias 'default'...
  System check identified no issues (0 silenced).
  ..F.F.....
  ======================================================================
  FAIL: test_future_question (polls.tests.QuestionIndexViewTests)
  ----------------------------------------------------------------------
  Traceback (most recent call last):
    File &quot;/home/moralg/Github/django_tutorial/polls/tests.py&quot;, line 79, in  test_future_question
      self.assertContains(response, &quot;No polls are available.&quot;)
    File &quot;/home/moralg/EntornosVirtuales/django_tutorial/lib/python3.7/site-packages/ django/test/testcases.py&quot;, line 454, in assertContains
      self.assertTrue(real_count != 0, msg_prefix + &quot;Couldn't find %s in response&quot; %  text_repr)
  AssertionError: False is not true : Couldn't find 'No polls are available.' in  response

  ======================================================================
  FAIL: test_no_questions (polls.tests.QuestionIndexViewTests)
  ----------------------------------------------------------------------
  Traceback (most recent call last):
    File &quot;/home/moralg/Github/django_tutorial/polls/tests.py&quot;, line 57, in  test_no_questions
      self.assertContains(response, &quot;No polls are available.&quot;)
    File &quot;/home/moralg/EntornosVirtuales/django_tutorial/lib/python3.7/site-packages/ django/test/testcases.py&quot;, line 454, in assertContains
      self.assertTrue(real_count != 0, msg_prefix + &quot;Couldn't find %s in response&quot; %  text_repr)
  AssertionError: False is not true : Couldn't find 'No polls are available.' in  response

  ----------------------------------------------------------------------
  Ran 10 tests in 0.027s

  FAILED (failures=2)
  Destroying test database for alias 'default'...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Como podemos observar en el fallo, nos muestras los dos test que depende de que la respuesta tenga que ser &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;No polls are available.&lt;/code&gt; y nos salta con el error &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AssertionError: False is not true : Couldn't find 'No polls are available.' in  response&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Ahora vamos a realzar un fork del repositorio &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;django_tutorial&lt;/code&gt; para sincronizarlo con Travis y que se comproebe el test.&lt;/p&gt;

&lt;h6 id=&quot;realizamos-el-fork&quot;&gt;Realizamos el fork&lt;/h6&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis2.1.png?raw=true&quot; alt=&quot;Travis&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Cuando tengamos realicemos el fork, vamos a clonarlo y añadiremos dentro del repositorio un fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.travis.yml&lt;/code&gt; para realizar las reglas de Travis.&lt;/p&gt;

&lt;h6 id=&quot;clonamos-el-repositorio-y-creamos-el-fichero-travisyml&quot;&gt;Clonamos el repositorio y creamos el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.travis.yml&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone git@github.com:MoralG/django_tutorial.git
cd django_tutorial
touch .travis.yml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;El fichero de Travis vamos a indicarle la versión, la intalación del fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;requirement.txt&lt;/code&gt; y que realice el test.&lt;/p&gt;

&lt;h6 id=&quot;fichero-travisyml&quot;&gt;Fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.travis.yml&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;language: python
python:
  - &quot;3.8&quot;
install:
  - pip3 install -r requirements.txt
script: python3 manage.py test
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora que tenemos el repositorio preparado vamos a sincronizarlo a Travis para realizar el ejercicio.&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis2.2.png?raw=true&quot; alt=&quot;Travis&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Tenemos listo el escenario para realizar el mismo cambio que hicimos en el &lt;a href=&quot;&quot;&gt;punto anterior&lt;/a&gt;, y que nos notifique Travis que hay un error al realizar los test.&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis2.5.png?raw=true&quot; alt=&quot;Travis&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h6 id=&quot;cambio-realizado-con-el-error&quot;&gt;Cambio realizado con el error&lt;/h6&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis2.3.png?raw=true&quot; alt=&quot;Travis&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;En el Job log nos muestra los test que han fallado y nos devuelve el valor 1. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Done. Your build exited with 1.&lt;/code&gt;&lt;/p&gt;

&lt;h6 id=&quot;mostramos-el-job-log&quot;&gt;Mostramos el Job log&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Build system information

Downloading archive: https://storage.googleapis.com/travis-ci-language-archives/python/binaries/ubuntu/16.04/x86_64/python-3.8.tar.bz2
$ curl -sSf --retry 5 -o python-3.8.tar.bz2 ${archive_url}
$ sudo tar xjf python-3.8.tar.bz2 --directory /

$ git clone --depth=50 --branch=master https://github.com/MoralG/django_tutorial.git MoralG/django_tutorial

$ source ~/virtualenv/python3.8/bin/activate
$ python --version
Python 3.8.0
$ pip --version
pip 19.3 from /home/travis/virtualenv/python3.8.0/lib/python3.8/site-packages/pip (python 3.8)

$ pip3 install -r requirements.txt
$ python3 manage.py test
Creating test database for alias 'default'...
System check identified no issues (0 silenced).
..F.F.....
======================================================================
FAIL: test_future_question (polls.tests.QuestionIndexViewTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/travis/build/MoralG/django_tutorial/polls/tests.py&quot;, line 79, in test_future_question
    self.assertContains(response, &quot;No polls are available.&quot;)
  File &quot;/home/travis/virtualenv/python3.8.0/lib/python3.8/site-packages/django/test/testcases.py&quot;, line 454, in assertContains
    self.assertTrue(real_count != 0, msg_prefix + &quot;Couldn't find %s in response&quot; % text_repr)
AssertionError: False is not true : Couldn't find 'No polls are available.' in response
======================================================================
FAIL: test_no_questions (polls.tests.QuestionIndexViewTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/travis/build/MoralG/django_tutorial/polls/tests.py&quot;, line 57, in test_no_questions
    self.assertContains(response, &quot;No polls are available.&quot;)
  File &quot;/home/travis/virtualenv/python3.8.0/lib/python3.8/site-packages/django/test/testcases.py&quot;, line 454, in assertContains
    self.assertTrue(real_count != 0, msg_prefix + &quot;Couldn't find %s in response&quot; % text_repr)
AssertionError: False is not true : Couldn't find 'No polls are available.' in response
----------------------------------------------------------------------
Ran 10 tests in 0.033s

FAILED (failures=2)
Destroying test database for alias 'default'...
The command &quot;python3 manage.py test&quot; exited with 1.

Done. Your build exited with 1.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;cambio-corregido-y-sin-fallos&quot;&gt;Cambio corregido y sin fallos&lt;/h6&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Introduccion_de_Integracion_Continua/blob/master/image/Travis2.4.png?raw=true&quot; alt=&quot;Travis&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;En este caso, donde hemos arreglado el error, nos muestra el Job log sin ningun error del test y nos devuelve un valor de 0. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Done. Your build exited with 0&lt;/code&gt;.&lt;/p&gt;

&lt;h6 id=&quot;mostrando-el-job-log&quot;&gt;Mostrando el Job log&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Build system information

Downloading archive: https://storage.googleapis.com/travis-ci-language-archives/python/binaries/ubuntu/16.04/x86_64/python-3.8.tar.bz2
curl -sSf --retry 5 -o python-3.8.tar.bz2 ${archive_url}
sudo tar xjf python-3.8.tar.bz2 --directory /

$ git clone --depth=50 --branch=master https://github.com/MoralG/django_tutorial.git MoralG/

$ source ~/virtualenv/python3.8/bin/activate
$ python --version
Python 3.8.0
$ pip --version
Python 3.8.0
$ pip 19.3 from /home/travis/virtualenv/python3.8.0/lib/python3.8/site-packages/pip (python 3.8)
$ pip3 install -r requirements.txt
$ python3 manage.py test
Creating test database for alias 'default'...
System check identified no issues (0 silenced).
..........
----------------------------------------------------------------------
Ran 10 tests in 0.033s

OK
Destroying test database for alias 'default'...
The command &quot;python3 manage.py test&quot; exited with 0.

Done. Your build exited with 0.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>DavidDarnes</name></author><category term="Implantación App Web" /><summary type="html">Vamos a realizar una integración continua con Travis con la ayuda de django.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/Portada1.png/assets/default-social-image.png" /><media:content medium="image" url="/assets/Portada1.png/assets/default-social-image.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Trabajando con iSCSI</title><link href="/assets/Portada1.png/sistemas/2020/01/24/Trabajando_con_iSCSI/" rel="alternate" type="text/html" title="Trabajando con iSCSI" /><published>2020-01-24T00:00:00+00:00</published><updated>2020-01-24T00:00:00+00:00</updated><id>/assets/Portada1.png/sistemas/2020/01/24/Trabajando_con_iSCSI</id><content type="html" xml:base="/assets/Portada1.png/sistemas/2020/01/24/Trabajando_con_iSCSI/">&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/raw/master/image/iSCSI.jpg&quot; alt=&quot;iSCSI&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Vamos a configurar un sistema que exporte algunos targets por iSCSI y los conecte a diversos clientes, explicando con detalle la forma de trabajar.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Vamos a crear un escenario con Vagrant. Vamos a crear una máquina servidor, conectada por una red interna a dos cliente, un cliente Debian y otro Window. al servidor le añadiremos 3 volúmenes. Añadiremos un interfaz con conexión a internet para poder descargar los paquetes necesarios.&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Vagrant.configure&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; |config|

  config.vm.define :servidor1 &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; |servidor1|
    d1 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;.vagrant/disco1.vdi&quot;&lt;/span&gt;
    d2 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;.vagrant/disco2.vdi&quot;&lt;/span&gt;
    d3 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;.vagrant/disco3.vdi&quot;&lt;/span&gt;
    servidor1.vm.box &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;debian/buster64&quot;&lt;/span&gt;
    servidor1.vm.hostname &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Servidor1&quot;&lt;/span&gt;

    servidor1.vm.network :public_network,:bridge&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;enp3s0&quot;&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;#servidor.vm.network :public_network,:bridge=&amp;gt;&quot;wlp2s0&quot;&lt;/span&gt;
    servidor1.vm.network :private_network, ip: &lt;span class=&quot;s2&quot;&gt;&quot;192.168.100.1&quot;&lt;/span&gt;, virtualbox__intnet:&lt;span class=&quot;s2&quot;&gt;&quot;mired1&quot;&lt;/span&gt;

    servidor1.vm.provider :virtualbox &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; |v|
	    &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;not File.exist?&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;d1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
	    	v.customize &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;createhd&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;--filename&quot;&lt;/span&gt;, d1, &lt;span class=&quot;s2&quot;&gt;&quot;--size&quot;&lt;/span&gt;, 1 &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;  1024]
	    end
	    v.customize &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;storageattach&quot;&lt;/span&gt;, :id, &lt;span class=&quot;s2&quot;&gt;&quot;--storagectl&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;SATA Controller&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;--port&quot;&lt;/span&gt;, 1,&lt;span class=&quot;s2&quot;&gt;&quot;--device&quot;&lt;/span&gt;, 0, &lt;span class=&quot;s2&quot;&gt;&quot;--type&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;hdd&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;--medium&quot;&lt;/span&gt;, d1]

	    &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;not File.exist?&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;d2&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
	    	v.customize &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;createhd&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;--filename&quot;&lt;/span&gt;, d2, &lt;span class=&quot;s2&quot;&gt;&quot;--size&quot;&lt;/span&gt;, 1 &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; 1024]
	    end
	    v.customize &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;storageattach&quot;&lt;/span&gt;, :id, &lt;span class=&quot;s2&quot;&gt;&quot;--storagectl&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;SATA Controller&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;--port&quot;&lt;/span&gt;, 2,&lt;span class=&quot;s2&quot;&gt;&quot;--device&quot;&lt;/span&gt;, 0, &lt;span class=&quot;s2&quot;&gt;&quot;--type&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;hdd&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;--medium&quot;&lt;/span&gt;, d2]

        &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;not File.exist?&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;d3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
            v.customize &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;createhd&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;--filename&quot;&lt;/span&gt;, d3, &lt;span class=&quot;s2&quot;&gt;&quot;--size&quot;&lt;/span&gt;, 1 &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; 1024]
        end
        v.customize &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;storageattach&quot;&lt;/span&gt;, :id, &lt;span class=&quot;s2&quot;&gt;&quot;--storagectl&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;SATA Controller&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;--port&quot;&lt;/span&gt;, 3,&lt;span class=&quot;s2&quot;&gt;&quot;--device&quot;&lt;/span&gt;, 0, &lt;span class=&quot;s2&quot;&gt;&quot;--type&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;hdd&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;--medium&quot;&lt;/span&gt;, d3]
    end
  end

  config.vm.define :cliente1 &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; |cliente1|
    cliente1.vm.box &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;debian/buster64&quot;&lt;/span&gt;
    cliente1.vm.hostname &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Cliente1&quot;&lt;/span&gt;
    cliente1.vm.network :public_network,:bridge&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;enp3s0&quot;&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;#cliente1.vm.network :public_network,:bridge=&amp;gt;&quot;wlp2s0&quot;&lt;/span&gt;
    cliente1.vm.network :private_network, ip: &lt;span class=&quot;s2&quot;&gt;&quot;192.168.100.2&quot;&lt;/span&gt;, virtualbox__intnet:&lt;span class=&quot;s2&quot;&gt;&quot;mired1&quot;&lt;/span&gt;
  end

  config.vm.define :cliente1 &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; |cliente2|
    cliente2.vm.box &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;vdelarosa/windows-10&quot;&lt;/span&gt;
    cliente2.vm.hostname &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Cliente2&quot;&lt;/span&gt;
    cliente2.vm.network :public_network,:bridge&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;enp3s0&quot;&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;#cliente2.vm.network :public_network,:bridge=&amp;gt;&quot;wlp2s0&quot;&lt;/span&gt;
    cliente2.vm.network :private_network, ip: &lt;span class=&quot;s2&quot;&gt;&quot;192.168.100.3&quot;&lt;/span&gt;, virtualbox__intnet:&lt;span class=&quot;s2&quot;&gt;&quot;mired1&quot;&lt;/span&gt;
  end

end
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;tarea-1&quot;&gt;Tarea 1&lt;/h2&gt;

&lt;p&gt;Crearemos un target con una LUN y lo conectaremos a un cliente GNU/Linux. ¿Cómo escaneamos desde el cliente buscando los targets disponibles y utilizando la unidad lógica proporcionada?, formateándola si es necesario y montándola.&lt;/p&gt;

&lt;p&gt;Conceptos:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;iSCSI&lt;/strong&gt;: Es un estándar de red de almacenamiento que vincula instalaciones de almacenamiento de datos. Facilita la transferencia de datos a través de redes LAN, WAN o Internet. Todo esto quiere decir que el espacio en el servidor de almacenamiento será considerado como discos locales por el sistema operativo del cliente pero todos los datos tranferidos al disco se transfiren realmente a través de la red al servidor de almacenamiento.&lt;/p&gt;

  &lt;p&gt;&lt;strong&gt;LUN&lt;/strong&gt; (Logical Unit Number): Un LUN se representa como un dispositivo SCSI direccionable individualmente que forma parte de un dispositivo SCDI físico, es decir, una dirección que identifica un disco completo o un trocito de un dispositivo de bloque del Servidor.&lt;/p&gt;

  &lt;p&gt;&lt;strong&gt;Target&lt;/strong&gt;: Es el encargado de asignar virtualmente los LUN creados al sistema operativo del cliente.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;configuración-del-servidor&quot;&gt;Configuración del servidor&lt;/h3&gt;

&lt;p&gt;En el servidor hemos asignado tres discos de 1GB, los cuales vamos a agrupar en un LVM para tener un espacio de almacenamiento de 3GB y poder gestionarlo como si fuese un solo dispositivo de bloque.&lt;/p&gt;

&lt;h6 id=&quot;comprobamos-los-disco-asignados-al-servidor&quot;&gt;Comprobamos los disco asignados al Servidor&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;lsblk -l
    NAME MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
    sda    8:0    0 19.8G  0 disk 
    sda1   8:1    0 18.8G  0 part /
    sda2   8:2    0    1K  0 part 
    sda5   8:5    0 1021M  0 part [SWAP]
    sdb    8:16   0    1G  0 disk 
    sdc    8:32   0    1G  0 disk 
    sdd    8:48   0    1G  0 disk 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Vamos a descargar el paquete &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;lvm2&lt;/code&gt; que instalará los paquetes del kernel, el daemon del espacio de usuario y todo lo demás que necesitamos para trabajar con LVM.&lt;/p&gt;

&lt;h6 id=&quot;descargamos-e-instalamos-lvm2&quot;&gt;Descargamos e instalamos &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;lvm2&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt install lvm2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora vamos a definir los volúmenes físicos donde indicaremos el disco &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sdb&lt;/code&gt;.&lt;/p&gt;

&lt;h6 id=&quot;definiendo-el-volumen-físico&quot;&gt;Definiendo el volumen físico&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo pvcreate /dev/sdb
  Physical volume &quot;/dev/sdb&quot; successfully created.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Después de definir el volumen físico tenemos que crear el grupo de volúmenes. a este grupo de volúmenes lo llamaremo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;vgCliente1&lt;/code&gt; con el volumen físico &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sdb&lt;/code&gt;.&lt;/p&gt;

&lt;h6 id=&quot;creando-el-grupo-de-volúmenes&quot;&gt;Creando el grupo de volúmenes&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo vgcreate vgCliente1 /dev/sdb
  Volume group &quot;vgCliente1&quot; successfully created
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora vamos a crear un volumen lógico, el cual va a ser el espacio que contendrá el sistema de ficheros. Este lo podemos crear del tamaño que queramos dependiendo del tamaño todal del grupo de volúmenes, en nuestro caso va a ser de 500Mb y lo llamaremos &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;lv1&lt;/code&gt; perteneciente al grupo de volumenes &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;vgCliente1&lt;/code&gt;.&lt;/p&gt;

&lt;h6 id=&quot;creando-el-volumen-lógico&quot;&gt;Creando el volumen lógico&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo lvcreate -L 500M -n lv1 vgCliente1
  Logical volume &quot;lv1&quot; created.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ya tenemos nuestro volumen lógico creado, ahora podemos ya trabajar con el para crear el LUN y asignarlo mediante un target al cliente.&lt;/p&gt;

&lt;h6 id=&quot;comprobamos-que-se-ha-creado-de-forma-correcta&quot;&gt;Comprobamos que se ha creado de forma correcta&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo lvs
  LV   VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  lv1  vgCliente1 -wi-a----- 500.00m

sudo lvdisplay 
  --- Logical volume ---
  LV Path                /dev/vgCliente1/lv1
  LV Name                lv1
  VG Name                vgCliente1
  LV UUID                xR20wc-5YFN-af3g-UQGD-LH6Y-MoUL-3F7H2G
  LV Write Access        read/write
  LV Creation host, time Servidor1, 2020-02-01 12:30:02 +0000
  LV Status              available
  # open                 0
  LV Size                500.00 MiB
  Current LE             125
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           254:0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ya tenemos todo lo necesario para trabajar con iSCSI pero tenemos que descargar el paquete tgt, que va a instalar los paquetes necesario para crear target.&lt;/p&gt;

&lt;h6 id=&quot;descargamos-e-instalamos-el-paquete-tgt&quot;&gt;Descargamos e instalamos el paquete &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tgt&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt install tgt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora tenemmos que crear el target, que se configura el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/tgt/targets.conf&lt;/code&gt; con la siguiente configuración:&lt;/p&gt;

&lt;hr /&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;target &amp;lt;Estructura _del_target&amp;gt;&amp;gt;
    backing-store &amp;lt;Nombre_del_volumen_lógico&amp;gt;
&amp;lt;/target&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Estructura de los target iSCSI: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;iqn.&amp;lt;AÑO&amp;gt;-&amp;lt;MES&amp;gt;.&amp;lt;DOMINO_INVERTIDO&amp;gt;:&amp;lt;NOMBRE_DE_LA_MÁQUINA&amp;gt;.&amp;lt;TARGET&amp;gt;&amp;lt;NÚMERO&amp;gt;&lt;/code&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Nombre del volumen logico:&lt;/p&gt;
    &lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo lvdisplay | egrep &quot;LV Path&quot; | awk '{ print $3 }'
/dev/vgCliente1/lv1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;hr /&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;En nuestro caso quedaría de la siguiente forma:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;target iqn.2020-01.com:tg1&amp;gt;
    backing-store /dev/vgCliente1/lv1
&amp;lt;/target&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Tenemos que reiniciar el servicio de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tgt&lt;/code&gt; para que reconzca la modificación del fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/tgt/targets.conf&lt;/code&gt;&lt;/p&gt;

&lt;h6 id=&quot;reiniciamos-el-servicio&quot;&gt;Reiniciamos el servicio&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl restart tgt.service 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;comprobamos-que-se-ha-creado-correctamente&quot;&gt;Comprobamos que se ha creado correctamente&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo tgtadm --mode target --op show
Target 1: iqn.2020-01.com:tg1
    System information:
        Driver: iscsi
        State: ready
    I_T nexus information:
    LUN information:
        LUN: 0
            Type: controller
            SCSI ID: IET     00010000
            SCSI SN: beaf10
            Size: 0 MB, Block size: 1
            Online: Yes
            Removable media: No
            Prevent removal: No
            Readonly: No
            SWP: No
            Thin-provisioning: No
            Backing store type: null
            Backing store path: None
            Backing store flags: 
        LUN: 1
            Type: disk
            SCSI ID: IET     00010001
            SCSI SN: beaf11
            Size: 734 MB, Block size: 512
            Online: Yes
            Removable media: No
            Prevent removal: No
            Readonly: No
            SWP: No
            Thin-provisioning: No
            Backing store type: rdwr
            Backing store path: /dev/vgCliente1/vol1
            Backing store flags: 
    Account information:
    ACL information:
        ALL
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;configuración-en-el-cliente&quot;&gt;Configuración en el cliente&lt;/h3&gt;

&lt;p&gt;Para iniciar iSCSI en el cliente hay que instalar el paquete &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;open-iscsi&lt;/code&gt;:&lt;/p&gt;

&lt;h6 id=&quot;descargamos-e-instalamos-open-iscsi&quot;&gt;Descargamos e instalamos &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;open-iscsi&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt install open-iscsi
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A continuación se edita el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/iscsi/iscsid.conf&lt;/code&gt; para indicar que de forma automática escanee los target accesibles al cliente, para eso, tenemos que configurrar el parámetro &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;iscsid.startup&lt;/code&gt; en &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;automatic&lt;/code&gt;.&lt;/p&gt;

&lt;h6 id=&quot;modificamos-la-línea&quot;&gt;Modificamos la línea&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;iscsid.startup = automatic
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Para que se actualicen los cambios tenemos que reiniciar el servicio de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;open-iscsi&lt;/code&gt;.&lt;/p&gt;

&lt;h6 id=&quot;reiniciamos-el-servicio-1&quot;&gt;Reiniciamos el servicio&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl restart open-iscsi.service 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora vamos a buscar los target disponibles y accesibles del Servidor. Para listar los target tenemos que indicarle la dirección del Servidor.&lt;/p&gt;

&lt;h6 id=&quot;listamos-los-target&quot;&gt;Listamos los target&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iscsiadm -m node
  192.168.100.1:3260,1 iqn.2020-01.com:tg1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Tenemos el listado de los target disponibles del servidor, solo nos queda conectarnos al target que queramos.&lt;/p&gt;

&lt;h6 id=&quot;nos-conectamos-al-target-iqn2020-01comtg1&quot;&gt;Nos conectamos al target &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;iqn.2020-01.com:tg1&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iscsiadm -m node -T iqn.2020-01.com:tg1 --portal &quot;192.168.100.1&quot; --login
  Logging in to [iface: default, target: iqn.2020-01.com:tg1, portal: 192.168.100.1,3260] (multiple)
  Login to [iface: default, target: iqn.2020-01.com:tg1, portal: 192.168.100.1,3260] successful.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Podemos comprobar que se nos ha asignado un nuevo disco de 500MB, el cual es el LUM1 que tenemos en el Servidor.&lt;/p&gt;
&lt;h6 id=&quot;comprobamos-que-tenemos-el-nuevo-disco&quot;&gt;Comprobamos que tenemos el nuevo disco&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;lsblk -l
  NAME MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
  sda    8:0    0 19.8G  0 disk 
  sda1   8:1    0 18.8G  0 part /
  sda2   8:2    0    1K  0 part 
  sda5   8:5    0 1021M  0 part [SWAP]
  sdb    8:16   0  500M  0 disk 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora vamos a particionarlo, formatearlo y montarlo como un disco normal.&lt;/p&gt;

&lt;p&gt;Lo particionamos con &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fdisk&lt;/code&gt; y le indicamos que sea una particion completa y comprobamos que se ha realizado correctamente con &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fdisk -l&lt;/code&gt; al ser de tipo &lt;strong&gt;VIRTUAL_DISK&lt;/strong&gt;&lt;/p&gt;
&lt;h6 id=&quot;particionamos&quot;&gt;Particionamos&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo fdisk /dev/sdb

  Welcome to fdisk (util-linux 2.33.1).
  Changes will remain in memory only, until you decide to write them.
  Be careful before using the write command.

  Device does not contain a recognized partition table.
  Created a new DOS disklabel with disk identifier 0x0f7ae951.

  Command (m for help): n
  Partition type
     p   primary (0 primary, 0 extended, 4 free)
     e   extended (container for logical partitions)
  Select (default p): 

  Using default response p.
  Partition number (1-4, default 1): 
  First sector (2048-1023999, default 2048): 
  Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-1023999, default 1023999): 

  Created a new partition 1 of type 'Linux' and of size 499 MiB.

  Command (m for help): w
  The partition table has been altered.
  Calling ioctl() to re-read partition table.
  Syncing disks.

sudo fdisk -l /dev/sdb
  Disk /dev/sdb: 500 MiB, 524288000 bytes, 1024000 sectors
  Disk model: VIRTUAL-DISK    
  Units: sectors of 1 * 512 = 512 bytes
  Sector size (logical/physical): 512 bytes / 512 bytes
  I/O size (minimum/optimal): 512 bytes / 512 bytes
  Disklabel type: dos
  Disk identifier: 0x0f7ae951

  Device     Boot Start     End Sectors  Size Id Type
  /dev/sdb1        2048 1023999 1021952  499M 83 Linux
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;formateandolo-a-ext4&quot;&gt;Formateandolo a &lt;strong&gt;ext4&lt;/strong&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo mkfs.ext4 /dev/sdb1
  mke2fs 1.44.5 (15-Dec-2018)
  Creating filesystem with 510976 1k blocks and 128016 inodes
  Filesystem UUID: b7296407-b693-45c3-9d26-163e4aba760c
  Superblock backups stored on blocks: 
  	8193, 24577, 40961, 57345, 73729, 204801, 221185, 401409

  Allocating group tables: done
  Writing inode tables: done
  Creating journal (8192 blocks): done
  Writing superblocks and filesystem accounting information: done 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;montandolo-en-mnt&quot;&gt;Montandolo en /mnt&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo mount /dev/sdb1 /mnt

lsblk -f
  NAME   FSTYPE LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINT
  sda                                                                     
  ├─sda1 ext4         b9ffc3d1-86b2-4a2c-a8be-f2b2f4aa4cb5   16.2G     7% /
  ├─sda2                                                                  
  └─sda5 swap         f8f6d279-1b63-4310-a668-cb468c9091d8                [SWAP]
  sdb                                                                     
  └─sdb1 ext4         b7296407-b693-45c3-9d26-163e4aba760c    444M     0% /mnt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Como podemos ver, el disco nuevo que se ha asignado al cliente, lo podemos utilizar como cualquier otro de manear normal. Ahora el único problema que tenemos que si reiniciamos la máquina el disco se desmontaría y desaparecería de nuestra máquina, para que esto no ocurra vamos a configurar un automontaje en la Tarea 2.&lt;/p&gt;

&lt;h2 id=&quot;tarea-2&quot;&gt;Tarea 2&lt;/h2&gt;

&lt;p&gt;Vamos a utilizar systemd mount para que el target se monte automáticamente al arrancar el cliente.&lt;/p&gt;

&lt;p&gt;Para realizar el montaje automáticamente tenemos que crear una unidad de systemd para que se monte el disco de manera automática al inciar el equipo del cliente pero para que esto funcione, tenemos que configurar primero iSCSI para realice el &lt;strong&gt;login&lt;/strong&gt; de manera automática al iniciar el cliente.&lt;/p&gt;

&lt;p&gt;Para que realice la sesión con el Servidor tenemos que modificar el parámetro &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;node.startup = automatic&lt;/code&gt; en el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/iscsi/iscsid.conf&lt;/code&gt; o podemos ejecutar un comando para modificar dicho parámetro.&lt;/p&gt;

&lt;h6 id=&quot;ejecutamos-el-comando-para-poner-el-login-en-automático&quot;&gt;Ejecutamos el comando para poner el login en automático&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iscsiadm -m node -T iqn.2020-01.com:tg1 -o update -n node.startup -v automatic
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora que tenemos el autologin activado podemos crear la unidad de systemd y que monte el disco de manera automática. Vamos a crear un fichero en &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/systemd/system&lt;/code&gt;, y el fichero se tiene que llamar como el punto de montaje seguido de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.mount&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Nosotros vamos a montar el disco en &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/Disco1&lt;/code&gt; por lo tanto el fichero se deberá de llamar &lt;strong&gt;Disco1.mount&lt;/strong&gt;&lt;/p&gt;

&lt;h6 id=&quot;creamos-el-directorio-y-el-fichero&quot;&gt;Creamos el directorio y el fichero&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo mkdir /Disco1
sudo nano /etc/systemd/system/Disco1.mount
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Dentro del fichero vamos a definir la unidad, el punto de montaje y el tipo.&lt;/p&gt;

&lt;h6 id=&quot;añadimos-las-siguiente-lineas-al-fichero-etcsystemdsystemdisco1mount&quot;&gt;Añadimos las siguiente lineas al fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/systemd/system/Disco1.mount&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[Unit]
Description=Montaje de Disco1

[Mount]
What=/dev/sdb1
Where=/Disco1
Type=ext4
Options=_netdev

[Install]
WantedBy=multi-user.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;Description&lt;/strong&gt;: Descripción de la utilidad de la unidad.&lt;/p&gt;

  &lt;p&gt;&lt;strong&gt;What&lt;/strong&gt;: La partición que queremos montar &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/dev/sdb1&lt;/code&gt;.&lt;/p&gt;

  &lt;p&gt;&lt;strong&gt;Where&lt;/strong&gt;: La ruta donde queremos montar la partición, en nuestro caso &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/Disco1&lt;/code&gt;.&lt;/p&gt;

  &lt;p&gt;&lt;strong&gt;Type&lt;/strong&gt;: Le indicamos que el sistema de fichero es ext4 como la partición &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/dev/sdb1&lt;/code&gt;.&lt;/p&gt;

  &lt;p&gt;&lt;strong&gt;Options&lt;/strong&gt;: Le índicamos que inicie la unidad de montaje después de que la red este disponible con &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_netdev&lt;/code&gt;..&lt;/p&gt;

  &lt;p&gt;&lt;strong&gt;WantedBy&lt;/strong&gt;: Define el estado del sistema de nivel 2.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Ahora solo nos queda reiniciar el daemon de systemd para que detecte los nuevos cambios y detecte la nueva unidad de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.mount&lt;/code&gt;.&lt;/p&gt;

&lt;h6 id=&quot;reiniciamos-el-demonio&quot;&gt;Reiniciamos el demonio&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl daemon-reload 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Iniciamos la unidad creada de Disco1.mount y la habilitamos para que inicie automáticamente al inicio del sistema.&lt;/p&gt;

&lt;h6 id=&quot;iniciamos-y-habilitar-la-unidad-disco1mount&quot;&gt;Iniciamos y habilitar la unidad &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Disco1.mount&lt;/code&gt;&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl start Disco1.mount
sudo systemctl enable Disco1.mount
  Created symlink /etc/systemd/system/multi-user.target.wants/Disco1.mount → /etc/systemd/system/Disco1.mount.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora comprobamos que al reinciar el cliente se nos monta de manera automática en &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Disco1&lt;/code&gt;.&lt;/p&gt;

&lt;h6 id=&quot;comprobamación&quot;&gt;Comprobamación&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vagrant@Cliente1:~$ sudo reboot
  Connection to 127.0.0.1 closed by remote host.
  Connection to 127.0.0.1 closed.

moralg@padano:~/Vagrant/iSCSI$ vagrant ssh cliente1 
  Linux Cliente1 4.19.0-6-amd64 #1 SMP Debian 4.19.67-2+deb10u2 (2019-11-11) x86_64

  The programs included with the Debian GNU/Linux system are free software;
  the exact distribution terms for each program are described in the
  individual files in /usr/share/doc/*/copyright.

  Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
  permitted by applicable law.
  Last login: Sun Feb  2 18:52:38 2020 from 10.0.2.2

vagrant@Cliente1:~$ lsblk -l
  NAME MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
  sda    8:0    0 19.8G  0 disk 
  sda1   8:1    0 18.8G  0 part /
  sda2   8:2    0    1K  0 part 
  sda5   8:5    0 1021M  0 part [SWAP]
  sdb    8:16   0  500M  0 disk 
  sdb1   8:17   0  499M  0 part /Disco1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;tarea-3&quot;&gt;Tarea 3&lt;/h2&gt;

&lt;p&gt;Crearemos un target con 2 LUN y autenticación por CHAP y la conectaremos a un cliente windows. ¿Cómo se escanea la red en windows y cómo se utilizan las unidades nuevas (formateándolas con NTFS)?&lt;/p&gt;

&lt;p&gt;Ahora vamos a definir los volúmenes físicos &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sdc&lt;/code&gt; y &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sdd&lt;/code&gt;, crearemos el grupo de volúmenes &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;vgCliente2&lt;/code&gt; y por último crearemos el volumen lógico de 1GB y otro de 500MV para crear los 2 LUN.&lt;/p&gt;

&lt;h6 id=&quot;definiendo-el-volumen-físico-1&quot;&gt;Definiendo el volumen físico&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo pvcreate /dev/sdc /dev/sdd
  Physical volume &quot;/dev/sdc&quot; successfully created.
  Physical volume &quot;/dev/sdd&quot; successfully created.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;creando-el-grupo-de-volúmenes-1&quot;&gt;Creando el grupo de volúmenes&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo vgcreate vgCliente2 /dev/sdc /dev/sdd
  Volume group &quot;vgCliente2&quot; successfully created
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;creando-los-volúmenes-lógico&quot;&gt;Creando los volúmenes lógico&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo lvcreate -L 500M -n lv2 vgCliente2
  Logical volume &quot;lv2&quot; created.

sudo lvcreate -L 1G -n lv3 vgCliente2
  Logical volume &quot;lv3&quot; created.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;comprobamos-que-se-ha-creado-correctamente-1&quot;&gt;Comprobamos que se ha creado correctamente&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo lvs
  LV   VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  lv1  vgCliente1 -wi-ao---- 500.00m                                                    
  lv2  vgCliente2 -wi-a----- 500.00m                                                    
  lv3  vgCliente2 -wi-a-----   1.00g                                                    

sudo lvdisplay
  --- Logical volume ---
  LV Path                /dev/vgCliente2/lv2
  LV Name                lv2
  VG Name                vgCliente2
  LV UUID                pIM3VO-oUwc-AOVO-uwS6-FYlW-tX5T-g7FGPa
  LV Write Access        read/write
  LV Creation host, time Servidor1, 2020-02-02 20:00:35 +0000
  LV Status              available
  # open                 0
  LV Size                500.00 MiB
  Current LE             125
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           254:1
   
  --- Logical volume ---
  LV Path                /dev/vgCliente2/lv3
  LV Name                lv3
  VG Name                vgCliente2
  LV UUID                d59SdU-rhC5-D9mS-6Os4-UVwi-zThl-CwHqxZ
  LV Write Access        read/write
  LV Creation host, time Servidor1, 2020-02-02 20:00:49 +0000
  LV Status              available
  # open                 0
  LV Size                1.00 GiB
  Current LE             256
  Segments               2
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           254:2
   
  --- Logical volume ---
  LV Path                /dev/vgCliente1/lv1
  LV Name                lv1
  VG Name                vgCliente1
  LV UUID                xR20wc-5YFN-af3g-UQGD-LH6Y-MoUL-3F7H2G
  LV Write Access        read/write
  LV Creation host, time Servidor1, 2020-02-01 12:30:02 +0000
  LV Status              available
  # open                 1
  LV Size                500.00 MiB
  Current LE             125
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           254:0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora tenemmos que crear el target con usuario y contraseña en &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;incominguser&lt;/code&gt;, que se configura el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/tgt/targets.conf&lt;/code&gt; con la siguiente configuración:&lt;/p&gt;

&lt;h6 id=&quot;creamos-el-target-con-los-dos-lum&quot;&gt;Creamos el target con los dos LUM&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;target iqn.2020-01.com:tg2&amp;gt;
    backing-store /dev/vgCliente2/lv2
    backing-store /dev/vgCliente2/lv3
    incominguser usuario1 UsuarioPassSec
&amp;lt;/target&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;NOTA: La contraseña debe de tener entre 12 y 16 caracteres para que no se error.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Tenemos que reiniciar el servicio de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tgt&lt;/code&gt; para que reconzca la modificación del fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/tgt/targets.conf&lt;/code&gt;&lt;/p&gt;

&lt;h6 id=&quot;reiniciamos-el-servicio-2&quot;&gt;Reiniciamos el servicio&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl restart tgt.service 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;comprobamos-que-se-ha-creado-correctamente-2&quot;&gt;Comprobamos que se ha creado correctamente&lt;/h6&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo tgtadm --mode target --op show | egrep -A 50 &quot;iqn.2020-01.com:tg2&quot;
Target 2: iqn.2020-01.com:tg2
    System information:
        Driver: iscsi
        State: ready
    I_T nexus information:
    LUN information:
        LUN: 0
            Type: controller
            SCSI ID: IET     00020000
            SCSI SN: beaf20
            Size: 0 MB, Block size: 1
            Online: Yes
            Removable media: No
            Prevent removal: No
            Readonly: No
            SWP: No
            Thin-provisioning: No
            Backing store type: null
            Backing store path: None
            Backing store flags: 
        LUN: 1
            Type: disk
            SCSI ID: IET     00020001
            SCSI SN: beaf21
            Size: 524 MB, Block size: 512
            Online: Yes
            Removable media: No
            Prevent removal: No
            Readonly: No
            SWP: No
            Thin-provisioning: No
            Backing store type: rdwr
            Backing store path: /dev/vgCliente2/lv2
            Backing store flags: 
        LUN: 2
            Type: disk
            SCSI ID: IET     00020002
            SCSI SN: beaf22
            Size: 1074 MB, Block size: 512
            Online: Yes
            Removable media: No
            Prevent removal: No
            Readonly: No
            SWP: No
            Thin-provisioning: No
            Backing store type: rdwr
            Backing store path: /dev/vgCliente2/lv3
            Backing store flags: 
    Account information:
        usuario1
    ACL information:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora vamos a iniciar el segundo target creado en una máquina Window, para realizar esto vamos abrir el &lt;strong&gt;Iniciador iSCSI&lt;/strong&gt;.&lt;/p&gt;

&lt;h6 id=&quot;abrimos-el-iniciador-iscsi&quot;&gt;Abrimos el Iniciador iSCSI&lt;/h6&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/blob/master/image/Tarea1.1_iSCSI.png?raw=true&quot; alt=&quot;Tarea1.1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;En la pestaña &lt;strong&gt;Detección&lt;/strong&gt; vamos a seleccionar en &lt;strong&gt;Detectar portal..&lt;/strong&gt; e indicamos la dirección de nuestro servidor y el puerto.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/blob/master/image/Tarea1.2_iSCSI.png?raw=true&quot; alt=&quot;Tarea1.2&quot; /&gt;&lt;/p&gt;

&lt;h6 id=&quot;detectamos-el-servidor&quot;&gt;Detectamos el Servidor&lt;/h6&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/blob/master/image/Tarea1.3_iSCSI.png?raw=true&quot; alt=&quot;Tarea1.3&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Si no ha salido ningun mensaje, es que ha dectectado el Servidor y si vamos a la pestaña &lt;strong&gt;Destino&lt;/strong&gt; nos saldrá los target disponibles.&lt;/p&gt;

&lt;h6 id=&quot;vemos-los-target-disponibles&quot;&gt;Vemos los target disponibles&lt;/h6&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/blob/master/image/Tarea1.4_iSCSI.png?raw=true&quot; alt=&quot;Tarea1.4&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Nos sale que el target &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;iqn.2020-01.com:tg2&lt;/code&gt; esta incativo, para activarlo tenemos que darle a &lt;strong&gt;Conectar&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;Nos saltará una ventana donde antes de darle a &lt;strong&gt;Aceptar&lt;/strong&gt; vamos a Activar el inicio de sesión CHAP dandole a &lt;strong&gt;Opciones Avanzadas…&lt;/strong&gt;.&lt;/p&gt;

&lt;h6 id=&quot;seleccionamos-opciones-avazadas&quot;&gt;Seleccionamos opciones avazadas&lt;/h6&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/blob/master/image/Tarea1.5_iSCSI.png?raw=true&quot; alt=&quot;Tarea1.5&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Activamos el inicio de sesion CHAP y ponemos el usuario y contraseña, los mismo que asignamos en la creación del target.&lt;/p&gt;

&lt;h6 id=&quot;habilitamos-el-inicio-de-chap-y-introducciomos-el-usuario-y-contraseña&quot;&gt;Habilitamos el inicio de CHAP y introducciomos el usuario y contraseña&lt;/h6&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/blob/master/image/Tarea1.6_iSCSI.png?raw=true&quot; alt=&quot;Tarea1.6&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Ahora al darle a &lt;strong&gt;Aceptar&lt;/strong&gt; nos saldrá en estado &lt;strong&gt;Conectado&lt;/strong&gt;.&lt;/p&gt;

&lt;h6 id=&quot;comprobamos-que-esta-conectado&quot;&gt;Comprobamos que esta conectado&lt;/h6&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/blob/master/image/Tarea1.7_iSCSI.png?raw=true&quot; alt=&quot;Tarea1.7&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Ahora ya tenemos los discos asignado y disponibles para inicializarlos y formatearlos a NTFS. Para hacer esto vamos a abrir &lt;strong&gt;Administración de discos&lt;/strong&gt;&lt;/p&gt;

&lt;h6 id=&quot;abrimos-el-administración-de-discos&quot;&gt;Abrimos el administración de discos&lt;/h6&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/blob/master/image/Tarea1.8_iSCSI.png?raw=true&quot; alt=&quot;Tarea1.8&quot; /&gt;&lt;/p&gt;

&lt;h6 id=&quot;inicializamos-los-discos&quot;&gt;Inicializamos los discos&lt;/h6&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/blob/master/image/Tarea1.9_iSCSI.png?raw=true&quot; alt=&quot;Tarea1.9&quot; /&gt;&lt;/p&gt;

&lt;h6 id=&quot;formateamos-los-discos-a-ntfs&quot;&gt;Formateamos los discos a NTFS&lt;/h6&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/blob/master/image/Tarea10_iSCSI.png?raw=true&quot; alt=&quot;Tarea1.10&quot; /&gt;
&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/blob/master/image/Tarea1.11_iSCSI.png?raw=true&quot; alt=&quot;Tarea1.11&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Comprobamos que nos salen montados y podemos utilizarlos de manera normal.&lt;/p&gt;

&lt;h6 id=&quot;comprobamos-que-aparecen-montados&quot;&gt;Comprobamos que aparecen montados&lt;/h6&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/blob/master/image/Tarea1.12_iSCSI.png?raw=true&quot; alt=&quot;Tarea1.12&quot; /&gt;&lt;/p&gt;

&lt;h6 id=&quot;creamos-un-fichero&quot;&gt;Creamos un fichero&lt;/h6&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Trabajando_con_iSCSI/blob/master/image/Tarea1.13_iSCSI.png?raw=true&quot; alt=&quot;Tarea1.13&quot; /&gt;&lt;/p&gt;</content><author><name>DavidDarnes</name></author><category term="Sistemas" /><summary type="html">Vamos a configurar un sistema que exporte algunos targets por iSCSI y los conecte a diversos clientes.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/Portada1.png/assets/default-social-image.png" /><media:content medium="image" url="/assets/Portada1.png/assets/default-social-image.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Cortafuego Perimetral con DMZ</title><link href="/assets/Portada1.png/seguridad/2020/01/12/Cortafuego_Perimetral_con_DMZ/" rel="alternate" type="text/html" title="Cortafuego Perimetral con DMZ" /><published>2020-01-12T00:00:00+00:00</published><updated>2020-01-12T00:00:00+00:00</updated><id>/assets/Portada1.png/seguridad/2020/01/12/Cortafuego_Perimetral_con_DMZ</id><content type="html" xml:base="/assets/Portada1.png/seguridad/2020/01/12/Cortafuego_Perimetral_con_DMZ/">&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Cortafuego_Perimetral_con_DMZ/blob/master/image/DMZ.png?raw=true&quot; alt=&quot;iSCSI&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Trabajamos mejorando un cortafuego perimetral tradicional, para que sea mas seguro y añadiendo un equipo que haga de DMZ.&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;esquema-de-red&quot;&gt;Esquema de red&lt;/h2&gt;
&lt;hr /&gt;
&lt;p&gt;Vamos a utilizar tres máquinas en openstack, que vamos a crear con la receta heat: escenario3.yaml. La receta heat ha deshabilitado el cortafuego que nos ofrece openstack (todos los puertos de todos los protocolos están abiertos). Una máquina (que tiene asignada una IP flotante) hará de cortafuegos, otra será una máquina de la red interna 192.168.100.0/24 y la tercera será un servidor en la DMZ donde iremos instalando distintos servicios y estará en la red 192.168.200.0/24.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Cortafuego_Perimetral_con_DMZ/blob/master/image/Tarea1.1_DMZ.png?raw=true&quot; alt=&quot;Tarea1.1&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;cumplimientos&quot;&gt;Cumplimientos&lt;/h2&gt;
&lt;hr /&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;h4 id=&quot;política-por-defecto-drop-para-las-cadenas-input-forward-y-output&quot;&gt;Política por defecto DROP para las cadenas INPUT, FORWARD y OUTPUT.&lt;/h4&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Limpiamos las tablas.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -F
sudo iptables -t nat -F
sudo iptables -Z
sudo iptables -t nat -Z
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Conexión ssh antes de estableces la politica por defecto en Drop para no perder la coonexión.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A INPUT -s 172.22.0.0/16 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A OUTPUT -d 172.22.0.0/16 -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT

sudo iptables -A INPUT -s 172.23.0.0/16 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A OUTPUT -d 172.23.0.0/16 -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT

sudo iptables -A OUTPUT -p tcp -o eth1 -d 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A INPUT -p tcp -i eth1 -s 192.168.100.0/24 --sport 22 -m state --state ESTABLISHED -j ACCEPT

sudo iptables -A OUTPUT -p tcp -o eth2 -d 192.168.200.0/24 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A INPUT -p tcp -i eth2 -s 192.168.200.0/24 --sport 22 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Establecemos la política.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -P INPUT DROP
sudo iptables -P OUTPUT DROP
sudo iptables -P FORWARD DROP
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;Se pueden usar las extensiones que queremos adecuadas, pero al menos debe implementarse seguimiento de la conexión.&lt;/li&gt;
  &lt;li&gt;Debes indicar pruebas de funcionamiento de todos las reglas.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;tareas&quot;&gt;Tareas&lt;/h2&gt;
&lt;hr /&gt;

&lt;h3 id=&quot;tarea-1-la-máquina-router-fw-tiene-un-servidor-ssh-escuchando-por-el-puerto-22-pero-al-acceder-desde-el-exterior-habrá-que-conectar-al-puerto-2222&quot;&gt;Tarea 1. La máquina router-fw tiene un servidor ssh escuchando por el puerto 22, pero al acceder desde el exterior habrá que conectar al puerto 2222.&lt;/h3&gt;

&lt;h5 id=&quot;reglas&quot;&gt;Reglas&lt;/h5&gt;

&lt;p&gt;Hay que activar el ‘ip_forward’&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo su
echo 1 &amp;gt; /proc/sys/net/ipv4/ip_forward
exit
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Configuramos la redirecion del puerto 2222 al 22&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -t nat -I PREROUTING -p tcp -s 172.22.0.0/16 --dport 2222 -j REDIRECT --to-ports 22

sudo iptables -t nat -I PREROUTING -p tcp -s 172.23.0.0/16 --dport 2222 -j REDIRECT --to-ports 22
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Configuramos la regla para que se pueda hacer conexión desde el puerto 2222&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A INPUT -s 172.22.0.0/16 -p tcp -m tcp --dport 2222 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A OUTPUT -d 172.22.0.0/16 -p tcp -m tcp --sport 2222 -m state --state ESTABLISHED -j ACCEPT

sudo iptables -A INPUT -s 172.23.0.0/16 -p tcp -m tcp --dport 2222 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A OUTPUT -d 172.23.0.0/16 -p tcp -m tcp --sport 2222 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Bloquemos la conexión desde el puerto 22 redirigiendola al Loopback para que se pierda&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -t nat -I PREROUTING -p tcp -s 172.22.0.0/16 --dport 22 --jump DNAT --to-destination 127.0.0.1

sudo iptables -t nat -I PREROUTING -p tcp -s 172.23.0.0/16 --dport 22 --jump DNAT --to-destination 127.0.0.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;comprobación&quot;&gt;Comprobación&lt;/h5&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;moralg@padano:~$ ssh -A -p 2222 debian@172.22.200.145
    @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
    @    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
    @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
    IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
    Someone could be eavesdropping on you right now (man-in-the-middle attack)!
    It is also possible that a host key has just been changed.
    The fingerprint for the ECDSA key sent by the remote host is
    SHA256:fnmA6k3OIDwXzXVMgrL3g+JjSjlmzRTU0Ou2xYwDdaE.
    Please contact your system administrator.
    Add correct host key in /home/moralg/.ssh/known_hosts to get rid of this message.
    Offending ECDSA key in /home/moralg/.ssh/known_hosts:40
      remove with:
      ssh-keygen -f &quot;/home/moralg/.ssh/known_hosts&quot; -R &quot;[172.22.200.145]:2222&quot;
    ECDSA host key for [172.22.200.145]:2222 has changed and you have requested strict  checking.
    Host key verification failed.

moralg@padano:~$   ssh-keygen -f &quot;/home/moralg/.ssh/known_hosts&quot; -R &quot;[172.22.200.145]   :2222&quot;
    # Host [172.22.200.145]:2222 found: line 40
    /home/moralg/.ssh/known_hosts updated.
    Original contents retained as /home/moralg/.ssh/known_hosts.old
    moralg@padano:~$ ssh -A -p 2222 debian@172.22.200.145
    Linux router-fw 4.19.0-6-cloud-amd64 #1 SMP Debian 4.19.67-2+deb10u1 (2019-09-20)   x86_64

    The programs included with the Debian GNU/Linux system are free software;
    the exact distribution terms for each program are described in the
    individual files in /usr/share/doc/*/copyright.

    Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
    permitted by applicable law.
    Last login: Fri Dec 13 10:02:20 2019 from 172.22.1.248

debian@router-fw:~$ exit

moralg@padano:~$ ssh -A -p 22 debian@172.22.200.145
    ssh: connect to host 172.22.200.145 port 22: Connection timed out
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;tarea-2-desde-la-lan-y-la-dmz-se-debe-permitir-la-conexión-ssh-por-el-puerto-22-al-la-máquina-router-fw&quot;&gt;Tarea 2. Desde la LAN y la DMZ se debe permitir la conexión ssh por el puerto 22 al la máquina router-fw.&lt;/h3&gt;

&lt;h5 id=&quot;reglas-1&quot;&gt;Reglas&lt;/h5&gt;

&lt;p&gt;LAN&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A INPUT -s 192.168.100.10/24 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A OUTPUT -d 192.168.100.10/24 -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;DMZ&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A INPUT -s 192.168.200.10/16 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A OUTPUT -d 192.168.200.10/16 -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;comprobación-1&quot;&gt;Comprobación&lt;/h5&gt;

&lt;p&gt;LAN&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@router-fw:~$ ssh -A debian@192.168.100.10
    Linux lan 4.19.0-6-cloud-amd64 #1 SMP Debian 4.19.67-2+deb10u1 (2019-09-20) x86_64

    The programs included with the Debian GNU/Linux system are free software;
    the exact distribution terms for each program are described in the
    individual files in /usr/share/doc/*/copyright.

    Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
    permitted by applicable law.
    Last login: Fri Dec 13 11:53:58 2019 from 192.168.100.2

debian@lan:~$ ssh debian@192.168.100.2
    The authenticity of host '192.168.100.2 (192.168.100.2)' can't be established.
    ECDSA key fingerprint is SHA256:fnmA6k3OIDwXzXVMgrL3g+JjSjlmzRTU0Ou2xYwDdaE.
    Are you sure you want to continue connecting (yes/no)? yes
    Warning: Permanently added '192.168.100.2' (ECDSA) to the list of known hosts.
    Linux router-fw 4.19.0-6-cloud-amd64 #1 SMP Debian 4.19.67-2+deb10u1 (2019-09-20)   x86_64

    The programs included with the Debian GNU/Linux system are free software;
    the exact distribution terms for each program are described in the
    individual files in /usr/share/doc/*/copyright.

    Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
    permitted by applicable law.
    Last login: Fri Dec 13 12:01:34 2019 from 172.22.1.248

debian@router-fw:~$ exit
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;DMZ&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@router-fw:~$ ssh -A debian@192.168.200.10
    Linux dmz 4.19.0-6-cloud-amd64 #1 SMP Debian 4.19.67-2+deb10u1 (2019-09-20) x86_64

    The programs included with the Debian GNU/Linux system are free software;
    the exact distribution terms for each program are described in the
    individual files in /usr/share/doc/*/copyright.

    Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
    permitted by applicable law.
    Last login: Fri Dec 13 11:23:14 2019 from 192.168.200.2

debian@dmz:~$ ssh debian@192.168.200.2
    The authenticity of host '192.168.200.2 (192.168.200.2)' can't be established.
    ECDSA key fingerprint is SHA256:fnmA6k3OIDwXzXVMgrL3g+JjSjlmzRTU0Ou2xYwDdaE.
    Are you sure you want to continue connecting (yes/no)? yes
    Warning: Permanently added '192.168.200.2' (ECDSA) to the list of known hosts.
    Linux router-fw 4.19.0-6-cloud-amd64 #1 SMP Debian 4.19.67-2+deb10u1 (2019-09-20)   x86_64

    The programs included with the Debian GNU/Linux system are free software;
    the exact distribution terms for each program are described in the
    individual files in /usr/share/doc/*/copyright.

    Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
    permitted by applicable law.
    Last login: Fri Dec 13 12:02:10 2019 from 192.168.100.10

debian@router-fw:~$ exit
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;tarea-3-la-máquina-router-fw-debe-tener-permitido-el-tráfico-para-la-interfaz-loopback&quot;&gt;Tarea 3. La máquina router-fw debe tener permitido el tráfico para la interfaz loopback.&lt;/h3&gt;

&lt;h5 id=&quot;reglas-2&quot;&gt;Reglas&lt;/h5&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A INPUT -i lo -p icmp -j ACCEPT
sudo iptables -A OUTPUT -o lo -p icmp -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;comprobación-2&quot;&gt;Comprobación&lt;/h5&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@router-fw:~$ ping 127.0.0.1
    PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
    ping: sendmsg: Operation not permitted
    ping: sendmsg: Operation not permitted
    ^Lping: sendmsg: Operation not permitted
    ping: sendmsg: Operation not permitted
    ping: sendmsg: Operation not permitted
    ^C
    --- 127.0.0.1 ping statistics ---
    5 packets transmitted, 0 received, 100% packet loss, time 105ms

debian@router-fw:~$ sudo iptables -A INPUT -i lo -p icmp -j ACCEPT
debian@router-fw:~$ sudo iptables -A OUTPUT -o lo -p icmp -j ACCEPT

debian@router-fw:~$ ping 127.0.0.1
    PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
    64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.050 ms
    64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.048 ms
    64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.074 ms
    64 bytes from 127.0.0.1: icmp_seq=4 ttl=64 time=0.064 ms
    ^C
    --- 127.0.0.1 ping statistics ---
    4 packets transmitted, 4 received, 0% packet loss, time 77ms
    rtt min/avg/max/mdev = 0.048/0.059/0.074/0.010 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;tarea-4-a-la-máquina-router-fw-se-le-puede-hacer-ping-desde-la-dmz-pero-desde-la-lan-se-le-debe-rechazar-la-conexión-reject&quot;&gt;Tarea 4. A la máquina router-fw se le puede hacer ping desde la DMZ, pero desde la LAN se le debe rechazar la conexión (REJECT).&lt;/h3&gt;

&lt;h5 id=&quot;reglas-3&quot;&gt;Reglas&lt;/h5&gt;

&lt;p&gt;LAN&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A INPUT -i eth1 -s 192.168.100.0/24 -p icmp -m icmp --icmp-type echo-request -j REJECT --reject-with icmp-port-unreachable
sudo iptables -A OUTPUT -o eth1 -d 192.168.100.0/24 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT
sudo iptables -A OUTPUT -o eth1 -d 192.168.100.0/24 -p icmp -m state --state RELATED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;DMZ&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A INPUT -i eth2 -s 192.168.200.0/24 -p icmp -m icmp --icmp-type echo-request -j ACCEPT
sudo iptables -A OUTPUT -o eth2 -d 192.168.200.0/24 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;comprobación-3&quot;&gt;Comprobación&lt;/h5&gt;
&lt;p&gt;LAN&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@lan:~$ ping 192.168.100.2
    PING 192.168.100.2 (192.168.100.2) 56(84) bytes of data.
    From 192.168.100.2 icmp_seq=1 Destination Port Unreachable
    From 192.168.100.2 icmp_seq=2 Destination Port Unreachable
    From 192.168.100.2 icmp_seq=3 Destination Port Unreachable
    From 192.168.100.2 icmp_seq=4 Destination Port Unreachable
    From 192.168.100.2 icmp_seq=5 Destination Port Unreachable
    ^C
    --- 192.168.100.2 ping statistics ---
    5 packets transmitted, 0 received, +5 errors, 100% packet loss, time 16ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;DMZ&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@dmz:~$ ping 192.168.200.2
    PING 192.168.200.2 (192.168.200.2) 56(84) bytes of data.
    64 bytes from 192.168.200.2: icmp_seq=1 ttl=64 time=0.896 ms
    64 bytes from 192.168.200.2: icmp_seq=2 ttl=64 time=1.12 ms
    64 bytes from 192.168.200.2: icmp_seq=3 ttl=64 time=1.08 ms
    64 bytes from 192.168.200.2: icmp_seq=4 ttl=64 time=1.15 ms
    64 bytes from 192.168.200.2: icmp_seq=5 ttl=64 time=1.11 ms
    ^C
    --- 192.168.200.2 ping statistics ---
    5 packets transmitted, 5 received, 0% packet loss, time 10ms
    rtt min/avg/max/mdev = 0.896/1.070/1.145/0.098 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;tarea-5-la-máquina-router-fw-puede-hacer-ping-a-la-lan-la-dmz-y-al-exterior&quot;&gt;Tarea 5. La máquina router-fw puede hacer ping a la LAN, la DMZ y al exterior.&lt;/h3&gt;

&lt;h5 id=&quot;reglas-4&quot;&gt;Reglas&lt;/h5&gt;

&lt;p&gt;LAN&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A OUTPUT -o eth1 -d 192.168.100.0/24 -p icmp -m icmp --icmp-type echo-request -j ACCEPT
sudo iptables -A INPUT -i eth1 -s 192.168.100.0/24 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;DMZ&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A OUTPUT -o eth2 -d 192.168.200.0/24 -p icmp -m icmp --icmp-type echo-request -j ACCEPT
sudo iptables -A INPUT -i eth2 -s 192.168.200.0/24 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Exterior&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A OUTPUT -o eth0 -p icmp -m icmp --icmp-type echo-request -j ACCEPT
sudo iptables -A INPUT -i eth0 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;comprobación-4&quot;&gt;Comprobación&lt;/h5&gt;

&lt;p&gt;LAN&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@router-fw:~$ ping 192.168.100.10
    PING 192.168.100.10 (192.168.100.10) 56(84) bytes of data.
    64 bytes from 192.168.100.10: icmp_seq=1 ttl=64 time=1.02 ms
    64 bytes from 192.168.100.10: icmp_seq=2 ttl=64 time=0.857 ms
    64 bytes from 192.168.100.10: icmp_seq=3 ttl=64 time=0.802 ms
    64 bytes from 192.168.100.10: icmp_seq=4 ttl=64 time=0.696 ms
    64 bytes from 192.168.100.10: icmp_seq=5 ttl=64 time=0.791 ms
    ^C
    --- 192.168.100.10 ping statistics ---
    5 packets transmitted, 5 received, 0% packet loss, time 10ms
    rtt min/avg/max/mdev = 0.696/0.832/1.015/0.106 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;DMZ&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@router-fw:~$ ping 192.168.200.10
    PING 192.168.200.10 (192.168.200.10) 56(84) bytes of data.
    64 bytes from 192.168.200.10: icmp_seq=1 ttl=64 time=1.80 ms
    64 bytes from 192.168.200.10: icmp_seq=2 ttl=64 time=0.997 ms
    64 bytes from 192.168.200.10: icmp_seq=3 ttl=64 time=0.790 ms
    64 bytes from 192.168.200.10: icmp_seq=4 ttl=64 time=1.05 ms
    64 bytes from 192.168.200.10: icmp_seq=5 ttl=64 time=1.14 ms
    ^C
    --- 192.168.200.10 ping statistics ---
    5 packets transmitted, 5 received, 0% packet loss, time 10ms
    rtt min/avg/max/mdev = 0.790/1.154/1.801/0.344 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Exterior&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@router-fw:~$ ping 1.1.1.1
    PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data.
    64 bytes from 1.1.1.1: icmp_seq=1 ttl=55 time=41.4 ms
    64 bytes from 1.1.1.1: icmp_seq=2 ttl=55 time=41.0 ms
    64 bytes from 1.1.1.1: icmp_seq=3 ttl=55 time=41.9 ms
    64 bytes from 1.1.1.1: icmp_seq=4 ttl=55 time=42.1 ms
    64 bytes from 1.1.1.1: icmp_seq=5 ttl=55 time=42.10 ms
    ^C
    --- 1.1.1.1 ping statistics ---
    5 packets transmitted, 5 received, 0% packet loss, time 11ms
    rtt min/avg/max/mdev = 41.032/41.874/42.950/0.673 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;tarea-6-desde-la-máquina-dmz-se-puede-hacer-ping-y-conexión-ssh-a-la-máquina-lan&quot;&gt;Tarea 6. Desde la máquina DMZ se puede hacer ping y conexión ssh a la máquina LAN.&lt;/h3&gt;

&lt;h5 id=&quot;reglas-5&quot;&gt;Reglas&lt;/h5&gt;

&lt;p&gt;SSH&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A FORWARD -i eth2 -o eth1 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i eth1 -o eth2 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;PING&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A FORWARD -i eth2 -o eth1 -s 192.168.200.0/24 -p icmp -m icmp --icmp-type echo-request -j ACCEPT
sudo iptables -A FORWARD -i eth1 -o eth2 -d 192.168.200.0/24 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;comprobación-5&quot;&gt;Comprobación&lt;/h5&gt;
&lt;p&gt;SSH&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@dmz:~$ ssh 192.168.100.10
    The authenticity of host '192.168.100.10 (192.168.100.10)' can't be established.
    ECDSA key fingerprint is SHA256:YZMnTboVGppp2MCQN/Jz89AI3MR/Rx9pnQrB/R4jmJk.
    Are you sure you want to continue connecting (yes/no)? yes
    Warning: Permanently added '192.168.100.10' (ECDSA) to the list of known hosts.
    Linux lan 4.19.0-6-cloud-amd64 #1 SMP Debian 4.19.67-2+deb10u1 (2019-09-20) x86_64

    The programs included with the Debian GNU/Linux system are free software;
    the exact distribution terms for each program are described in the
    individual files in /usr/share/doc/*/copyright.

    Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
    permitted by applicable law.
    Last login: Tue Dec 31 16:44:04 2019 from 192.168.100.2

debian@lan:~$ exit
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;PING&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@dmz:~$ ping 192.168.100.10
    PING 192.168.100.10 (192.168.100.10) 56(84) bytes of data.
    64 bytes from 192.168.100.10: icmp_seq=1 ttl=63 time=1.62 ms
    64 bytes from 192.168.100.10: icmp_seq=2 ttl=63 time=1.49 ms
    64 bytes from 192.168.100.10: icmp_seq=3 ttl=63 time=1.87 ms
    64 bytes from 192.168.100.10: icmp_seq=4 ttl=63 time=1.59 ms
    64 bytes from 192.168.100.10: icmp_seq=5 ttl=63 time=1.47 ms
    ^C
    --- 192.168.100.10 ping statistics ---
    5 packets transmitted, 5 received, 0% packet loss, time 12ms
    rtt min/avg/max/mdev = 1.465/1.607/1.867/0.144 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;tarea-7-desde-la-máquina-lan-no-se-puede-hacer-ping-pero-si-se-puede-conectar-por-ssh-a-la-máquina-dmz&quot;&gt;Tarea 7. Desde la máquina LAN no se puede hacer ping, pero si se puede conectar por ssh a la máquina DMZ.&lt;/h3&gt;

&lt;h5 id=&quot;reglas-6&quot;&gt;Reglas&lt;/h5&gt;
&lt;p&gt;SSH&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A FORWARD -i eth1 -o eth2 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i eth2 -o eth1 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;PING&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;Por defecto esta en DROP&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h5 id=&quot;comprobación-6&quot;&gt;Comprobación&lt;/h5&gt;
&lt;p&gt;SSH&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@lan:~$ ssh 192.168.200.10
    The authenticity of host '192.168.200.10 (192.168.200.10)' can't be established.
    ECDSA key fingerprint is SHA256:HDhQ4dDIMfEt0p916tj987SZjuhmhqd+qEjGNLikwN8.
    Are you sure you want to continue connecting (yes/no)? yes
    Warning: Permanently added '192.168.200.10' (ECDSA) to the list of known hosts.
    Linux dmz 4.19.0-6-cloud-amd64 #1 SMP Debian 4.19.67-2+deb10u1 (2019-09-20) x86_64

    The programs included with the Debian GNU/Linux system are free software;
    the exact distribution terms for each program are described in the
    individual files in /usr/share/doc/*/copyright.

    Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
    permitted by applicable law.
    Last login: Tue Dec 31 16:46:29 2019 from 192.168.200.2

debian@dmz:~$ exit
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;PING&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@lan:~$ ping 192.168.200.10
    PING 192.168.200.10 (192.168.200.10) 56(84) bytes of data.
    ^C
    --- 192.168.200.10 ping statistics ---
    247 packets transmitted, 0 received, 100% packet loss, time 1150ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;tarea-8-configura-la-máquina-router-fw-para-que-las-máquinas-lan-y-dmz-puedan-acceder-al-exterior&quot;&gt;Tarea 8. Configura la máquina router-fw para que las máquinas LAN y DMZ puedan acceder al exterior.&lt;/h3&gt;

&lt;p&gt;Añadimos las reglas de SNAT para que las máquinas internas puedan acceder al exterior&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth0 -j MASQUERADE
sudo iptables -t nat -A POSTROUTING -s 192.168.200.0/24 -o eth0 -j MASQUERADE
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;tarea-9-la-máquina-lan-se-le-permite-hacer-ping-al-exterior&quot;&gt;Tarea 9. La máquina LAN se le permite hacer ping al exterior.&lt;/h3&gt;

&lt;h5 id=&quot;reglas-7&quot;&gt;Reglas&lt;/h5&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A FORWARD -i eth1 -o eth0 -p icmp -m icmp --icmp-type echo-request -j ACCEPT
sudo iptables -A FORWARD -i eth0 -o eth1 -p icmp -m icmp --icmp-type echo-reply -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;comprobación-7&quot;&gt;Comprobación&lt;/h5&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@lan:~$ ping 1.1.1.1
    PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data.
    64 bytes from 1.1.1.1: icmp_seq=1 ttl=54 time=42.6 ms
    64 bytes from 1.1.1.1: icmp_seq=2 ttl=54 time=41.10 ms
    64 bytes from 1.1.1.1: icmp_seq=3 ttl=54 time=68.3 ms
    64 bytes from 1.1.1.1: icmp_seq=4 ttl=54 time=66.2 ms
    64 bytes from 1.1.1.1: icmp_seq=5 ttl=54 time=43.0 ms
    ^C
    --- 1.1.1.1 ping statistics ---
    5 packets transmitted, 5 received, 0% packet loss, time 11ms
    rtt min/avg/max/mdev = 41.959/52.429/68.349/12.161 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;tarea-10-la-máquina-lan-puede-navegar&quot;&gt;Tarea 10. La máquina LAN puede navegar.&lt;/h3&gt;

&lt;h5 id=&quot;reglas-8&quot;&gt;Reglas&lt;/h5&gt;
&lt;p&gt;Activamos DNS&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A FORWARD -i eth1 -o eth0 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i eth0 -o eth1 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Activamos HTTP&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A FORWARD -i eth1 -o eth0 -p tcp -m multiport --dports 80 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i eth0 -o eth1 -p tcp -m multiport --sports 80 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Activamos HTTPS&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A FORWARD -i eth1 -o eth0 -p tcp -m multiport --dports 443 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i eth0 -o eth1 -p tcp -m multiport --sports 443 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;comprobación-8&quot;&gt;Comprobación&lt;/h5&gt;
&lt;p&gt;Descargamos un paquete&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@lan:~$ sudo apt install tree
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following NEW packages will be installed:
  tree
0 upgraded, 1 newly installed, 0 to remove and 37 not upgraded.
Need to get 49.3 kB of archives.
After this operation, 117 kB of additional disk space will be used.
Get:1 http://deb.debian.org/debian buster/main amd64 tree amd64 1.8.0-1 [49.3 kB]
Fetched 49.3 kB in 0s (247 kB/s)
Selecting previously unselected package tree.
(Reading database ... 26978 files and directories currently installed.)
Preparing to unpack .../tree_1.8.0-1_amd64.deb ...
Unpacking tree (1.8.0-1) ...
Setting up tree (1.8.0-1) ...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;tarea-11-la-máquina-dmz-puede-navegar-instala-un-servidor-web-un-servidor-ftp-y-un-servidor-de-correos&quot;&gt;Tarea 11. La máquina DMZ puede navegar. Instala un servidor web, un servidor ftp y un servidor de correos.&lt;/h3&gt;

&lt;h5 id=&quot;reglas-9&quot;&gt;Reglas&lt;/h5&gt;
&lt;p&gt;Activamos DNS&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A FORWARD -i eth2 -o eth0 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i eth0 -o eth2 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Activamos HTTP&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A FORWARD -i eth2 -o eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i eth0 -o eth2 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Activamos HTTPS&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A FORWARD -i eth2 -o eth0 -p tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i eth0 -o eth2 -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;comprobación-9&quot;&gt;Comprobación&lt;/h5&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@dmz:~$ sudo apt install apache2 postfix proftpd
    Reading package lists... Done
    Building dependency tree
    Reading state information... Done
    Note, selecting 'proftpd-basic' instead of 'proftpd'
    The following additional packages will be installed:
      apache2-bin apache2-data apache2-utils libapr1 libaprutil1 libaprutil1-dbd-sqlite3    libaprutil1-ldap
      libbrotli1 libcurl4 libgdbm-compat4 libgdbm6 libhiredis0.14 libjansson4   libldap-2.4-2 libldap-common
      liblua5.2-0 libmemcached11 libmemcachedutil2 libnghttp2-14 libperl5.28 librtmp1   libsasl2-2
      libsasl2-modules libsasl2-modules-db libssh2-1 perl perl-modules-5.28 proftpd-doc     ssl-cert
    Suggested packages:
      apache2-doc apache2-suexec-pristine | apache2-suexec-custom www-browser   libsasl2-modules-gssapi-mit
      | libsasl2-modules-gssapi-heimdal libsasl2-modules-ldap libsasl2-modules-otp  libsasl2-modules-sql
      perl-doc libterm-readline-gnu-perl | libterm-readline-perl-perl make libb-debug-perl
      liblocale-codes-perl procmail postfix-mysql postfix-pgsql postfix-ldap postfix-pcre   postfix-lmdb
      postfix-sqlite sasl2-bin | dovecot-common resolvconf postfix-cdb mail-reader ufw  postfix-doc
      openbsd-inetd | inet-superserver proftpd-mod-ldap proftpd-mod-mysql proftpd-mod-odbc
      proftpd-mod-pgsql proftpd-mod-sqlite proftpd-mod-geoip proftpd-mod-snmp   openssl-blacklist
    The following NEW packages will be installed:
      apache2 apache2-bin apache2-data apache2-utils libapr1 libaprutil1    libaprutil1-dbd-sqlite3
      libaprutil1-ldap libbrotli1 libcurl4 libgdbm-compat4 libgdbm6 libhiredis0.14  libjansson4
      libldap-2.4-2 libldap-common liblua5.2-0 libmemcached11 libmemcachedutil2     libnghttp2-14 libperl5.28
      librtmp1 libsasl2-2 libsasl2-modules libsasl2-modules-db libssh2-1 perl   perl-modules-5.28 postfix
      proftpd-basic proftpd-doc ssl-cert
    0 upgraded, 32 newly installed, 0 to remove and 0 not upgraded.
    Need to get 16.9 MB of archives.
    After this operation, 72.6 MB of additional disk space will be used.
Do you want to continue? [Y/n] y
    Get:3 http://deb.debian.org/debian buster/main amd64 perl-modules-5.28 all 5.28.1-6     [2,873 kB]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;tarea-12-configura-la-máquina-router-fw-para-que-los-servicios-web-y-ftp-sean-accesibles-desde-el-exterior&quot;&gt;Tarea 12. Configura la máquina router-fw para que los servicios web y ftp sean accesibles desde el exterior.&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;h3 id=&quot;próximamente&quot;&gt;Próximamente.&lt;/h3&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;tarea-13-el-servidor-web-y-el-servidor-ftp-deben-ser-accesible-desde-la-lan-y-desde-el-exterior&quot;&gt;Tarea 13. El servidor web y el servidor ftp deben ser accesible desde la LAN y desde el exterior.&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;h3 id=&quot;próximamente-1&quot;&gt;Próximamente.&lt;/h3&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;tarea-14-el-servidor-de-correos-sólo-debe-ser-accesible-desde-la-lan&quot;&gt;Tarea 14. El servidor de correos sólo debe ser accesible desde la LAN.&lt;/h3&gt;

&lt;p&gt;En la instalación elegimos &lt;em&gt;internet site&lt;/em&gt;.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;   ┌───────────────────────────────────┤ Postfix Configuration ├────────────────────────────────────┐
   │ Escoja el tipo de configuración del servidor de correo que se ajusta mejor a sus necesidades.  │
   │                                                                                                │
   │  Sin configuración:                                                                            │
   │   Mantiene la configuración actual intacta.                                                    │
   │  Sitio de Internet:                                                                            │
   │   El correo se envía y recibe directamente utilizando SMTP.                                    │
   │  Internet con «smarthost»:                                                                     │
   │   El correo se recibe directamente utilizando SMTP o ejecutando una                            │
   │   herramienta como «fetchmail». El correo de salida se envía utilizando                        │
   │   un «smarthost».                                                                              │
   │  Sólo correo local:                                                                            │
   │   El único correo que se entrega es para los usuarios locales. No                              │
   │   hay red.                                                                                     │
   │                                                                                                │
   │ Tipo genérico de configuración de correo:                                                      │
   │                                                                                                │
   │                                   Sin configuración                                            │
   │                            &amp;gt;&amp;gt;&amp;gt;&amp;gt;   Sitio de Internet                                            │
   │                                   Internet con «smarthost»                                     │
   │                                   Sistema satélite                                             │
   │                                   Sólo correo local                                            │
   │                                                                                                │
   │                                                                                                │
   │                           &amp;lt;Aceptar&amp;gt;                          &amp;lt;Cancelar&amp;gt;                        │
   │                                                                                                │
   └────────────────────────────────────────────────────────────────────────────────────────────────┘
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora vamos a especificar las redes permitidas por el servidor de correos en el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/postfix/main.cf&lt;/code&gt;, modificando las siguiente linea:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mynetworks = 127.0.0.0/8 192.168.100.0/24
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;reglas-10&quot;&gt;Reglas&lt;/h5&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A FORWARD -i eth1 -o eth2 -p tcp --dport 25 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i eth2 -o eth1 -p tcp --sport 25 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;comprobación-10&quot;&gt;Comprobación&lt;/h5&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@lan:~$ telnet 192.168.200.10 25
    Trying 192.168.200.10...
    Connected to 192.168.200.10.
    Escape character is '^]'.
    220 dmz.novalocal ESMTP Postfix (Debian/GNU)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;tarea-15-en-la-máquina-lan-instala-un-servidor-mysql-a-este-servidor-sólo-se-puede-acceder-desde-la-dmz&quot;&gt;Tarea 15. En la máquina LAN instala un servidor mysql. A este servidor sólo se puede acceder desde la DMZ.&lt;/h3&gt;

&lt;p&gt;Instalamos en la lan el servidor y en la dmz el cliente de mariadb.&lt;/p&gt;

&lt;p&gt;En la la LAN&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt install mariadb-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;En la DMZ&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt install mariadb-client
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Creamos en el servidor la una base de datos y un usuario, además le asignamos los permisos para que podamos acceder desde la DMZ&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB [(none)]&amp;gt; CREATE DATABASE prueba;
    Query OK, 1 row affected (0.001 sec)

MariaDB [(none)]&amp;gt; CREATE USER user_prueba@&quot;192.168.200.10&quot; IDENTIFIED BY &quot;user_prueba&quot;;
    Query OK, 0 rows affected (0.045 sec)

MariaDB [(none)]&amp;gt; GRANT ALL PRIVILEGES ON prueba.* to user_prueba IDENTIFIED BY &quot;user_prueba&quot;;
    Query OK, 0 rows affected (0.001 sec)

MariaDB [(none)]&amp;gt; FLUSH PRIVILEGES;
    Query OK, 0 rows affected (0.001 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Editamos el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/mysql/mariadb.conf.d/50-server.cnf&lt;/code&gt; y añadimos la siguiente linea:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bind-address            = 0.0.0.0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reiniciamos el sericio:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl restart mariadb.service 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;reglas-11&quot;&gt;Reglas&lt;/h5&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo iptables -A FORWARD -i eth2 -o eth1 -p tcp --dport 3306 -m state --state NEW,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i eth1 -o eth2 -p tcp --sport 3306 -m state --state ESTABLISHED -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;comprobación-11&quot;&gt;Comprobación&lt;/h5&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@dmz:~$ sudo mysql -u user_prueba -p prueba -h 192.168.100.10
Enter password: 
    Welcome to the MariaDB monitor.  Commands end with ; or \g.
    Your MariaDB connection id is 36
    Server version: 10.3.18-MariaDB-0+deb10u1 Debian 10

    Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

    Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [prueba]&amp;gt; use prueba
    Database changed
MariaDB [prueba]&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;mejoras&quot;&gt;Mejoras&lt;/h2&gt;
&lt;hr /&gt;

&lt;h4 id=&quot;mejora-1-implementar-que-el-cortafuego-funcione-después-de-un-reinicio-de-la-máquina&quot;&gt;MEJORA 1: Implementar que el cortafuego funcione después de un reinicio de la máquina.&lt;/h4&gt;

&lt;p&gt;Con &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root@router-fw:&lt;/code&gt; creamos el fichero &lt;em&gt;iptableSave.v4&lt;/em&gt; donde guardaremos todas la reglas de iptables que esten activas en el momento de ejecitar dicho comando.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;iptables-save &amp;gt; /etc/iproute2/iptableSave.v4
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@router-fw:~# cat /etc/iproute2/iptableSave.v4 
    # Generated by xtables-save v1.8.2 on Fri Jan  3 18:03:13 2020
    *filter
    :INPUT DROP [29:4732]
    :FORWARD DROP [0:0]
    :OUTPUT DROP [636:48678]
    -A INPUT -s 172.22.0.0/16 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED     -j ACCEPT
    -A INPUT -s 172.23.0.0/16 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED     -j ACCEPT
    -A INPUT -s 192.168.100.0/24 -i eth1 -p tcp -m tcp --sport 22 -m state --state  ESTABLISHED -j ACCEPT
    -A INPUT -s 192.168.200.0/24 -i eth2 -p tcp -m tcp --sport 22 -m state --state  ESTABLISHED -j ACCEPT
    -A INPUT -s 172.22.0.0/16 -p tcp -m tcp --dport 2222 -m state --state NEW,ESTABLISHED   -j ACCEPT
    -A INPUT -s 172.23.0.0/16 -p tcp -m tcp --dport 2222 -m state --state NEW,ESTABLISHED   -j ACCEPT
    -A INPUT -s 192.168.100.0/24 -p tcp -m tcp --dport 22 -m state --state NEW, ESTABLISHED -j ACCEPT
    -A INPUT -s 192.168.0.0/16 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED    -j ACCEPT
    -A INPUT -i lo -p icmp -j ACCEPT
    -A INPUT -s 192.168.100.0/24 -i eth1 -p icmp -m icmp --icmp-type 8 -j REJECT    --reject-with icmp-port-unreachable
    -A INPUT -s 192.168.200.0/24 -i eth2 -p icmp -m icmp --icmp-type 8 -j ACCEPT
    -A INPUT -s 192.168.100.0/24 -i eth1 -p icmp -m icmp --icmp-type 0 -j ACCEPT
    -A INPUT -s 192.168.200.0/24 -i eth2 -p icmp -m icmp --icmp-type 0 -j ACCEPT
    -A INPUT -i eth0 -p icmp -m icmp --icmp-type 0 -j ACCEPT
    -A FORWARD -i eth2 -o eth1 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED    -j ACCEPT
    -A FORWARD -i eth1 -o eth2 -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j     ACCEPT
    -A FORWARD -s 192.168.200.0/24 -i eth2 -o eth1 -p icmp -m icmp --icmp-type 8 -j ACCEPT
    -A FORWARD -d 192.168.200.0/24 -i eth1 -o eth2 -p icmp -m icmp --icmp-type 0 -j ACCEPT
    -A FORWARD -i eth1 -o eth2 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED    -j ACCEPT
    -A FORWARD -i eth2 -o eth1 -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j     ACCEPT
    -A FORWARD -i eth1 -o eth0 -p icmp -m icmp --icmp-type 8 -j ACCEPT
    -A FORWARD -i eth0 -o eth1 -p icmp -m icmp --icmp-type 0 -j ACCEPT
    -A FORWARD -i eth1 -o eth0 -p udp -m udp --dport 53 -m state --state NEW,ESTABLISHED    -j ACCEPT
    -A FORWARD -i eth0 -o eth1 -p udp -m udp --sport 53 -m state --state ESTABLISHED -j     ACCEPT
    -A FORWARD -i eth1 -o eth0 -p tcp -m multiport --dports 80 -m state --state NEW,    ESTABLISHED -j ACCEPT
    -A FORWARD -i eth0 -o eth1 -p tcp -m multiport --sports 80 -m state --state     ESTABLISHED -j ACCEPT
    -A FORWARD -i eth1 -o eth0 -p tcp -m multiport --dports 443 -m state --state NEW,   ESTABLISHED -j ACCEPT
    -A FORWARD -i eth0 -o eth1 -p tcp -m multiport --sports 443 -m state --state    ESTABLISHED -j ACCEPT
    -A FORWARD -i eth2 -o eth0 -p udp -m udp --dport 53 -m state --state NEW,ESTABLISHED    -j ACCEPT
    -A FORWARD -i eth0 -o eth2 -p udp -m udp --sport 53 -m state --state ESTABLISHED -j     ACCEPT
    -A FORWARD -i eth2 -o eth0 -p tcp -m tcp --dport 80 -m state --state NEW,ESTABLISHED    -j ACCEPT
    -A FORWARD -i eth0 -o eth2 -p tcp -m tcp --sport 80 -m state --state ESTABLISHED -j     ACCEPT
    -A FORWARD -i eth2 -o eth0 -p tcp -m tcp --dport 443 -m state --state NEW,ESTABLISHED   -j ACCEPT
    -A FORWARD -i eth0 -o eth2 -p tcp -m tcp --sport 443 -m state --state ESTABLISHED -j    ACCEPT
    -A FORWARD -i eth1 -o eth2 -p tcp -m tcp --dport 25 -m state --state NEW,ESTABLISHED    -j ACCEPT
    -A FORWARD -i eth2 -o eth1 -p tcp -m tcp --sport 25 -m state --state ESTABLISHED -j     ACCEPT
    -A FORWARD -i eth2 -o eth1 -p tcp -m tcp --dport 3306 -m state --state NEW, ESTABLISHED -j ACCEPT
    -A FORWARD -i eth1 -o eth2 -p tcp -m tcp --sport 3306 -m state --state ESTABLISHED -j   ACCEPT
    -A OUTPUT -d 172.22.0.0/16 -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j     ACCEPT
    -A OUTPUT -d 172.23.0.0/16 -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j     ACCEPT
    -A OUTPUT -d 192.168.100.0/24 -o eth1 -p tcp -m tcp --dport 22 -m state --state NEW,    ESTABLISHED -j ACCEPT
    -A OUTPUT -d 192.168.200.0/24 -o eth2 -p tcp -m tcp --dport 22 -m state --state NEW,    ESTABLISHED -j ACCEPT
    -A OUTPUT -d 172.22.0.0/16 -p tcp -m tcp --sport 2222 -m state --state ESTABLISHED -j   ACCEPT
    -A OUTPUT -d 172.23.0.0/16 -p tcp -m tcp --sport 2222 -m state --state ESTABLISHED -j   ACCEPT
    -A OUTPUT -d 192.168.100.0/24 -p tcp -m tcp --sport 22 -m state --state ESTABLISHED     -j ACCEPT
    -A OUTPUT -d 192.168.0.0/16 -p tcp -m tcp --sport 22 -m state --state ESTABLISHED -j    ACCEPT
    -A OUTPUT -o lo -p icmp -j ACCEPT
    -A OUTPUT -d 192.168.100.0/24 -o eth1 -p icmp -m icmp --icmp-type 0 -j ACCEPT
    -A OUTPUT -d 192.168.100.0/24 -o eth1 -p icmp -m state --state RELATED -j ACCEPT
    -A OUTPUT -d 192.168.200.0/24 -o eth2 -p icmp -m icmp --icmp-type 0 -j ACCEPT
    -A OUTPUT -d 192.168.100.0/24 -o eth1 -p icmp -m icmp --icmp-type 8 -j ACCEPT
    -A OUTPUT -d 192.168.200.0/24 -o eth2 -p icmp -m icmp --icmp-type 8 -j ACCEPT
    -A OUTPUT -o eth0 -p icmp -m icmp --icmp-type 8 -j ACCEPT
    COMMIT
    # Completed on Fri Jan  3 18:03:13 2020
    # Generated by xtables-save v1.8.2 on Fri Jan  3 18:03:13 2020
    *nat
    :PREROUTING ACCEPT [13:875]
    :INPUT ACCEPT [3:180]
    :POSTROUTING ACCEPT [6:580]
    :OUTPUT ACCEPT [625:47026]
    -A PREROUTING -s 172.23.0.0/16 -p tcp -m tcp --dport 22 -j DNAT --to-destination    127.0.0.1
    -A PREROUTING -s 172.22.0.0/16 -p tcp -m tcp --dport 22 -j DNAT --to-destination    127.0.0.1
    -A PREROUTING -s 172.23.0.0/16 -p tcp -m tcp --dport 2222 -j REDIRECT --to-ports 22
    -A PREROUTING -s 172.22.0.0/16 -p tcp -m tcp --dport 2222 -j REDIRECT --to-ports 22
    -A POSTROUTING -s 192.168.100.0/24 -o eth0 -j MASQUERADE
    -A POSTROUTING -s 192.168.200.0/24 -o eth0 -j MASQUERADE
    COMMIT
    # Completed on Fri Jan  3 18:03:13 2020
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Creamos la unidad de systemd, para esto, tenemos que crear el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/systemd/system/restart-iptables.service&lt;/code&gt; y añadir las siguientes lineas:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[Unit]
Description=restaurar las iptables
After=networking.service

[Service]
ExecStart=/usr/local/bin/restart-iptables.sh

[Install]
WantedBy=multi-user.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Creamos el script en la ruta indicada en el fichero de systemd &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/usr/local/bin/restart-iptables.sh&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#!/bin/bash
iptables-restore &amp;lt; /etc/iproute2/iptableSave.v4
echo &quot;Reglas de iptables restauradas&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Cambiamos los permisos del script:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;chmod 744 /usr/local/bin/restart-iptables.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Activamos el servicio para que siempre se active al inicio del sistema:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl enable restart-iptables.service
    Created symlink /etc/systemd/system/multi-user.target.wants/restart-iptables.service → /etc/systemd/system/restart-iptables.service.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Iniciamos el servicio:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl start restart-iptables.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;comprobación-12&quot;&gt;Comprobación:&lt;/h5&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@router-fw:~# reboot
root@router-fw:~# Connection to 172.22.200.145 closed by remote host.
    Connection to 172.22.200.145 closed.

moralg@padano:~$ ssh -A -p 2222 debian@172.22.200.145
    Linux router-fw 4.19.0-6-cloud-amd64 #1 SMP Debian 4.19.67-2+deb10u1 (2019-09-20)   x86_64

    The programs included with the Debian GNU/Linux system are free software;
    the exact distribution terms for each program are described in the
    individual files in /usr/share/doc/*/copyright.

    Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
    permitted by applicable law.
    Last login: Fri Jan  3 17:03:31 2020 from 172.23.0.54

debian@router-fw:~$ sudo iptables -n -L
    Chain INPUT (policy DROP)
    target     prot opt source               destination         
    ACCEPT     tcp  --  172.22.0.0/16        0.0.0.0/0            tcp dpt:22 state NEW, ESTABLISHED
    ACCEPT     tcp  --  172.23.0.0/16        0.0.0.0/0            tcp dpt:22 state NEW, ESTABLISHED
    ACCEPT     tcp  --  192.168.100.0/24     0.0.0.0/0            tcp spt:22 state  ESTABLISHED
    ACCEPT     tcp  --  192.168.200.0/24     0.0.0.0/0            tcp spt:22 state  ESTABLISHED
    ACCEPT     tcp  --  172.22.0.0/16        0.0.0.0/0            tcp dpt:2222 state NEW,   ESTABLISHED
    ACCEPT     tcp  --  172.23.0.0/16        0.0.0.0/0            tcp dpt:2222 state NEW,   ESTABLISHED
    ACCEPT     tcp  --  192.168.100.0/24     0.0.0.0/0            tcp dpt:22 state NEW, ESTABLISHED
    ACCEPT     tcp  --  192.168.0.0/16       0.0.0.0/0            tcp dpt:22 state NEW, ESTABLISHED
    ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           
    REJECT     icmp --  192.168.100.0/24     0.0.0.0/0            icmptype 8 reject-with    icmp-port-unreachable
    ACCEPT     icmp --  192.168.200.0/24     0.0.0.0/0            icmptype 8
    ACCEPT     icmp --  192.168.100.0/24     0.0.0.0/0            icmptype 0
    ACCEPT     icmp --  192.168.200.0/24     0.0.0.0/0            icmptype 0
    ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0            icmptype 0

    Chain FORWARD (policy DROP)
    target     prot opt source               destination         
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22 state NEW, ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp spt:22 state  ESTABLISHED
    ACCEPT     icmp --  192.168.200.0/24     0.0.0.0/0            icmptype 8
    ACCEPT     icmp --  0.0.0.0/0            192.168.200.0/24     icmptype 0
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22 state NEW, ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp spt:22 state  ESTABLISHED
    ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0            icmptype 8
    ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0            icmptype 0
    ACCEPT     udp  --  0.0.0.0/0            0.0.0.0/0            udp dpt:53 state NEW, ESTABLISHED
    ACCEPT     udp  --  0.0.0.0/0            0.0.0.0/0            udp spt:53 state  ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            multiport dports 80   state NEW,ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            multiport sports 80   state ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            multiport dports 443  state NEW,ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            multiport sports 443  state ESTABLISHED
    ACCEPT     udp  --  0.0.0.0/0            0.0.0.0/0            udp dpt:53 state NEW, ESTABLISHED
    ACCEPT     udp  --  0.0.0.0/0            0.0.0.0/0            udp spt:53 state  ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80 state NEW, ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp spt:80 state  ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:443 state NEW,    ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp spt:443 state     ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:25 state NEW, ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp spt:25 state  ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:3306 state NEW,   ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp spt:3306 state    ESTABLISHED

    Chain OUTPUT (policy DROP)
    target     prot opt source               destination         
    ACCEPT     tcp  --  0.0.0.0/0            172.22.0.0/16        tcp spt:22 state  ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            172.23.0.0/16        tcp spt:22 state  ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            192.168.100.0/24     tcp dpt:22 state NEW, ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            192.168.200.0/24     tcp dpt:22 state NEW, ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            172.22.0.0/16        tcp spt:2222 state    ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            172.23.0.0/16        tcp spt:2222 state    ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            192.168.100.0/24     tcp spt:22 state  ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            192.168.0.0/16       tcp spt:22 state  ESTABLISHED
    ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           
    ACCEPT     icmp --  0.0.0.0/0            192.168.100.0/24     icmptype 0
    ACCEPT     icmp --  0.0.0.0/0            192.168.100.0/24     state RELATED
    ACCEPT     icmp --  0.0.0.0/0            192.168.200.0/24     icmptype 0
    ACCEPT     icmp --  0.0.0.0/0            192.168.100.0/24     icmptype 8
    ACCEPT     icmp --  0.0.0.0/0            192.168.200.0/24     icmptype 8
    ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0            icmptype 8
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;mejora-2-utiliza-nuevas-cadenas-para-clasificar-el-tráfico&quot;&gt;MEJORA 2: Utiliza nuevas cadenas para clasificar el tráfico.&lt;/h4&gt;

&lt;blockquote&gt;
  &lt;h3 id=&quot;próximamente-2&quot;&gt;Próximamente.&lt;/h3&gt;
&lt;/blockquote&gt;

&lt;h4 id=&quot;mejora-3-consruye-el-cortafuego-utilizando-nftables&quot;&gt;MEJORA 3: Consruye el cortafuego utilizando nftables.&lt;/h4&gt;

&lt;p&gt;Sustituyendo en cada regla &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;iptables&lt;/code&gt; por &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;iptables-translate&lt;/code&gt; nos saldrá por pantalla la regla traduccida a nftables, pero con algunos errores.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;debian@router-fw:~$ sudo iptables-translate -A FORWARD -i eth1 -o eth0 -p tcp -m multiport --dports 443 -m state --state NEW,ESTABLISHED -j ACCEPT
    nft add rule ip filter FORWARD iifname &quot;eth1&quot; oifname &quot;eth0&quot; ip protocol tcp tcp dport 443 ct state new,established  counter accept
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Como vemos en la regla de nftables que nos devuelve, encontramos los siguientes fallos:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;ip: En nftables sería inet&lt;/li&gt;
  &lt;li&gt;FORWARD: En nftables tendría que ser forward en minúsculas&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Para solucionar estos fallos creamos el siguiente &lt;a href=&quot;https://github.com/MoralG/Cortafuego_Perimetral_con_DMZ/blob/master/Translate-iptables.sh&quot;&gt;SCRIPT&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/sh&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;sudo rm&lt;/span&gt; /home/debian/fichero1 2&amp;gt; /dev/null
&lt;span class=&quot;nb&quot;&gt;sudo rm&lt;/span&gt; /home/debian/fichero2 2&amp;gt; /dev/null
&lt;span class=&quot;nb&quot;&gt;sudo rm&lt;/span&gt; /home/debian/fichero3 2&amp;gt; /dev/null

&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;iptables &lt;span class=&quot;nt&quot;&gt;-S&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /home/debian/fichero1
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-S&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; /home/debian/fichero1

&lt;span class=&quot;k&quot;&gt;while &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;read &lt;/span&gt;linea 
&lt;span class=&quot;k&quot;&gt;do
    &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;iptables-translate &lt;span class=&quot;nv&quot;&gt;$linea&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; /home/debian/fichero2
&lt;span class=&quot;k&quot;&gt;done&lt;/span&gt; &amp;lt; fichero1

&lt;span class=&quot;nb&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'s/ ip /inet/g'&lt;/span&gt; /home/debian/fichero2 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /home/debian/fichero3
&lt;span class=&quot;nb&quot;&gt;tr &lt;/span&gt;A-Z a-z &amp;lt; /home/debian/fichero3 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /home/debian/nftables.txt 

&lt;span class=&quot;nb&quot;&gt;sudo rm&lt;/span&gt; /home/debian/fichero1 2&amp;gt; /dev/null
&lt;span class=&quot;nb&quot;&gt;sudo rm&lt;/span&gt; /home/debian/fichero2 2&amp;gt; /dev/null
&lt;span class=&quot;nb&quot;&gt;sudo rm&lt;/span&gt; /home/debian/fichero3 2&amp;gt; /dev/null
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ejecutamos el script:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bash Translate-iptables.sh 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Nos crea un fichero con la reglas de nftables corregidas.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cat nftables.txt 
    nft add rule inet filter input inet saddr 172.22.0.0/16 tcp dport 22 ct state new,established  counter accept
    nft add rule inet filter input inet saddr 172.23.0.0/16 tcp dport 22 ct state new,established  counter accept
    nft add rule inet filter input iifname &quot;eth1&quot; inet saddr 192.168.100.0/24 tcp sport 22 ct state established  counter accept
    nft add rule inet filter input iifname &quot;eth2&quot; inet saddr 192.168.200.0/24 tcp sport 22 ct state established  counter accept
    nft add rule inet filter input inet saddr 172.22.0.0/16 tcp dport 2222 ct state new,established  counter accept
    nft add rule inet filter input inet saddr 172.23.0.0/16 tcp dport 2222 ct state new,established  counter accept
    nft add rule inet filter input inet saddr 192.168.100.0/24 tcp dport 22 ct state new,established  counter accept
    nft add rule inet filter input inet saddr 192.168.0.0/16 tcp dport 22 ct state new,established  counter accept
    nft add rule inet filter input iifname &quot;lo&quot; inet protocol icmp counter accept
    nft add rule inet filter input iifname &quot;eth1&quot; inet saddr 192.168.100.0/24 icmp type echo-request counter reject
    nft add rule inet filter input iifname &quot;eth2&quot; inet saddr 192.168.200.0/24 icmp type echo-request counter accept
    nft add rule inet filter input iifname &quot;eth1&quot; inet saddr 192.168.100.0/24 icmp type echo-reply counter accept
    nft add rule inet filter input iifname &quot;eth2&quot; inet saddr 192.168.200.0/24 icmp type echo-reply counter accept
    nft add rule inet filter input iifname &quot;eth0&quot; icmp type echo-reply counter accept
    nft add rule inet filter forward iifname &quot;eth2&quot; oifname &quot;eth1&quot; tcp dport 22 ct state new,established  counter accept
    nft add rule inet filter forward iifname &quot;eth1&quot; oifname &quot;eth2&quot; tcp sport 22 ct state established  counter accept
    nft add rule inet filter forward iifname &quot;eth2&quot; oifname &quot;eth1&quot; inet saddr 192.168.200.0/24 icmp type echo-request counter accept
    nft add rule inet filter forward iifname &quot;eth1&quot; oifname &quot;eth2&quot; inet daddr 192.168.200.0/24 icmp type echo-reply counter accept
    nft add rule inet filter forward iifname &quot;eth1&quot; oifname &quot;eth2&quot; tcp dport 22 ct state new,established  counter accept
    nft add rule inet filter forward iifname &quot;eth2&quot; oifname &quot;eth1&quot; tcp sport 22 ct state established  counter accept
    nft add rule inet filter forward iifname &quot;eth1&quot; oifname &quot;eth0&quot; icmp type echo-request counter accept
    nft add rule inet filter forward iifname &quot;eth0&quot; oifname &quot;eth1&quot; icmp type echo-reply counter accept
    nft add rule inet filter forward iifname &quot;eth1&quot; oifname &quot;eth0&quot; udp dport 53 ct state new,established  counter accept
    nft add rule inet filter forward iifname &quot;eth0&quot; oifname &quot;eth1&quot; udp sport 53 ct state established  counter accept
    nft add rule inet filter forward iifname &quot;eth1&quot; oifname &quot;eth0&quot; inet protocol tcp tcp dport 80 ct state new,established  counter accept
    nft add rule inet filter forward iifname &quot;eth0&quot; oifname &quot;eth1&quot; inet protocol tcp tcp sport 80 ct state established  counter accept
    nft add rule inet filter forward iifname &quot;eth1&quot; oifname &quot;eth0&quot; inet protocol tcp tcp dport 443 ct state new,established  counter accept
    nft add rule inet filter forward iifname &quot;eth0&quot; oifname &quot;eth1&quot; inet protocol tcp tcp sport 443 ct state established  counter accept
    nft add rule inet filter forward iifname &quot;eth2&quot; oifname &quot;eth0&quot; udp dport 53 ct state new,established  counter accept
    nft add rule inet filter forward iifname &quot;eth0&quot; oifname &quot;eth2&quot; udp sport 53 ct state established  counter accept
    nft add rule inet filter forward iifname &quot;eth2&quot; oifname &quot;eth0&quot; tcp dport 80 ct state new,established  counter accept
    nft add rule inet filter forward iifname &quot;eth0&quot; oifname &quot;eth2&quot; tcp sport 80 ct state established  counter accept
    nft add rule inet filter forward iifname &quot;eth2&quot; oifname &quot;eth0&quot; tcp dport 443 ct state new,established  counter accept
    nft add rule inet filter forward iifname &quot;eth0&quot; oifname &quot;eth2&quot; tcp sport 443 ct state established  counter accept
    nft add rule inet filter forward iifname &quot;eth1&quot; oifname &quot;eth2&quot; tcp dport 25 ct state new,established  counter accept
    nft add rule inet filter forward iifname &quot;eth2&quot; oifname &quot;eth1&quot; tcp sport 25 ct state established  counter accept
    nft add rule inet filter forward iifname &quot;eth2&quot; oifname &quot;eth1&quot; tcp dport 3306 ct state new,established  counter accept
    nft add rule inet filter forward iifname &quot;eth1&quot; oifname &quot;eth2&quot; tcp sport 3306 ct state established  counter accept
    nft add rule inet filter output inet daddr 172.22.0.0/16 tcp sport 22 ct state established  counter accept
    nft add rule inet filter output inet daddr 172.23.0.0/16 tcp sport 22 ct state established  counter accept
    nft add rule inet filter output oifname &quot;eth1&quot; inet daddr 192.168.100.0/24 tcp dport 22 ct state new,established  counter accept
    nft add rule inet filter output oifname &quot;eth2&quot; inet daddr 192.168.200.0/24 tcp dport 22 ct state new,established  counter accept
    nft add rule inet filter output inet daddr 172.22.0.0/16 tcp sport 2222 ct state established  counter accept
    nft add rule inet filter output inet daddr 172.23.0.0/16 tcp sport 2222 ct state established  counter accept
    nft add rule inet filter output inet daddr 192.168.100.0/24 tcp sport 22 ct state established  counter accept
    nft add rule inet filter output inet daddr 192.168.0.0/16 tcp sport 22 ct state established  counter accept
    nft add rule inet filter output oifname &quot;lo&quot; inet protocol icmp counter accept
    nft add rule inet filter output oifname &quot;eth1&quot; inet daddr 192.168.100.0/24 icmp type echo-reply counter accept
    nft add rule inet filter output oifname &quot;eth1&quot; inet protocol icmp inet daddr 192.168.100.0/24 ct state related  counter accept
    nft add rule inet filter output oifname &quot;eth2&quot; inet daddr 192.168.200.0/24 icmp type echo-reply counter accept
    nft add rule inet filter output oifname &quot;eth1&quot; inet daddr 192.168.100.0/24 icmp type echo-request counter accept
    nft add rule inet filter output oifname &quot;eth2&quot; inet daddr 192.168.200.0/24 icmp type echo-request counter accept
    nft add rule inet filter output oifname &quot;eth0&quot; icmp type echo-request counter accept
    nft add rule inet filter prerouting inet saddr 172.23.0.0/16 tcp dport 22 counter dnat to 127.0.0.1
    nft add rule inet filter prerouting inet saddr 172.22.0.0/16 tcp dport 22 counter dnat to 127.0.0.1
    nft add rule inet filter prerouting inet saddr 172.23.0.0/16 tcp dport 2222 counter redirect to :22
    nft add rule inet filter prerouting inet saddr 172.22.0.0/16 tcp dport 2222 counter redirect to :22
    nft add rule inet filter postrouting oifname &quot;eth0&quot; inet saddr 192.168.100.0/24 counter masquerade 
    nft add rule inet filter postrouting oifname &quot;eth0&quot; inet saddr 192.168.200.0/24 counter masquerade 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>DavidDarnes</name></author><category term="Seguridad" /><summary type="html">Trabajamos mejorando un cortafuego perimetral tradicional, para que sea mas seguro y añadiendo un equipo que haga de DMZ.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/Portada1.png/assets/default-social-image.png" /><media:content medium="image" url="/assets/Portada1.png/assets/default-social-image.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Interconexión entre Bases de Datos</title><link href="/assets/Portada1.png/base%20de%20datos/2019/12/27/Interconexion_de_Servidores_de_BBDD/" rel="alternate" type="text/html" title="Interconexión entre Bases de Datos" /><published>2019-12-27T00:00:00+00:00</published><updated>2019-12-27T00:00:00+00:00</updated><id>/assets/Portada1.png/base%20de%20datos/2019/12/27/Interconexion_de_Servidores_de_BBDD</id><content type="html" xml:base="/assets/Portada1.png/base%20de%20datos/2019/12/27/Interconexion_de_Servidores_de_BBDD/">&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Interconexion_de_Servidores_de_BBDD/blob/master/image/Inter.jpg?raw=true&quot; alt=&quot;iSCSI&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Las interconexiones de servidores de bases de datos trata de acceder a datos que no están almacenados en nuestra base de datos, pudiendo combinarlos con los que ya tenemos.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Las interconexiones de servidores de bases de datos son operaciones que pueden ser muy útiles en diferentes contextos. Básicamente, se trata de acceder a datos que no están almacenados en nuestra base de datos, pudiendo combinarlos con los que ya tenemos.&lt;/p&gt;

&lt;p&gt;En esta práctica veremos varias formas de crear un enlace entre distintos servidores de bases de datos.&lt;/p&gt;

&lt;p&gt;Los servidores enlazados siempre tendrán que estar instalados en máquinas diferentes.&lt;/p&gt;

&lt;h2 id=&quot;1-enlace-oracle---oracle&quot;&gt;1. Enlace ORACLE - ORACLE&lt;/h2&gt;

&lt;p&gt;Realizar un enlace entre dos servidores de bases de datos ORACLE, explicando la configuración necesaria en ambos extremos y demostrando su funcionamiento.&lt;/p&gt;

&lt;p&gt;Para enlazar un Cliente Oracle con dirección &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;172.22.44.76/16&lt;/code&gt; a un Servidor Oracle con dirección &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;172.22.7.59/16&lt;/code&gt;, tenemos que realizar unas configuraciones en cada una de las partes para que realice el enlace. Estas configuraciones se explicarán a continuación:&lt;/p&gt;

&lt;h5 id=&quot;configuración-servidor-oracle&quot;&gt;Configuración Servidor Oracle&lt;/h5&gt;

&lt;p&gt;En el Servidor 2 tendremos que crear un usuario con los privilegios que deseemos, ya que accedemos a través de dicho usuario, desde el cliente, a la base de datos. En este caso utilizaremos el usuario &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;paloma&lt;/code&gt; que tiene privilegios para ver sus tablas creadas.&lt;/p&gt;

&lt;p&gt;Configuramos el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/oracle/product/12.2.0.1/dbhome_1/network/admin/listener.ora&lt;/code&gt; para escuchar en una determinada dirección y un determinado puerto.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# listener.ora Network Configuration File: /opt/oracle/product/12.2.0.1/dbhome_1/network/admin/listener.$
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =
 (SID_LIST =
  (SID_DESC =
   (GLOBAL_DBNAME = orcl)
   (ORACLE_HOME = /opt/oracle/product/12.2.0.1/dbhome_1)
   (SID_NAME = orcl)
  )
 )

LISTENER=
 (DESCRIPTION_LIST =
  (DESCRIPTION =
   (ADDRESS_LIST =
    (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
   )
   (ADDRESS_LIST =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 172.22.44.76)(PORT = 1521))
   )
  )
 )
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LISTENER&lt;/code&gt;: Donde especificamos las direcciones y puertos desde donde se pueden conectar remotamente a nuestro servidor.&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SID_LIST_LISTENER&lt;/code&gt;: Donde se indican los nombres de los servicios.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h5 id=&quot;configuración-cliente-oracle&quot;&gt;Configuración Cliente Oracle&lt;/h5&gt;

&lt;p&gt;Vamos a modificar el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/oracle/product/12.2.0.1/dbhome_1/network/admin/tnsnames.ora&lt;/code&gt;.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;Si no esta en la dirección indicada, tendremos que crearlo nosostros.&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo nano /opt/oracle/product/12.2.0.1/dbhome_1/network/admin/tnsnames.ora
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Añadimos las siguientes lineas en dicho fichero con las caracteristicas que hacen referencia al Servidor Oracle al que nos vamos a enlazar y añadimos la información refente a nuestro servidor si no teniamos el fichero creado.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;LISTENER_ORCL =
 (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1521))

ORCL =
 (DESCRIPTION = Mi Servidor Oracle
    (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1521))
    (CONNECT_DATA =
        (SERVER = DEDICATED)
        (SERVICE_NAME = orcl)
    )
 )

OraclePaloma =
 (DESCRIPTION = Servidor Oracle de Paloma
    (ADDRESS = (PROTOCOL = TCP)(HOST = 172.22.7.59)(PORT = 1521))
    (CONNECT_DATA =
        (SERVER = DEDICATED)
        (SERVICE_NAME = orcl)
    )
 )
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ADDRESS&lt;/code&gt;: Especificamos el protocolo, la dirección y el puerto de la máquina que queremos conectarnos.&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SERVER = DEDICATED&lt;/code&gt;: Para crear un proceso del servidor para atender solo a la conexión indicada&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SERVICE_NAME&lt;/code&gt;: Especificamos el nombre del sevicio de la máquina que queremos conectarnos. Este se especifica en el parámetro &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CONNECT_DATA&lt;/code&gt;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;blockquote&gt;
    &lt;p&gt;Ahora tenemos que reiniciar el servicio para que se apliquen los cambios:&lt;/p&gt;
  &lt;/blockquote&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;lsnrctl stop
lsnrctl start
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;blockquote&gt;
    &lt;p&gt;Nos devuelve el siguiente mensaje al reiniciar el listener:&lt;/p&gt;
  &lt;/blockquote&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;El servicio &quot;orcl&quot; tiene 1 instancia(s).
  La instancia &quot;orcl&quot;, con estado UNKNOWN, tiene 1 manejador(es) para este servicio...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Asignamos privilegios al usuario &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;moralg&lt;/code&gt; de nuestra base de datos, para que pueda crear el enlace.&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;GRANT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DATABASE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LINK&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;moralg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ya solo queda crear un enlace en nuestro Servidor Oracle para que pueda enlazarse al Servidor Oracle 2. Para crear el link se realiza de la siguiente forma:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DATABASE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LINK&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ConexionPaloma&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;CONNECT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TO&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;paloma&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;IDENTIFIED&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;paloma&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;USING&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'orcl'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;Indicamos el nombre del link &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ConexionPaloma&lt;/code&gt; para que se conecte al usuario &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;paloma&lt;/code&gt;, con la contraseña &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;paloma&lt;/code&gt; usando el nombre del servicio &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;orcl&lt;/code&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;Comprobamos el enlace, realizando un &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SELECT&lt;/code&gt; a una de la tablas de paloma y combinandola con una de moralg:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Interconexion_de_Servidores_de_BBDD/blob/master/image/PruebaOra_Ora.png?raw=true&quot; alt=&quot;PruebaOra_Ora&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;La consulta nos muestra el campo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DESCRPCION&lt;/code&gt; de la tabla &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ASPECTOS&lt;/code&gt; al hacer la conexión por el enlace &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ConexionPaloma&lt;/code&gt; combinando con el campo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NOMBREEQUIPOS&lt;/code&gt; de la tabla &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;PALMARES&lt;/code&gt;.&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;2-enlace-postgres---postgres&quot;&gt;2. Enlace POSTGRES - POSTGRES&lt;/h2&gt;

&lt;p&gt;Realizar un enlace entre dos servidores de bases de datos Postgres, explicando la configuración necesaria en ambos extremos y demostrando su funcionamiento.&lt;/p&gt;

&lt;p&gt;Vamos a realizar un enlace entre un Servidor de Postgres con la dirección &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;192.168.43.141/24&lt;/code&gt; y un Cliente de Postgres con la dirección &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;192.168.43.66/24&lt;/code&gt;&lt;/p&gt;

&lt;h5 id=&quot;configuración-del-servidor-postgres&quot;&gt;Configuración del Servidor Postgres&lt;/h5&gt;

&lt;p&gt;Modificamos el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/postgresql/11/main/postgresql.conf&lt;/code&gt;, descomentando una línea y añadiendo la dirección del cliente que quiere crear el enlace para que pueda escucharlo.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;listen_addresses = '192.168.43.66, localhost'
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reiniciamos el servicio del servidor:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl restart postgresql.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;configuración-del-cliente-postgres&quot;&gt;Configuración del Cliente Postgres&lt;/h5&gt;

&lt;p&gt;Vamos a intalar el paquete &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;postgresql-contrib&lt;/code&gt; para poder utilizar los módulos con &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CREATE EXTENSION&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt install postgresql-contrib
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora vamos a añadir un nuevo registro de autentificación en el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/postgresql/11/main/pg_hba.conf&lt;/code&gt; indicandole la dirección del servidor y el tipo de autentificación &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;md5&lt;/code&gt; para todas las base de datos y usuarios.&lt;/p&gt;

&lt;p&gt;La linea que hay que añadir es:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# TYPE  DATABASE        USER            ADDRESS                 METHOD

host    all             all             192.168.43.66/24        md5
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reiniciamos el servicio del cliente:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl restart postgresql.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Para crear el enlace vamos a utilizar el módulo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dblink&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EXTENSION&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dblink&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EXTENSION&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;Solo los usuarios con superusuarios pueden crear extensiones. Este privilegio se asigna de con &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ALTER ROLE &amp;lt;name_role&amp;gt; WITH superuser;&lt;/code&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;Ahora podemos realizar una consulta a una base de datos del Servidor de Postgres con lo siguiente:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Interconexion_de_Servidores_de_BBDD/blob/master/image/PruebaPost_Post.png?raw=true&quot; alt=&quot;PruebaPost_Post&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dblink&lt;/code&gt;: Tenemos que indicarle, para realizar el enlace, varios parámetros:&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dbname&lt;/code&gt;: Nombre de la base de datos del servidor.&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;host&lt;/code&gt;: Direción del servidor.&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;user&lt;/code&gt;: Usuario con el cual nos queremos conectar al servidor.&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;select .....&lt;/code&gt;: Indicar una consulta.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;Además tenemos que indicar el tipo da datos de las columnas, ya que es obligatorio.&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;Podemos utilizar &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dblink_connect&lt;/code&gt; y le indicamos los parámetros del servidor para realizar una conexión persistente con el servidor y no tener que indicar más, durante la sesión, dichos parámetros.&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dblink_connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'ConexionPaloma'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'dbname=restaurante host=172.22.3.28 user=paloma password=paloma'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ConexionPaloma&lt;/code&gt;: Nombre que se le asigna a la conexión persistente.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Ahora realizamos una consulta con lo indicado anteriormente:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Interconexion_de_Servidores_de_BBDD/blob/master/image/PruebaPost_Post1.png?raw=true&quot; alt=&quot;PruebaPost_Post&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;3-enlace-oracle---postgres&quot;&gt;3. Enlace ORACLE - POSTGRES&lt;/h2&gt;

&lt;p&gt;Realizar un enlace entre un cliente ORACLE y un servidor Postgres, empleando Heterogeneus Services, explicando la configuración necesaria en ambos extremos y demostrando su funcionamiento.&lt;/p&gt;

&lt;h3 id=&quot;31-enlace-de-cliente-oracle-a-servidor-postgres&quot;&gt;3.1 Enlace de Cliente Oracle a Servidor Postgres&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;Tenemos que configurar un enlace utilizando el driver &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ODBC&lt;/code&gt; (Open DataBase Connector) que es un estandar para el acceso a los datos de cualquier gestor de base de datos.&lt;/p&gt;

&lt;h5 id=&quot;configuración-el-servidor-postgres&quot;&gt;Configuración el Servidor Postgres&lt;/h5&gt;

&lt;p&gt;Modificamos el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/postgresql/11/main/postgresql.conf&lt;/code&gt;, descomentando una línea y añadiendo la dirección del cliente que quiere crear el enlace para que pueda escucharlo.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;listen_addresses = '192.168.43.66, localhost'
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora vamos a añadir un nuevo registro de autentificación en el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/postgresql/11/main/pg_hba.conf&lt;/code&gt; indicandole la dirección del cliente y el tipo de autentificación &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;md5&lt;/code&gt; para todas las base de datos y usuarios.&lt;/p&gt;

&lt;p&gt;La linea que hay que añadir es:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# TYPE  DATABASE        USER            ADDRESS                 METHOD

host    all             all             192.168.43.66/24        md5
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reiniciamos el servicio del servidor:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo systemctl restart postgresql.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;configuración-del-cliente-oracle&quot;&gt;Configuración del Cliente Oracle&lt;/h5&gt;

&lt;p&gt;Instalamos el driver &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ODBC&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt install odbc-postgresql unixodbc
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Se nos creará por defecto, al instalar los paquetes anteriores, el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/odbcinst.ini&lt;/code&gt; donde se indicará los drivers de ODBC que vamos a utilizar.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[PostgreSQL ANSI]
Description=PostgreSQL ODBC driver (ANSI version)
Driver=psqlodbca.so
Setup=libodbcpsqlS.so
Debug=0
CommLog=1
UsageCount=1

[PostgreSQL Unicode]
Description=PostgreSQL ODBC driver (Unicode version)
Driver=psqlodbcw.so
Setup=libodbcpsqlS.so
Debug=0
CommLog=1
UsageCount=1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora tenemos que añadir al fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/odbc.ini&lt;/code&gt; los parametros de conexión del Servidor de Postgres.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[PSQLA]
Debug = 0
CommLog = 0
ReadOnly = 1
Driver = PostgreSQL ANSI
Servername = 192.168.43.66
Username = paloma
Password = paloma
Port = 5432
Database = restaurante
Trace = 0
TraceFile = /tmp/sql.log

[PSQLU]
Debug = 0
CommLog = 0
ReadOnly = 0
Driver = PostgreSQL Unicode
Servername = 192.168.43.66
Username = paloma
Password = paloma
Port = 5432
Database = restaurante
Trace = 0
TraceFile = /tmp/sql.log

[Default]
Driver = /usr/lib/x86_64-linux-gnu/odbc/liboplodbcS.so
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Driver&lt;/code&gt;: Indicamos el driver, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;PostgreSQL ANSI&lt;/code&gt; y &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;PostgreSQL Unicode&lt;/code&gt;, que hemos añadido al fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/odbcinst.ini&lt;/code&gt;.&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Servername&lt;/code&gt;: Dirección del Servidor de Postgres.&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Username&lt;/code&gt;: Nombre del usuario que vamos a utilixar para realizar la conexión al servidor.&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Password&lt;/code&gt;: Contraseña del usuario &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;paloma&lt;/code&gt;.&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Port&lt;/code&gt;: Puerto del Servidor de Postgres.&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Database&lt;/code&gt;: Base de datos a la que vamos a conectarnos.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Podemos comprobar la configuración de los drivers y la configuración de la conexión de dichos drivers:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;odbcinst -q -d
    [PostgreSQL ANSI]
    [PostgreSQL Unicode]


odbcinst -q -s
    [PSQLA]
    [PSQLU]
    [Default]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Comprobamos una conexión al Servidor de Postgres:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@servidororacle:/home/oracle# isql -v PSQLU
+---------------------------------------+
| Connected!                            |
|                                       |
| sql-statement                         |
| help [tablename]                      |
| quit                                  |
|                                       |
+---------------------------------------+
SQL&amp;gt; select * from aspectos;
+-------+---------------------------------------------------+------------+
| codigo| descripcion                                       | importancia|
+-------+---------------------------------------------------+------------+
| COL   | Color                                             | Baja       |
| TEX   | Textura                                           | Alta       |
| VOL   | Volumen                                           | Media      |
| CAN   | Cantidad                                          | Alta       |
| PRE   | Presentacion                                      | Alta       |
| TEC   | Tecnica                                           | Media      |
| ORI   | Originalidad                                      | media      |
+-------+---------------------------------------------------+------------+
SQLRowCount returns 7
7 rows fetched
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora vamos a configurar el servicio de &lt;em&gt;Heterogeneus Services&lt;/em&gt;, para esto vamos a crear el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/oracle/product/12.2.0.1/dbhome_1/hs/admin/initPSQLU.ora&lt;/code&gt; y añadimos lo siguiente:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;HS_FDS_CONNECT_INFO = PSQLU
HS_FDS_TRACE_LEVEL = Debug
HS_FDS_SHAREABLE_NAME = /usr/lib/x86_64-linux-gnu/odbc/psqlodbcw.so
HS_LANGUAGE = AMERICAN_AMERICA.WE8ISO8859P1
set ODBCINI=/etc/odbc.ini
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;HS_FDS_CONNECT_INFO&lt;/code&gt;: Para indicar un nombre al servicio.&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;HS_FDS_TRACE_LEVEL&lt;/code&gt;: Para activar el servicio.&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;HS_FDS_SHAREABLE_NAME&lt;/code&gt;: Donde especificamos la dirección del driver configurado anteriormente&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;HS_LANGUAGE&lt;/code&gt;: Indicamos el idioma por defecto&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;set ODBCINI&lt;/code&gt;: Donde especificamos el fichero de configuración del driver para PSQL.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Configuramos el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/oracle/product/12.2.0.1/dbhome_1/network/admin/listener.ora&lt;/code&gt; para que pueda escuchar en el driver de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ODBC&lt;/code&gt;, añadiendo otra entrada al apartado de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SID_DESC&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;SID_LIST_LISTENER =
 (SID_LIST =
  (SID_DESC =
   (GLOBAL_DBNAME = orcl)
   (ORACLE_HOME = /opt/oracle/product/12.2.0.1/dbhome_1)
   (SID_NAME = orcl)
  )
  (SID_DESC =
    (SID_NAME = PSQLU)
    (PROGRAM = dg4odbc)
    (ORACLE_HOME = /opt/oracle/product/12.2.0.1/dbhome_1)
  )
 )
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SID_NAME&lt;/code&gt;: Le especificamos el nombre del servicio de ‘Heterogeneus Services’.&lt;/p&gt;

  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;PROGRAM&lt;/code&gt;: Le indicamos el programa por defecto.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Reiniciamos el servicio:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;lsnrctl stop
lsnrctl start
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Configuramos el fichero &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/oracle/product/12.2.0.1/dbhome_1/network/admin/tnsnames.ora&lt;/code&gt; creando un entrada para realizar la conexión al driver &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ODBC&lt;/code&gt;. Añadimos al fichero lo siguiente:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PSQLU =
 (DESCRIPTION=
 (ADDRESS=(PROTOCOL=tcp)(HOST=localhost)(PORT=1521))
   (CONNECT_DATA=(SID=PSQLU))
   (HS=OK)
 )
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;Le indicamos que &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SID=PSQLU&lt;/code&gt; ya que es el nombre que le hemos asignado anteriormente y &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;HS=OK&lt;/code&gt; para que utilice el servicio &lt;em&gt;Heterogeneus Services&lt;/em&gt;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Nos devuelve el siguiente mensaje al reiniciar el listener:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;El servicio &quot;PSQLU&quot; tiene 1 instancia(s).
  La instancia &quot;PSQLU&quot;, con estado UNKNOWN, tiene 1 manejador(es) para este servicio...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Asignamos privilegios al usuario &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;moralg&lt;/code&gt; de nuestra base de datos, para que pueda crear el enlace.&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;GRANT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;PUBLIC&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DATABASE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LINK&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;moralg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora solo nos queda crear el enlace con &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CREATE LINK&lt;/code&gt; y realizar la consulta.&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;PUBLIC&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DATABASE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LINK&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ConexionPalomaPSQLU&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;CONNECT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TO&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;&quot;paloma&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;IDENTIFIED&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;&quot;paloma&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;USING&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'PSQLU'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;Indicamos el nombre del link &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ConexionPalomaPSQLU&lt;/code&gt; para que se conecte al usuario &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;paloma&lt;/code&gt;, con la contraseña &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;paloma&lt;/code&gt; usando el nombre del servicio &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;PSQLU&lt;/code&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;Comprobamos el enlace, realizando un &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SELECT&lt;/code&gt; a una de la tablas de paloma:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;col&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nombreequipo&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;format&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a30&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;col&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;descripcion&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;format&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a30&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;Para que salga las columnas mas pequeñas y estéticas, utilizamos &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;col &amp;lt;nombre_campo&amp;gt; format a&amp;lt;tamaño&amp;gt;&lt;/code&gt;.&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Interconexion_de_Servidores_de_BBDD/blob/master/image/PruebaOra_Post.png?raw=true&quot; alt=&quot;PruebaOra_Post&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;32-enlace-de-cliente-postgres-a-servidor-oracle&quot;&gt;3.2 Enlace de Cliente Postgres a Servidor Oracle&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;Para realizar el enlace de Postgres a Oracle necesitamos el cliente de Oracle y descargamos la extensión para postgres &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;oracle_fdw&lt;/code&gt;.&lt;/p&gt;

&lt;h5 id=&quot;configuración-el-cliente-postgres&quot;&gt;Configuración el Cliente Postgres&lt;/h5&gt;

&lt;p&gt;Descargamos el cliente de oracle con &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wget&lt;/code&gt; desde la página oficial de oracle.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget https://download.oracle.com/otn_software/linux/instantclient/195000/oracle-instantclient19.5-basic-19.5.0.0.0-1.x86_64.rpm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Descargamos dependencias y paquetes necesarios.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget https://download.oracle.com/otn_software/linux/instantclient/195000/oracle-instantclient19.5-sqlplus-19.5.0.0.0-1.x86_64.rpm

wget https://download.oracle.com/otn_software/linux/instantclient/195000/oracle-instantclient19.5-tools-19.5.0.0.0-1.x86_64.rpm

wget https://download.oracle.com/otn_software/linux/instantclient/195000/oracle-instantclient19.5-devel-19.5.0.0.0-1.x86_64.rpm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;Solo con el cliente de Oracle valdría para realizar el enlace, pero durante el proceso de esta tarea, nos surgieron errores de falta de ficheros que se crean automaticamente con las dependencias indicadas anteriormentes.&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;Ya tenemos descargados los ficheros ahora tenemos que instalarlos, pero tenemos el problema que son &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.rpm&lt;/code&gt;.
Tenemos que utilizar el paquete de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;alien&lt;/code&gt; para pasarlos a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.deb&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Instalamos el paquete:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt install alien
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Convertimos los &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.rpm&lt;/code&gt; a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.deb&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo alien -d oracle-instantclient19.5-basic-19.5.0.0.0-1.x86_64.rpm
sudo alien -d oracle-instantclient19.5-sqlplus-19.5.0.0.0-1.x86_64.rpm
sudo alien -d oracle-instantclient19.5-tools-19.5.0.0.0-1.x86_64.rpm
sudo alien -d oracle-instantclient19.5-devel-19.5.0.0.0-1.x86_64.rpm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Instalamos los paquetes con &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dpkg -i&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo dpkg -i oracle-instantclient19.5-basic_19.5.0.0.0-2_amd64.deb
sudo dpkg -i oracle-instantclient19.5-sqlplus-19.5.0.0.0-1.x86_64.deb
sudo dpkg -i oracle-instantclient19.5-tools-19.5.0.0.0-1.x86_64.deb
sudo dpkg -i oracle-instantclient19.5-devel-19.5.0.0.0-1.x86_64.deb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora vamos a descargarnos e instalarnos la extensión para postgres &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;oracle_fdw&lt;/code&gt;.
Para descargadnos &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;oracle_fdw&lt;/code&gt; vamos a clonar un repositorio de Github.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://github.com/laurenz/oracle_fdw.git
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora tenemos que realizar la compilación de dicho paquete, para esto vamos a utlizar &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;make&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Puede que se produzcan varios fallos durante la compilación, os mostraré los fallos que me saltaron durante la realización de esta tarea.&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;FALLO 1&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vagrant@Postgres:~/oracle_fdw$ make
Makefile:20: /usr/lib/postgresql/11/lib/pgxs/src/makefiles/pgxs.mk: No such file or directory
make: *** No rule to make target '/usr/lib/postgresql/11/lib/pgxs/src/makefiles/pgxs.mk'.  Stop.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Este fallo se produce al no tener instalado el paquete &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;postgresql-server-dev-all&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vagrant@Postgres:~/oracle_fdw$ sudo apt install postgresql-server-dev-all
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;
&lt;p&gt;FALLO 2&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;oracle_utils.c:22:10: fatal error: oci.h: No such file or directory
 #include &amp;lt;oci.h&amp;gt;
          ^~~~~~~
compilation terminated.
make: *** [&amp;lt;builtin&amp;gt;: oracle_utils.o] Error 1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Este fallo se solucciona igualando las siguiente variables a las rutas correctas.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;export ORACLE_HOME=&quot;/usr/lib/oracle/19.5/client64&quot;
export LD_LIBRARY_PATH=&quot;/usr/lib/oracle/19.5/client64/lib&quot;
export PATH=$ORACLE_HOME:$PATH
export USE_PGXS=1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;
&lt;p&gt;FALLO 3&lt;/p&gt;

&lt;p&gt;Tenemos que modificar el &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Makefile&lt;/code&gt;, ya que la versión del cliente que nos hemos descargado es la &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;19.5&lt;/code&gt; y esta no esta incluida en el &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Makefile&lt;/code&gt;:&lt;/p&gt;

&lt;p&gt;Tenemos que añadir &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-I/usr/include/oracle/19.5/client64&lt;/code&gt; en la variable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;PG_CPPFLAGS&lt;/code&gt; y tenemos que añadir &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-L/usr/lib/oracle/19.5/client64/lib&lt;/code&gt; en la variable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SHLIB_LINK&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;MakeFile corregido para la versión 19.5&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MODULE_big = oracle_fdw
OBJS = oracle_fdw.o oracle_utils.o oracle_gis.o
EXTENSION = oracle_fdw
DATA = oracle_fdw--1.1.sql oracle_fdw--1.0--1.1.sql
DOCS = README.oracle_fdw
REGRESS = oracle_fdw oracle_gis oracle_import oracle_join

# add include and library paths for both Instant Client and regular Client
PG_CPPFLAGS = -I$(ORACLE_HOME)/sdk/include -I$(ORACLE_HOME)/oci/include -I$(ORACLE_HOME)/rdbms/public -I/usr/include/oracle/19.5/client64

SHLIB_LINK = -L$(ORACLE_HOME) -L$(ORACLE_HOME)/bin -L$(ORACLE_HOME)/lib -L$(ORACLE_HOME)/lib/amd64 -l$(ORACLE_SHLIB) -L/usr/lib/oracle/19.5/client64/lib

ifdef NO_PGXS
subdir = contrib/oracle_fdw
top_builddir = ../..
include $(top_builddir)/src/Makefile.global
include $(top_srcdir)/contrib/contrib-global.mk
else
PG_CONFIG = pg_config
PGXS := $(shell $(PG_CONFIG) --pgxs)
include $(PGXS)
endif

# Oracle's shared library is oci.dll on Windows and libclntsh elsewhere
ifeq ($(PORTNAME),win32)
ORACLE_SHLIB=oci
else
ifeq ($(PORTNAME),cygwin)
ORACLE_SHLIB=oci
else
ORACLE_SHLIB=clntsh
endif
endif
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;

&lt;p&gt;Ahora vamos a realizar la instalación, si todo ha salido bien en la compilación.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo make install
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Una vez instalado la extensión, vamos a crearla en la base de datos.&lt;/p&gt;

&lt;p&gt;Accedemos a la base de datos con el usuario &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;postgres&lt;/code&gt; y creamos la extensión con &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CREATE EXTENSION oracle_fdw&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;postgres@Postgres:/home/vagrant/oracle_fdw$ psql
psql (11.5 (Debian 11.5-1+deb10u1))
Type &quot;help&quot; for help.

postgres=# CREATE EXTENSION oracle_fdw;
ERROR:  could not load library &quot;/usr/lib/postgresql/11/lib/oracle_fdw.so&quot;: libaio.so.1: cannot open shared object file: No such file or directory
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;Nos salta un error al crear la extension. Esto se solucciona con la instalacción de dos librerías &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;libaio1&lt;/code&gt; y &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;libaio-dev&lt;/code&gt;.&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt-get install libaio1 libaio-dev
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Creamos la extensión:&lt;/p&gt;
&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EXTENSION&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;oracle_fdw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Creamos un nuevo servidor con la opciones del servidor de Oracle.&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SERVER&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ConexionOraclePaloma&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FOREIGN&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DATA&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WRAPPER&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;oracle_fdw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;OPTIONS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dbserver&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'//192.168.43.58:1521/ORCL'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CREATE SERVER&lt;/code&gt;: define un nuevo servidor externo. El usuario que define el servidor se convierte en su propietario.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Le asignamos el usuario &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;paloma&lt;/code&gt; con la contraseña &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;paloma&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;USER&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MAPPING&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;postgres&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SERVER&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ConexionOraclePaloma&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;OPTIONS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'paloma'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
                                                                      &lt;span class=&quot;n&quot;&gt;password&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'paloma'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ahora tenemos que crear una tabla externa que debería de ser igual a la tabla del servidor Oracle que queremos consultar.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;Podemos realizar, en el servidor Oracle, la consulta &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DESCRIBE &amp;lt;nombre_tabla&amp;gt;;&lt;/code&gt; para que nos muestre la información necesario para crear la &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FOREIGN TABLE&lt;/code&gt;.&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;Creamos la tabla externa:&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FOREIGN&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ASPECTOS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;codigo&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;varchar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
                              &lt;span class=&quot;n&quot;&gt;descripcion&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;varchar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
                              &lt;span class=&quot;n&quot;&gt;importancia&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;varchar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; 
&lt;span class=&quot;n&quot;&gt;SERVER&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ConexionOraclePaloma&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;OPTIONS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;schema&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'PALOMA'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
                                     &lt;span class=&quot;k&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'ASPECTOS'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;Hay que tener en cuenta que las opciones &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;schema&lt;/code&gt; y &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;table&lt;/code&gt; tienen que estar en mayúsculas, ya que oracle los guarda de este modo.&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;Ahora realizamos la consulta:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://github.com/MoralG/Interconexion_de_Servidores_de_BBDD/blob/master/image/PruebaPost_Ora.png?raw=true&quot; alt=&quot;PruebaPost_Ora&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;ul&gt;
    &lt;li&gt;Si queremos dar permisos a un usuario concreto de Postgres para que pueda realizar consultas a un servidor externo concreto utilizaremos &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GRANT USAGE ON FOREIGN SERVER &amp;lt;nombre_servidor&amp;gt; TO &amp;lt;nombre_usuario&amp;gt;;&lt;/code&gt;.&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;</content><author><name>DavidDarnes</name></author><category term="Base de Datos" /><summary type="html">Las interconexiones de servidores de bases de datos trata de acceder a datos que no están almacenados en nuestra base de datos, pudiendo combinarlos con los que ya tenemos.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/Portada1.png/assets/default-social-image.png" /><media:content medium="image" url="/assets/Portada1.png/assets/default-social-image.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>